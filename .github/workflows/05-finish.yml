name: 05 - Finish

on:
  workflow_call:
    inputs:
      project_name:
        description: "Project name that completed build"
        required: true
        type: string
      project_url:
        description: "Project URL"
        required: true
        type: string
      build_status:
        description: "Build status (success/failure)"
        required: true
        type: string
      build_artifacts:
        description: "Build artifacts info"
        required: false
        type: string
        default: ""
      error_message:
        description: "Error message if build failed"
        required: false
        type: string
        default: ""


jobs:
  finish:
    name: Finish Build Process
    runs-on: ubuntu-latest
    env:
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup finish environment
        run: |
          echo "Setting up finish environment for ${{ inputs.project_name }}"
          echo "Build status: ${{ inputs.build_status }}"
          echo "Project URL: ${{ inputs.project_url }}"
          
      - name: Get and decrypt build parameters
        run: |
          # åŠ è½½å…±äº«å·¥å…·å‡½æ•°
          source .github/workflows/shared/github-utils.sh
          
          # è·å–é˜Ÿåˆ—æ•°æ®
          QUEUE_MANAGER_ISSUE="1"
          QUEUE_MANAGER_CONTENT=$(get_queue_manager_content "$QUEUE_MANAGER_ISSUE")
          QUEUE_DATA=$(extract_queue_json "$QUEUE_MANAGER_CONTENT")
          
          if [ $? -ne 0 ]; then
            echo "âŒ Failed to get queue data"
            exit 1
          fi
          
          # è·å–å½“å‰æ„å»ºID
          CURRENT_BUILD_ID="${{ github.run_id }}"
          
          # ä»é˜Ÿåˆ—ä¸­æ‰¾åˆ°å½“å‰æ„å»ºé¡¹
          CURRENT_QUEUE_ITEM=$(echo "$QUEUE_DATA" | \
            jq -r --arg build_id "$CURRENT_BUILD_ID" \
            '.queue[] | select(.build_id == $build_id) // empty')
          
          if [ -z "$CURRENT_QUEUE_ITEM" ]; then
            echo "âŒ Current build not found in queue"
            exit 1
          fi
          
          # è·å–å½“å‰é˜Ÿåˆ—é¡¹çš„åŠ å¯†å‚æ•°
          ENCRYPTED_EMAIL=$(echo "$CURRENT_QUEUE_ITEM" | jq -r '.encrypted_email // empty')
          
          if [ -z "$ENCRYPTED_EMAIL" ]; then
            echo "âŒ No encrypted parameters found for current build"
            exit 1
          fi
          
          # è§£å¯†å‚æ•°
          EMAIL=$(decrypt_params "$ENCRYPTED_EMAIL")
          
          # è·å–å…¬å¼€å‚æ•°
          TAG=$(echo "$CURRENT_QUEUE_ITEM" | jq -r '.tag // empty')
          CUSTOMER=$(echo "$CURRENT_QUEUE_ITEM" | jq -r '.customer // empty')
          
          echo "ğŸ” Decrypted parameters for notification:"
          echo "TAG: $TAG"
          echo "EMAIL: $EMAIL"
          echo "CUSTOMER: $CUSTOMER"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "FINISH_TAG=$TAG" >> $GITHUB_ENV
          echo "FINISH_EMAIL=$EMAIL" >> $GITHUB_ENV
          echo "FINISH_CUSTOMER=$CUSTOMER" >> $GITHUB_ENV
          
      - name: Process build completion
        run: |
          echo "Processing build completion for ${{ inputs.project_name }}"
          
          if [ "${{ inputs.build_status }}" = "success" ]; then
            echo "âœ… Build completed successfully"
            echo "Build artifacts: ${{ inputs.build_artifacts }}"
          else
            echo "âŒ Build failed"
            echo "Error message: ${{ inputs.error_message }}"
          fi
          
      - name: Update queue status
        uses: ./.github/workflows/shared/github-utils
        with:
          action: update_queue_status
          project_name: ${{ inputs.project_name }}
          status: ${{ inputs.build_status }}

          
      - name: Send completion notification
        run: |
          echo "Sending completion notification for ${{ inputs.project_name }}"
          
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          
          if [ "${{ inputs.build_status }}" = "success" ]; then
            echo "## ğŸ‰ æ„å»ºå®Œæˆé€šçŸ¥" > notification.md
            echo "" >> notification.md
            echo "**é¡¹ç›®ï¼š** ${{ inputs.project_name }}" >> notification.md
            echo "**çŠ¶æ€ï¼š** âœ… æˆåŠŸ" >> notification.md
            echo "**å®Œæˆæ—¶é—´ï¼š** $timestamp" >> notification.md
            echo "**é¡¹ç›®é“¾æ¥ï¼š** ${{ inputs.project_url }}" >> notification.md
            echo "" >> notification.md
            echo "### æ„å»ºäº§ç‰©" >> notification.md
            echo "${{ inputs.build_artifacts }}" >> notification.md
            echo "" >> notification.md
            echo "---" >> notification.md
            echo "*æ­¤é€šçŸ¥ç”±æ„å»ºé˜Ÿåˆ—ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*" >> notification.md
          else
            echo "## âŒ æ„å»ºå¤±è´¥é€šçŸ¥" > notification.md
            echo "" >> notification.md
            echo "**é¡¹ç›®ï¼š** ${{ inputs.project_name }}" >> notification.md
            echo "**çŠ¶æ€ï¼š** âŒ å¤±è´¥" >> notification.md
            echo "**å¤±è´¥æ—¶é—´ï¼š** $timestamp" >> notification.md
            echo "**é¡¹ç›®é“¾æ¥ï¼š** ${{ inputs.project_url }}" >> notification.md
            echo "" >> notification.md
            echo "### é”™è¯¯ä¿¡æ¯" >> notification.md
            echo "${{ inputs.error_message }}" >> notification.md
            echo "" >> notification.md
            echo "---" >> notification.md
            echo "*æ­¤é€šçŸ¥ç”±æ„å»ºé˜Ÿåˆ—ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*" >> notification.md
          fi
          
          cat notification.md
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ å‘é€é€šçŸ¥çš„é€»è¾‘
          # ä¾‹å¦‚ï¼šå‘é€åˆ°Slackã€é’‰é’‰ã€é‚®ä»¶ç­‰
          
      - name: Cleanup temporary files
        run: |
          echo "Cleaning up temporary files..."
          rm -rf /tmp/build_*
          rm -rf /tmp/cache_*
          echo "Cleanup completed"
          
      - name: Final status update
        run: |
          echo "Final status update for ${{ inputs.project_name }}"
          echo "Build process finished with status: ${{ inputs.build_status }}"
          echo "Queue has been updated and lock released"
          echo "All cleanup tasks completed" 