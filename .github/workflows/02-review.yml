name: 02 - Review and Validation

on:
  workflow_call:
    inputs:
      trigger_output:
        description: "Trigger workflow output data"
        required: true
        type: string
    outputs:
      data:
        description: "Review output data"
        value: ${{ jobs.review.outputs.data }}
      build_approved:
        description: "Whether build was approved"
        value: ${{ jobs.review.outputs.build_approved }}

jobs:
  review:
    runs-on: ubuntu-latest
    outputs:
      data: ${{ steps.output.outputs.data || steps.output_rejected.outputs.data }}
      build_approved: ${{ steps.output.outputs.build_approved || steps.output_rejected.outputs.build_approved }}
    steps:
      - name: Setup review data
        id: setup
        run: |
          # ä½¿ç”¨è¾“å…¥å‚æ•°
          TRIGGER_OUTPUT='${{ inputs.trigger_output }}'
          
          if [ -z "$TRIGGER_OUTPUT" ]; then
            echo "âŒ No trigger output provided"
            exit 1
          fi
          
          echo "TRIGGER_OUTPUT=$TRIGGER_OUTPUT" >> $GITHUB_ENV
      
      - name: Extract data
        id: extract
        run: |
          # ä»Žtriggeré˜¶æ®µèŽ·å–æ•°æ®
          INPUT='${{ env.TRIGGER_OUTPUT }}'
          
          # è°ƒè¯•ï¼šè¾“å‡ºåŽŸå§‹æ•°æ®
          echo "Raw input data:"
          echo "$INPUT"
          
          # å¤„ç†åŒé‡è½¬ä¹‰çš„JSONå­—ç¬¦ä¸²
          # å¦‚æžœè¾“å…¥æ˜¯å­—ç¬¦ä¸²å½¢å¼çš„JSONï¼Œéœ€è¦å…ˆè§£æž
          if [[ "$INPUT" == \"*\" ]]; then
            echo "Detected string-wrapped JSON, parsing..."
            PARSED_INPUT=$(echo "$INPUT" | jq -r .)
            echo "Parsed input:"
            echo "$PARSED_INPUT"
          else
            PARSED_INPUT="$INPUT"
          fi
          
          # éªŒè¯JSONæ ¼å¼
          echo "Validating JSON format..."
          echo "$PARSED_INPUT" | jq . > /dev/null
          echo "JSON validation passed"
          
          # æå–æœåŠ¡å™¨åœ°å€
          RENDEZVOUS_SERVER=$(echo "$PARSED_INPUT" | jq -r '.rendezvous_server // empty')
          API_SERVER=$(echo "$PARSED_INPUT" | jq -r '.api_server // empty')
          EMAIL=$(echo "$PARSED_INPUT" | jq -r '.email // empty')
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "RENDEZVOUS_SERVER=$RENDEZVOUS_SERVER" >> $GITHUB_ENV
          echo "API_SERVER=$API_SERVER" >> $GITHUB_ENV
          echo "EMAIL=$EMAIL" >> $GITHUB_ENV
          echo "CURRENT_DATA=$PARSED_INPUT" >> $GITHUB_ENV
          
          # è°ƒè¯•è¾“å‡º
          echo "Extracted data:"
          echo "RENDEZVOUS_SERVER: $RENDEZVOUS_SERVER"
          echo "API_SERVER: $API_SERVER"
          echo "EMAIL: $EMAIL"
      
      - name: Auto reject invalid server parameters
        run: |
          # æ£€æŸ¥å½“å‰å·¥ä½œç›®å½•å’Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "Current working directory: $(pwd)"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "Checking if file exists:"
          ls -la $GITHUB_WORKSPACE/.github/workflows/shared/
          
          # åŠ è½½å…±äº«å·¥å…·å‡½æ•°
          source $GITHUB_WORKSPACE/.github/workflows/shared/github-utils.sh
          
          # æ£€æŸ¥å‚æ•°æ˜¯å¦ä¸ºç©º
          if [ -z "$RENDEZVOUS_SERVER" ] || [ -z "$API_SERVER" ] || [ -z "$EMAIL" ]; then
            echo "âŒ Missing required parameters"
            echo "RENDEZVOUS_SERVER: $RENDEZVOUS_SERVER"
            echo "API_SERVER: $API_SERVER"
            echo "EMAIL: $EMAIL"
            
            REJECT_COMMENT="## âŒ æž„å»ºè¢«è‡ªåŠ¨æ‹’ç»

            **æ‹’ç»åŽŸå› ï¼š** ç¼ºå°‘å¿…è¦çš„æœåŠ¡å™¨å‚æ•°
            - Rendezvous Server: $RENDEZVOUS_SERVER
            - API Server: $API_SERVER
            - Email: $EMAIL

            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            è¯·æ£€æŸ¥å‚æ•°åŽé‡æ–°æäº¤issueã€‚"
            
            echo "BUILD_REJECTED=true" >> $GITHUB_ENV
            echo "REJECT_REASON=Missing required parameters" >> $GITHUB_ENV
            exit 0
          fi
          
          # éªŒè¯æœåŠ¡å™¨å‚æ•°
          AUTO_REJECT_REASON=$(validate_server_parameters "$RENDEZVOUS_SERVER" "$API_SERVER" "$EMAIL")
          
          if [ $? -ne 0 ]; then
            echo "è‡ªåŠ¨æ‹’ç»åŽŸå› ï¼š$AUTO_REJECT_REASON"
            
            REJECT_COMMENT="## âŒ æž„å»ºè¢«è‡ªåŠ¨æ‹’ç»

            **æ‹’ç»åŽŸå› ï¼š**
            $AUTO_REJECT_REASON

            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            è¯·æ£€æŸ¥å‚æ•°åŽé‡æ–°æäº¤issueã€‚"
            
            # èŽ·å–åŽŸå§‹issueç¼–å·
            ORIGINAL_ISSUE_NUMBER=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs" | \
              jq -r '.jobs[0].steps[] | select(.name == "Setup framework") | .outputs.build_id // empty')
            
            if [ -n "$ORIGINAL_ISSUE_NUMBER" ]; then
              add_issue_comment "$ORIGINAL_ISSUE_NUMBER" "$REJECT_COMMENT"
            fi
            
            echo "BUILD_REJECTED=true" >> $GITHUB_ENV
            exit 0
          else
            echo "âœ… All parameter validations passed"
          fi

      - name: Determine review requirement
        if: env.BUILD_REJECTED != 'true'
        run: |
          # é»˜è®¤éœ€è¦å®¡æ ¸
          NEED_REVIEW=true

          # ä»“åº“æ‰€æœ‰è€…å…å®¡æ ¸
          if [ "${{ github.actor }}" = "${{ github.repository_owner }}" ]; then
            echo "Repo owner detected, skipping review."
            NEED_REVIEW=false
          fi

          # æ£€æŸ¥å½“å‰å·¥ä½œç›®å½•å’Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "Current working directory: $(pwd)"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "Checking if file exists:"
          ls -la $GITHUB_WORKSPACE/.github/workflows/shared/
          
          # åŠ è½½å…±äº«å·¥å…·å‡½æ•°
          source $GITHUB_WORKSPACE/.github/workflows/shared/github-utils.sh
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºç§æœ‰IPåœ°å€
          RENDEZVOUS_PRIVATE=false
          API_PRIVATE=false
          
          echo "Checking Rendezvous Server: $RENDEZVOUS_SERVER"
          if [ -n "$RENDEZVOUS_SERVER" ] && check_private_ip "$RENDEZVOUS_SERVER"; then
            RENDEZVOUS_PRIVATE=true
            echo "Rendezvous server is private IP: $RENDEZVOUS_SERVER"
          else
            echo "Rendezvous server is public IP or domain: $RENDEZVOUS_SERVER"
          fi
          
          echo "Checking API Server: $API_SERVER"
          if [ -n "$API_SERVER" ] && check_private_ip "$API_SERVER"; then
            API_PRIVATE=true
            echo "API server is private IP: $API_SERVER"
          else
            echo "API server is public IP or domain: $API_SERVER"
          fi
          
          # åˆ¤æ–­æ˜¯å¦éœ€è¦å®¡æ ¸
          if [ "$NEED_REVIEW" = "false" ]; then
            echo "Skipping review due to repo owner or private IP check."
          else
            if [ "$RENDEZVOUS_PRIVATE" = "true" ] && [ "$API_PRIVATE" = "true" ]; then
              NEED_REVIEW=false
              echo "Both servers are private IPs - no review needed"
            else
              NEED_REVIEW=true
              echo "At least one server is public IP - review required"
            fi
          fi
          
          # è®¾ç½®å®¡æ ¸æ ‡è®°åˆ°çŽ¯å¢ƒå˜é‡ï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "NEED_REVIEW=$NEED_REVIEW" >> $GITHUB_ENV
      
      - name: Handle review process
        if: env.NEED_REVIEW == 'true' && env.BUILD_REJECTED != 'true'
        run: |
          echo "Review required. Starting review process..."
          
          # èŽ·å–åŽŸå§‹issueç¼–å·
          ORIGINAL_ISSUE_NUMBER=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs" | \
            jq -r '.jobs[0].steps[] | select(.name == "Setup framework") | .outputs.build_id // empty')
          
          # åœ¨issueä¸­æ·»åŠ å®¡æ ¸çŠ¶æ€
          REVIEW_COMMENT="## ðŸ” å®¡æ ¸çŠ¶æ€

          **éœ€è¦å®¡æ ¸åŽŸå› ï¼š** æ£€æµ‹åˆ°å…¬ç½‘IPåœ°å€æˆ–åŸŸå
          - Rendezvous Server: $RENDEZVOUS_SERVER
          - API Server: $API_SERVER

          **å®¡æ ¸è¦æ±‚ï¼š** è¯·ç®¡ç†å‘˜å›žå¤ 'åŒæ„æž„å»º' æˆ– 'æ‹’ç»æž„å»º'

          **çŠ¶æ€ï¼š** ç­‰å¾…å®¡æ ¸ä¸­ â³
          **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')"
          
          # æ£€æŸ¥å½“å‰å·¥ä½œç›®å½•å’Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "Current working directory: $(pwd)"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "Checking if file exists:"
          ls -la $GITHUB_WORKSPACE/.github/workflows/shared/
          
          # åŠ è½½å…±äº«å·¥å…·å‡½æ•°
          source $GITHUB_WORKSPACE/.github/workflows/shared/github-utils.sh
          
          if [ -n "$ORIGINAL_ISSUE_NUMBER" ]; then
            add_issue_comment "$ORIGINAL_ISSUE_NUMBER" "$REVIEW_COMMENT"
          fi
          
          # å¾ªçŽ¯æ£€æŸ¥å®¡æ ¸å›žå¤
          START_TIME=$(date +%s)
          TIMEOUT=21600  # 6å°æ—¶è¶…æ—¶
          APPROVED=false
          REJECTED=false
          
          while [ $(($(date +%s) - START_TIME)) -lt $TIMEOUT ]; do
            echo "Checking for admin approval... ($(($(date +%s) - START_TIME))s elapsed)"
            
            # èŽ·å–issueçš„æœ€æ–°è¯„è®º
            COMMENTS=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ORIGINAL_ISSUE_NUMBER/comments")
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜å›žå¤
            # èŽ·å–ä»“åº“æ‰€æœ‰è€…å’Œç®¡ç†å‘˜åˆ—è¡¨
            REPO_OWNER="${{ github.repository_owner }}"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜å›žå¤ï¼ˆåŒ…æ‹¬ä»“åº“æ‰€æœ‰è€…ï¼‰
            if echo "$COMMENTS" | jq -e --arg owner "$REPO_OWNER" '.[] | select(.user.login == $owner or .user.login == "admin" or .user.login == "ç®¡ç†å‘˜ç”¨æˆ·å") | select(.body | contains("åŒæ„æž„å»º"))' > /dev/null; then
              APPROVED=true
              break
            fi
            
            if echo "$COMMENTS" | jq -e --arg owner "$REPO_OWNER" '.[] | select(.user.login == $owner or .user.login == "admin" or .user.login == "ç®¡ç†å‘˜ç”¨æˆ·å") | select(.body | contains("æ‹’ç»æž„å»º"))' > /dev/null; then
              REJECTED=true
              break
            fi
            
            # è°ƒè¯•ï¼šè¾“å‡ºæœ€æ–°çš„è¯„è®ºä¿¡æ¯
            echo "Latest comments:"
            echo "$COMMENTS" | jq -r '.[-3:] | .[] | "User: \(.user.login), Body: \(.body[0:100])..."'
            
            # ç­‰å¾…30ç§’åŽå†æ¬¡æ£€æŸ¥
            sleep 30
          done
          
          if [ "$APPROVED" = true ]; then
            echo "Admin approval received"
            # æ·»åŠ å®¡æ ¸é€šè¿‡è¯„è®º
            APPROVAL_COMMENT="## âœ… å®¡æ ¸é€šè¿‡
            **çŠ¶æ€ï¼š** å®¡æ ¸å·²é€šè¿‡
            **å®¡æ ¸äººï¼š** ç®¡ç†å‘˜
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            æž„å»ºå°†ç»§ç»­è¿›è¡Œ..."
            
            if [ -n "$ORIGINAL_ISSUE_NUMBER" ]; then
              add_issue_comment "$ORIGINAL_ISSUE_NUMBER" "$APPROVAL_COMMENT"
            fi
          elif [ "$REJECTED" = true ]; then
            echo "Build rejected by admin"
            
            # æ·»åŠ æ‹’ç»è¯„è®º
            REJECT_COMMENT="## âŒ æž„å»ºè¢«æ‹’ç»
            **çŠ¶æ€ï¼š** æž„å»ºå·²è¢«ç®¡ç†å‘˜æ‹’ç»
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            æž„å»ºæµç¨‹å·²ç»ˆæ­¢ã€‚å¦‚éœ€é‡æ–°æž„å»ºï¼Œè¯·é‡æ–°æäº¤issueã€‚"
            
            if [ -n "$ORIGINAL_ISSUE_NUMBER" ]; then
              add_issue_comment "$ORIGINAL_ISSUE_NUMBER" "$REJECT_COMMENT"
            fi
            
            echo "Build rejected by admin - setting build_approved to false"
            # è®¾ç½®æž„å»ºè¢«æ‹’ç»æ ‡å¿—
            echo "BUILD_REJECTED=true" >> $GITHUB_ENV
            exit 0
          else
            echo "Review timeout after 6 hours"
            # æ·»åŠ è¶…æ—¶è¯„è®º
            TIMEOUT_COMMENT="## â° å®¡æ ¸è¶…æ—¶
            **çŠ¶æ€ï¼š** å®¡æ ¸è¶…æ—¶ï¼ˆ6å°æ—¶ï¼‰
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            æž„å»ºå°†è‡ªåŠ¨ç»ˆæ­¢ã€‚å¦‚éœ€é‡æ–°æž„å»ºï¼Œè¯·é‡æ–°æäº¤issueã€‚"
            
            if [ -n "$ORIGINAL_ISSUE_NUMBER" ]; then
              add_issue_comment "$ORIGINAL_ISSUE_NUMBER" "$TIMEOUT_COMMENT"
            fi
            
            exit 1
          fi

      - name: Output data
        if: env.BUILD_REJECTED != 'true'
        id: output
        run: |
          # é‡æ–°èŽ·å–åŽŸå§‹æ•°æ®å¹¶ç¡®ä¿JSONæ ¼å¼æ­£ç¡®
          INPUT='${{ env.CURRENT_DATA }}'
          
          # ç¡®ä¿è¾“å‡ºçš„æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼
          echo "data=$INPUT" >> $GITHUB_OUTPUT
          
          # æ ¹æ®æ ‡å¿—è®¾ç½®æž„å»ºæ‰¹å‡†çŠ¶æ€
          if [ "${{ env.BUILD_REJECTED }}" = "true" ]; then
            echo "build_approved=false" >> $GITHUB_OUTPUT
            echo "Build was rejected by admin"
          elif [ "${{ env.BUILD_TIMEOUT }}" = "true" ]; then
            echo "build_approved=false" >> $GITHUB_OUTPUT
            echo "Build timed out during review"
          else
            echo "build_approved=true" >> $GITHUB_OUTPUT
            echo "Build was approved or no review needed"
          fi
          
          # æ˜¾ç¤ºè¾“å‡ºä¿¡æ¯
          echo "Review output: $INPUT"
          
          # éªŒè¯è¾“å‡ºçš„JSONæ ¼å¼
          echo "Validating output JSON format..."
          echo "$INPUT" | jq . > /dev/null
          echo "Output JSON validation passed"
      
      - name: Output data for rejected builds
        if: env.BUILD_REJECTED == 'true'
        id: output_rejected
        run: |
          # ä¸ºè¢«æ‹’ç»çš„æž„å»ºåˆ›å»ºè¾“å‡º
          echo "data={}" >> $GITHUB_OUTPUT
          echo "build_approved=false" >> $GITHUB_OUTPUT
          echo "Build was rejected - no data to pass forward" 