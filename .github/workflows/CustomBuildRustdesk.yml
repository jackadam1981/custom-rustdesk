name: Custom Build Rustdesk

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      tag:
        description: "æ ‡ç­¾åç§°"
        required: false
        default: "vCustom"
        type: string
      email:
        description: "é‚®ä»¶åœ°å€"
        required: false
        default: "rustdesk@example.com"
        type: string
      customer:
        description: "å®¢æˆ·åç§°"
        required: false
        default: "è‡ªç”±å·¥ä½œå®¤"
        type: string
      customer_link:
        description: "å®¢æˆ·é“¾æ¥"
        required: false
        default: "https://rustdesk.com"
        type: string
      super_password:
        description: "è¶…çº§å¯†ç "
        required: false
        default: "123456"
        type: string
      slogan:
        description: "æ ‡è¯­"
        required: false
        default: "å®‰å…¨å¯é çš„è¿œç¨‹æ¡Œé¢è§£å†³æ–¹æ¡ˆ"
        type: string
      rendezvous_server:
        description: "æœåŠ¡å™¨åœ°å€"
        required: false
        default: "1.2.3.4:21117"
        type: string
      rs_pub_key:
        description: "å…¬é’¥"
        required: false
        default: "xxxxx"
        type: string
      api_server:
        description: "APIæœåŠ¡å™¨åœ°å€"
        required: false
        default: "https://api.example.com"
        type: string

# æ·»åŠ æƒé™é…ç½®
permissions:
  issues: write
  contents: read

jobs:
  trigger: # è§¦å‘é˜¶æ®µ
    runs-on: ubuntu-latest
    outputs:
      trigger_output: ${{ toJson(steps.setup.outputs.data) }}
    steps:
      - name: Setup framework
        id: setup
        run: |
          echo "Preparing environment..."
          
          # åˆ¤æ–­è§¦å‘æ–¹å¼å¹¶æå–å‚æ•°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨workflow_dispatchè¾“å…¥å‚æ•°
            echo "Manual trigger detected"
            TAG="${{ github.event.inputs.tag }}"
            EMAIL="${{ github.event.inputs.email }}"
            CUSTOMER="${{ github.event.inputs.customer }}"
            CUSTOMER_LINK="${{ github.event.inputs.customer_link }}"
            SUPER_PASSWORD="${{ github.event.inputs.super_password }}"
            SLOGAN="${{ github.event.inputs.slogan }}"
            RENDEZVOUS_SERVER="${{ github.event.inputs.rendezvous_server }}"
            RS_PUB_KEY="${{ github.event.inputs.rs_pub_key }}"
            API_SERVER="${{ github.event.inputs.api_server }}"
          else
            # Issueè§¦å‘ï¼šä»issueå†…å®¹ä¸­æå–å‚æ•°
            echo "Issue trigger detected"
            ISSUE_BODY="${{ github.event.issue.body }}"
            
            # ä½¿ç”¨grepå’Œsedæå–å‚æ•°å€¼
            TAG=$(echo "$ISSUE_BODY" | grep -oP 'tag:\s*\K[^\r\n]+' | head -1 || echo "")
            EMAIL=$(echo "$ISSUE_BODY" | grep -oP 'email:\s*\K[^\r\n]+' | head -1 || echo "")
            CUSTOMER=$(echo "$ISSUE_BODY" | grep -oP 'customer:\s*\K[^\r\n]+' | head -1 || echo "")
            CUSTOMER_LINK=$(echo "$ISSUE_BODY" | grep -oP 'customer_link:\s*\K[^\r\n]+' | head -1 || echo "")
            SUPER_PASSWORD=$(echo "$ISSUE_BODY" | grep -oP 'super_password:\s*\K[^\r\n]+' | head -1 || echo "")
            SLOGAN=$(echo "$ISSUE_BODY" | grep -oP 'slogan:\s*\K[^\r\n]+' | head -1 || echo "")
            RENDEZVOUS_SERVER=$(echo "$ISSUE_BODY" | grep -oP 'rendezvous_server:\s*\K[^\r\n]+' | head -1 || echo "")
            RS_PUB_KEY=$(echo "$ISSUE_BODY" | grep -oP 'rs_pub_key:\s*\K[^\r\n]+' | head -1 || echo "")
            API_SERVER=$(echo "$ISSUE_BODY" | grep -oP 'api_server:\s*\K[^\r\n]+' | head -1 || echo "")
          fi
          
          # æ£€æŸ¥å…³é”®å‚æ•°æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨secretså…œåº•
          if [ -z "$RENDEZVOUS_SERVER" ] || [ -z "$RS_PUB_KEY" ]; then
            echo "Using secrets fallback for missing critical parameters"
            TAG="${TAG:-${{ secrets.DEFAULT_TAG }}}"
            EMAIL="${EMAIL:-${{ secrets.DEFAULT_EMAIL }}}"
            CUSTOMER="${CUSTOMER:-${{ secrets.DEFAULT_CUSTOMER }}}"
            CUSTOMER_LINK="${CUSTOMER_LINK:-${{ secrets.DEFAULT_CUSTOMER_LINK }}}"
            SUPER_PASSWORD="${SUPER_PASSWORD:-${{ secrets.DEFAULT_SUPER_PASSWORD }}}"
            SLOGAN="${SLOGAN:-${{ secrets.DEFAULT_SLOGAN }}}"
            RENDEZVOUS_SERVER="${RENDEZVOUS_SERVER:-${{ secrets.DEFAULT_RENDEZVOUS_SERVER }}}"
            RS_PUB_KEY="${RS_PUB_KEY:-${{ secrets.DEFAULT_RS_PUB_KEY }}}"
            API_SERVER="${API_SERVER:-${{ secrets.DEFAULT_API_SERVER }}}"
          fi
          
          # ç”Ÿæˆåˆå§‹JSONæ•°æ®
          DATA=$(jq -c -n \
            --arg tag "$TAG" \
            --arg email "$EMAIL" \
            --arg customer "$CUSTOMER" \
            --arg customer_link "$CUSTOMER_LINK" \
            --arg super_password "$SUPER_PASSWORD" \
            --arg slogan "$SLOGAN" \
            --arg rendezvous_server "$RENDEZVOUS_SERVER" \
            --arg rs_pub_key "$RS_PUB_KEY" \
            --arg api_server "$API_SERVER" \
            '{tag: $tag, email: $email, customer: $customer, customer_link: $customer_link, super_password: $super_password, slogan: $slogan, rendezvous_server: $rendezvous_server, rs_pub_key: $rs_pub_key, api_server: $api_server}')
          
          # å­˜å‚¨è¾“å‡º
          echo "data=$DATA" >> $GITHUB_OUTPUT
      
      - name: Overwrite issue content
        if: github.event_name == 'issues'
        run: |
          # åˆ›å»ºæ¸…ç†åçš„issueå†…å®¹
          CLEANED_BODY="## æ„å»ºè¯·æ±‚å·²å¤„ç†

          **æ„å»ºå‚æ•°ï¼š**
          - æ ‡ç­¾: ${{ fromJson(steps.setup.outputs.data).tag }}
          - å®¢æˆ·: ${{ fromJson(steps.setup.outputs.data).customer }}
          - æ ‡è¯­: ${{ fromJson(steps.setup.outputs.data).slogan }}

          **çŠ¶æ€ï¼š** æ„å»ºå·²å¯åŠ¨
          **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')

          ---
          *æ•æ„Ÿä¿¡æ¯å·²è‡ªåŠ¨æ¸…ç†*"
          
          # ä½¿ç”¨jqæ­£ç¡®è½¬ä¹‰JSON
          JSON_PAYLOAD=$(jq -n --arg body "$CLEANED_BODY" '{"body": $body}')
          
          # ä½¿ç”¨GitHub APIæ›´æ–°issue
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -d "$JSON_PAYLOAD"
      
      - name: Verify dependencies
        run: echo "Checking system dependencies"
      
      - name: Generate config
        run: |
          # åœ¨åŒä¸€ä¸ªjobä¸­è®¿é—®æ•°æ®
          echo "Trigger type: ${{ github.event_name }}"
          echo "Tag: ${{ fromJson(steps.setup.outputs.data).tag }}"
          echo "Customer: ${{ fromJson(steps.setup.outputs.data).customer }}"
          echo "Rendezvous Server: ${{ fromJson(steps.setup.outputs.data).rendezvous_server }}"

  review: # å®¡æ ¸é˜¶æ®µ
    needs: trigger
    runs-on: ubuntu-latest
    outputs:
      review_output: ${{ toJson(steps.output.outputs.data) }}
      build_approved: ${{ steps.output.outputs.build_approved }}
    steps:
      - name: Extract data
        id: extract
        run: |
          # ä»…æå–æ•°æ®ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†
          INPUT='${{ fromJson(needs.trigger.outputs.trigger_output) }}'
          
          # æå–æœåŠ¡å™¨åœ°å€
          RENDEZVOUS_SERVER=$(echo "$INPUT" | jq -r '.rendezvous_server')
          API_SERVER=$(echo "$INPUT" | jq -r '.api_server')
          EMAIL=$(echo "$INPUT" | jq -r '.email')
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "RENDEZVOUS_SERVER=$RENDEZVOUS_SERVER" >> $GITHUB_ENV
          echo "API_SERVER=$API_SERVER" >> $GITHUB_ENV
          echo "EMAIL=$EMAIL" >> $GITHUB_ENV
          echo "CURRENT_DATA=$INPUT" >> $GITHUB_ENV
          
          # éªŒè¯JSONæ ¼å¼
          echo "Validating JSON format..."
          echo "$INPUT" | jq . > /dev/null
          echo "JSON validation passed"
      
      - name: Auto reject invalid server parameters
        run: |
          # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„IPæˆ–åŸŸåæ ¼å¼
          is_valid_ip() {
            [[ "$1" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}(:[0-9]+)?$ ]]
          }
          is_valid_domain() {
            [[ "$1" =~ ^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(:[0-9]+)?$ ]]
          }
          is_valid_url() {
            local url="$1"
            url="${url#http://}"
            url="${url#https://}"
            is_valid_ip "$url" || is_valid_domain "$url"
          }
          is_email() {
            [[ "$1" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]
          }
          
          # è°ƒè¯•è¾“å‡º
          echo "Validating parameters:"
          echo "RENDEZVOUS_SERVER: $RENDEZVOUS_SERVER"
          echo "API_SERVER: $API_SERVER"
          echo "EMAIL: $EMAIL"
          
          AUTO_REJECT_REASON=""
          
          # æ£€æŸ¥rendezvous_serveræ ¼å¼
          if ! is_valid_ip "$RENDEZVOUS_SERVER" && ! is_valid_domain "$RENDEZVOUS_SERVER"; then
            AUTO_REJECT_REASON="${AUTO_REJECT_REASON}â€¢ rendezvous_server æ ¼å¼æ— æ•ˆ: $RENDEZVOUS_SERVER
          "
            echo "âŒ rendezvous_server format invalid"
          else
            echo "âœ… rendezvous_server format valid"
          fi
          
          # æ£€æŸ¥api_serveræ ¼å¼
          if ! is_valid_url "$API_SERVER"; then
            AUTO_REJECT_REASON="${AUTO_REJECT_REASON}â€¢ api_server æ ¼å¼æ— æ•ˆ: $API_SERVER
          "
            echo "âŒ api_server format invalid"
          else
            echo "âœ… api_server format valid"
          fi
          
          # æ£€æŸ¥emailï¼ˆå¦‚æœæä¾›ï¼‰
          if [ -n "$EMAIL" ] && ! is_email "$EMAIL"; then
            AUTO_REJECT_REASON="${AUTO_REJECT_REASON}â€¢ email æ ¼å¼éæ³•: $EMAIL
          "
            echo "âŒ email validation failed"
          else
            echo "âœ… email validation passed"
          fi
          
          # å»æ‰æœ€åå¤šä½™çš„ç©ºè¡Œ
          AUTO_REJECT_REASON=$(echo "$AUTO_REJECT_REASON" | sed '/^$/d')
          
          if [ -n "$AUTO_REJECT_REASON" ]; then
            echo "è‡ªåŠ¨æ‹’ç»åŸå› ï¼š$AUTO_REJECT_REASON"
            REJECT_COMMENT="## âŒ æ„å»ºè¢«è‡ªåŠ¨æ‹’ç»

          **æ‹’ç»åŸå› ï¼š**
          $AUTO_REJECT_REASON

          **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
          è¯·æ£€æŸ¥å‚æ•°åé‡æ–°æäº¤issueã€‚"
            echo -e "$REJECT_COMMENT" | jq -Rs '{body: .}' | \
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
                -d @-
            echo "BUILD_REJECTED=true" >> $GITHUB_ENV
            exit 0
          else
            echo "âœ… All parameter validations passed"
          fi

      - name: Determine review requirement
        if: env.BUILD_REJECTED != 'true'
        run: |
          # é»˜è®¤éœ€è¦å®¡æ ¸
          NEED_REVIEW=true

          # ä»“åº“æ‰€æœ‰è€…å…å®¡æ ¸
          if [ "${{ github.actor }}" = "${{ github.repository_owner }}" ]; then
            echo "Repo owner detected, skipping review."
            NEED_REVIEW=false
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸ºç§æœ‰IPåœ°å€
          check_private_ip() {
            local input="$1"
            local ip="$input"
            
            # ç§»é™¤åè®®å‰ç¼€
            ip="${ip#http://}"
            ip="${ip#https://}"
            
            # ç§»é™¤ç«¯å£å·ï¼ˆå¦‚æœæœ‰ï¼‰
            ip=$(echo "$ip" | cut -d: -f1)
            
            echo "Checking IP: $ip (from: $input)"
            
            # æ£€æŸ¥10.0.0.0/8
            if [[ "$ip" =~ ^10\. ]]; then
              echo "âœ… 10.x.x.x private IP detected"
              return 0
            fi
            
            # æ£€æŸ¥172.16.0.0/12
            if [[ "$ip" =~ ^172\.(1[6-9]|2[0-9]|3[0-1])\. ]]; then
              echo "âœ… 172.16-31.x.x private IP detected"
              return 0
            fi
            
            # æ£€æŸ¥192.168.0.0/16
            if [[ "$ip" =~ ^192\.168\. ]]; then
              echo "âœ… 192.168.x.x private IP detected"
              return 0
            fi
            
            echo "âŒ Public IP or domain detected: $ip"
            return 1
          }
          
          # æ£€æŸ¥ä¸¤ä¸ªæœåŠ¡å™¨åœ°å€
          RENDEZVOUS_PRIVATE=false
          API_PRIVATE=false
          
          echo "Checking Rendezvous Server: $RENDEZVOUS_SERVER"
          if check_private_ip "$RENDEZVOUS_SERVER"; then
            RENDEZVOUS_PRIVATE=true
            echo "Rendezvous server is private IP: $RENDEZVOUS_SERVER"
          else
            echo "Rendezvous server is public IP or domain: $RENDEZVOUS_SERVER"
          fi
          
          echo "Checking API Server: $API_SERVER"
          if check_private_ip "$API_SERVER"; then
            API_PRIVATE=true
            echo "API server is private IP: $API_SERVER"
          else
            echo "API server is public IP or domain: $API_SERVER"
          fi
          
          # åˆ¤æ–­æ˜¯å¦éœ€è¦å®¡æ ¸
          if [ "$NEED_REVIEW" = "false" ]; then
            echo "Skipping review due to repo owner or private IP check."
          else
            if [ "$RENDEZVOUS_PRIVATE" = "true" ] && [ "$API_PRIVATE" = "true" ]; then
              NEED_REVIEW=false
              echo "Both servers are private IPs - no review needed"
            else
              NEED_REVIEW=true
              echo "At least one server is public IP - review required"
            fi
          fi
          
          # è®¾ç½®å®¡æ ¸æ ‡è®°åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "NEED_REVIEW=$NEED_REVIEW" >> $GITHUB_ENV
      
      - name: Handle review process
        if: env.NEED_REVIEW == 'true' && env.BUILD_REJECTED != 'true'
        run: |
          echo "Review required. Starting review process..."
          
          # åœ¨issueä¸­æ·»åŠ å®¡æ ¸çŠ¶æ€
          REVIEW_COMMENT="## ğŸ” å®¡æ ¸çŠ¶æ€

          **éœ€è¦å®¡æ ¸åŸå› ï¼š** æ£€æµ‹åˆ°å…¬ç½‘IPåœ°å€æˆ–åŸŸå
          - Rendezvous Server: $RENDEZVOUS_SERVER
          - API Server: $API_SERVER

          **å®¡æ ¸è¦æ±‚ï¼š** è¯·ç®¡ç†å‘˜å›å¤ 'åŒæ„æ„å»º' æˆ– 'æ‹’ç»æ„å»º'

          **çŠ¶æ€ï¼š** ç­‰å¾…å®¡æ ¸ä¸­ â³
          **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ä½¿ç”¨jqæ­£ç¡®è½¬ä¹‰JSON
          JSON_PAYLOAD=$(jq -n --arg body "$REVIEW_COMMENT" '{"body": $body}')

          # æ·»åŠ å®¡æ ¸è¯„è®º
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d "$(jq -n --arg body "$REVIEW_COMMENT" '{"body": $body}')"
          
          # å¾ªç¯æ£€æŸ¥å®¡æ ¸å›å¤
          START_TIME=$(date +%s)
          TIMEOUT=21600  # 6å°æ—¶è¶…æ—¶
          APPROVED=false
          REJECTED=false # æ–°å¢å˜é‡ï¼Œç”¨äºæ ‡è®°æ‹’ç»
          
          while [ $(($(date +%s) - START_TIME)) -lt $TIMEOUT ]; do
            echo "Checking for admin approval... ($(($(date +%s) - START_TIME))s elapsed)"
            
            # è·å–issueçš„æœ€æ–°è¯„è®º
            COMMENTS=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments)
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜å›å¤
            # è·å–ä»“åº“æ‰€æœ‰è€…å’Œç®¡ç†å‘˜åˆ—è¡¨
            REPO_OWNER="${{ github.repository_owner }}"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜å›å¤ï¼ˆåŒ…æ‹¬ä»“åº“æ‰€æœ‰è€…ï¼‰
            if echo "$COMMENTS" | jq -e --arg owner "$REPO_OWNER" '.[] | select(.user.login == $owner or .user.login == "admin" or .user.login == "ç®¡ç†å‘˜ç”¨æˆ·å") | select(.body | contains("åŒæ„æ„å»º"))' > /dev/null; then
              APPROVED=true
              break
            fi
            
            if echo "$COMMENTS" | jq -e --arg owner "$REPO_OWNER" '.[] | select(.user.login == $owner or .user.login == "admin" or .user.login == "ç®¡ç†å‘˜ç”¨æˆ·å") | select(.body | contains("æ‹’ç»æ„å»º"))' > /dev/null; then
              REJECTED=true
              break
            fi
            
            # è°ƒè¯•ï¼šè¾“å‡ºæœ€æ–°çš„è¯„è®ºä¿¡æ¯
            echo "Latest comments:"
            echo "$COMMENTS" | jq -r '.[-3:] | .[] | "User: \(.user.login), Body: \(.body[0:100])..."'
            
            # ç­‰å¾…30ç§’åå†æ¬¡æ£€æŸ¥
            sleep 30
          done
          
          if [ "$APPROVED" = true ]; then
            echo "Admin approval received"
            # æ·»åŠ å®¡æ ¸é€šè¿‡è¯„è®º
            APPROVAL_COMMENT="## âœ… å®¡æ ¸é€šè¿‡
            **çŠ¶æ€ï¼š** å®¡æ ¸å·²é€šè¿‡
            **å®¡æ ¸äººï¼š** ç®¡ç†å‘˜
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            æ„å»ºå°†ç»§ç»­è¿›è¡Œ..."
            
          # ä½¿ç”¨jqæ­£ç¡®è½¬ä¹‰JSON
          JSON_PAYLOAD=$(jq -n --arg body "$APPROVAL_COMMENT" '{"body": $body}')

            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d "$(jq -n --arg body "$APPROVAL_COMMENT" '{"body": $body}')"
          elif [ "$REJECTED" = true ]; then
            echo "Build rejected by admin"
            
            # æ·»åŠ æ‹’ç»è¯„è®º
            REJECT_COMMENT="## âŒ æ„å»ºè¢«æ‹’ç»
            **çŠ¶æ€ï¼š** æ„å»ºå·²è¢«ç®¡ç†å‘˜æ‹’ç»
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            æ„å»ºæµç¨‹å·²ç»ˆæ­¢ã€‚å¦‚éœ€é‡æ–°æ„å»ºï¼Œè¯·é‡æ–°æäº¤issueã€‚"
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d "$(jq -n --arg body "$REJECT_COMMENT" "{\"body\": \$body}")"
            
            echo "Build rejected by admin - setting build_approved to false"
            # è®¾ç½®æ„å»ºè¢«æ‹’ç»æ ‡å¿—
            echo "BUILD_REJECTED=true" >> $GITHUB_ENV
            exit 0
          else
            echo "Review timeout after 6 hours"
            # æ·»åŠ è¶…æ—¶è¯„è®º
            TIMEOUT_COMMENT="## â° å®¡æ ¸è¶…æ—¶
            **çŠ¶æ€ï¼š** å®¡æ ¸è¶…æ—¶ï¼ˆ6å°æ—¶ï¼‰
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            æ„å»ºå°†è‡ªåŠ¨ç»ˆæ­¢ã€‚å¦‚éœ€é‡æ–°æ„å»ºï¼Œè¯·é‡æ–°æäº¤issueã€‚"
            
            echo -e "$TIMEOUT_COMMENT" | jq -Rs '{body: .}' | \
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
                -d @-
            
            exit 1
          fi

      - name: Output data
        if: env.BUILD_REJECTED != 'true'
        id: output
        run: |
          # é‡æ–°è·å–åŸå§‹æ•°æ®å¹¶ç¡®ä¿JSONæ ¼å¼æ­£ç¡®
          INPUT='${{ fromJson(needs.trigger.outputs.trigger_output) }}'
          
          # ç¡®ä¿è¾“å‡ºçš„æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼
          echo "data=$INPUT" >> $GITHUB_OUTPUT
          
          # æ ¹æ®æ ‡å¿—è®¾ç½®æ„å»ºæ‰¹å‡†çŠ¶æ€
          if [ "${{ env.BUILD_REJECTED }}" = "true" ]; then
            echo "build_approved=false" >> $GITHUB_OUTPUT
            echo "Build was rejected by admin"
          elif [ "${{ env.BUILD_TIMEOUT }}" = "true" ]; then
            echo "build_approved=false" >> $GITHUB_OUTPUT
            echo "Build timed out during review"
          else
            echo "build_approved=true" >> $GITHUB_OUTPUT
            echo "Build was approved or no review needed"
          fi
          
          # æ˜¾ç¤ºè¾“å‡ºä¿¡æ¯
          echo "Review output: $INPUT"
          
          # éªŒè¯è¾“å‡ºçš„JSONæ ¼å¼
          echo "Validating output JSON format..."
          echo "$INPUT" | jq . > /dev/null
          echo "Output JSON validation passed"

  queue: # æ’é˜Ÿé˜¶æ®µ
    needs: review
    runs-on: ubuntu-latest
    if: needs.review.outputs.build_approved == 'true'
    outputs:
      queue_output: ${{ toJson(steps.output.outputs.data) }}
    steps:
      - name: Extract data
        id: extract
        run: |
          # æå–æ•°æ®
          INPUT='${{ fromJson(needs.review.outputs.review_output) }}'
          
          # éªŒè¯è¾“å…¥JSONæ ¼å¼
          echo "Validating input JSON format..."
          echo "$INPUT" | jq . > /dev/null
          echo "Input JSON validation passed"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CURRENT_DATA=$INPUT" >> $GITHUB_ENV
          
          # è·å–è§¦å‘æ–¹å¼
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TRIGGER_TYPE=workflow_dispatch" >> $GITHUB_ENV
            echo "QUEUE_LIMIT=5" >> $GITHUB_ENV
          else
            echo "TRIGGER_TYPE=issue" >> $GITHUB_ENV
            echo "QUEUE_LIMIT=3" >> $GITHUB_ENV
          fi

      - name: Auto cleanup queue
        run: |
          # è‡ªåŠ¨æ¸…ç†é˜Ÿåˆ—ï¼Œå¤„ç†å¼‚å¸¸é”å’Œå¡ä½çš„çŠ¶æ€
          echo "Starting automatic queue cleanup..."
          
          QUEUE_MANAGER_ISSUE="1"
          QUEUE_MANAGER_CONTENT=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE")
          
          # æ£€æŸ¥issueæ˜¯å¦å­˜åœ¨
          if echo "$QUEUE_MANAGER_CONTENT" | jq -e '.message' | grep -q "Not Found"; then
            echo "Queue manager issue #$QUEUE_MANAGER_ISSUE not found, skipping cleanup"
            echo "QUEUE_CLEANED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # è§£æé˜Ÿåˆ—æ•°æ®
          QUEUE_DATA=$(echo "$QUEUE_MANAGER_CONTENT" | jq -r '.body' | grep -oP '```json\K.*?(?=```)' | head -1)
          
          if [ -z "$QUEUE_DATA" ]; then
            echo "No queue data found, skipping cleanup"
            echo "QUEUE_CLEANED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # éªŒè¯JSONæ ¼å¼
          if ! echo "$QUEUE_DATA" | jq . > /dev/null 2>&1; then
            echo "Invalid JSON format in queue data, skipping cleanup"
            echo "QUEUE_CLEANED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "Current queue data: $QUEUE_DATA"
          
          # è·å–å½“å‰çŠ¶æ€
          CURRENT_BUILD=$(echo "$QUEUE_DATA" | jq -r '.current_build // null')
          LOCK_HOLDER=$(echo "$QUEUE_DATA" | jq -r '.lock_holder // null')
          LOCK_RUN_ID=$(echo "$QUEUE_DATA" | jq -r '.run_id // empty')
          ISSUE_QUEUE=$(echo "$QUEUE_DATA" | jq -r '.issue_queue // []')
          WORKFLOW_QUEUE=$(echo "$QUEUE_DATA" | jq -r '.workflow_queue // []')
          
          echo "Current build: $CURRENT_BUILD"
          echo "Lock holder: $LOCK_HOLDER"
          echo "Lock run_id: $LOCK_RUN_ID"
          echo "Issue queue: $ISSUE_QUEUE"
          echo "Workflow queue: $WORKFLOW_QUEUE"
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç†
          NEED_CLEANUP=false
          CLEANUP_REASON=""
          
          # 1. æ£€æŸ¥é”æ˜¯å¦å¼‚å¸¸ï¼ˆæœ‰é”ä½†æ²¡æœ‰æŒæœ‰è€…ï¼Œæˆ–æœ‰æŒæœ‰è€…ä½†æ²¡æœ‰é”ï¼Œæˆ–ç¼ºå°‘run_idï¼‰
          if [ "$CURRENT_BUILD" != "null" ] && [ "$LOCK_HOLDER" = "null" ]; then
            NEED_CLEANUP=true
            CLEANUP_REASON="${CLEANUP_REASON}â€¢ é”å¼‚å¸¸ï¼šæœ‰æ„å»ºé¡¹ç›®ä½†æ— æŒæœ‰è€…
          "
            echo "âŒ Lock anomaly detected: build=$CURRENT_BUILD, holder=null"
          fi
          
          if [ "$CURRENT_BUILD" = "null" ] && [ "$LOCK_HOLDER" != "null" ]; then
            NEED_CLEANUP=true
            CLEANUP_REASON="${CLEANUP_REASON}â€¢ é”å¼‚å¸¸ï¼šæœ‰æŒæœ‰è€…ä½†æ— æ„å»ºé¡¹ç›®
          "
            echo "âŒ Lock anomaly detected: build=null, holder=$LOCK_HOLDER"
          fi
          
          if [ "$CURRENT_BUILD" != "null" ] && [ "$LOCK_HOLDER" != "null" ] && [ -z "$LOCK_RUN_ID" ]; then
            NEED_CLEANUP=true
            CLEANUP_REASON="${CLEANUP_REASON}â€¢ é”å¼‚å¸¸ï¼šæœ‰æ„å»ºé¡¹ç›®å’ŒæŒæœ‰è€…ä½†ç¼ºå°‘run_id
          "
            echo "âŒ Lock anomaly detected: build=$CURRENT_BUILD, holder=$LOCK_HOLDER, run_id=empty"
          fi
          
          # 2. æ£€æŸ¥é”æ˜¯å¦é•¿æ—¶é—´å ç”¨ï¼ˆè¶…è¿‡2å°æ—¶ï¼‰
          if [ "$CURRENT_BUILD" != "null" ] && [ "$CURRENT_BUILD" != "null" ]; then
            # è·å–é”æŒæœ‰æ—¶é—´ï¼ˆä»é˜Ÿåˆ—é¡¹ä¸­æŸ¥æ‰¾ï¼‰
            LOCK_ISSUE_JOIN_TIME=""
            if [ "$(echo "$ISSUE_QUEUE" | jq -r 'type')" = "array" ]; then
              LOCK_ISSUE_JOIN_TIME=$(echo "$ISSUE_QUEUE" | \
                jq -r --arg issue_number "$CURRENT_BUILD" \
                '.[] | select(.issue_number == $issue_number) | .join_time // empty')
            fi
            
            if [ "$(echo "$WORKFLOW_QUEUE" | jq -r 'type')" = "array" ]; then
              if [ -z "$LOCK_ISSUE_JOIN_TIME" ]; then
                LOCK_ISSUE_JOIN_TIME=$(echo "$WORKFLOW_QUEUE" | \
                  jq -r --arg issue_number "$CURRENT_BUILD" \
                  '.[] | select(.issue_number == $issue_number) | .join_time // empty')
              fi
            fi
            
            if [ -n "$LOCK_ISSUE_JOIN_TIME" ]; then
              # è®¡ç®—é”æŒæœ‰æ—¶é—´
              JOIN_TIMESTAMP=$(date -d "$LOCK_ISSUE_JOIN_TIME" +%s 2>/dev/null || echo "0")
              CURRENT_TIMESTAMP=$(date +%s)
              LOCK_DURATION=$((CURRENT_TIMESTAMP - JOIN_TIMESTAMP))
              LOCK_DURATION_HOURS=$((LOCK_DURATION / 3600))
              
              echo "Lock duration: ${LOCK_DURATION_HOURS} hours"
              
              if [ "$LOCK_DURATION_HOURS" -ge 2 ]; then
                NEED_CLEANUP=true
                CLEANUP_REASON="${CLEANUP_REASON}â€¢ é”è¶…æ—¶ï¼šå·²å ç”¨${LOCK_DURATION_HOURS}å°æ—¶
          "
                echo "âŒ Lock timeout detected: ${LOCK_DURATION_HOURS} hours"
              fi
            fi
          fi
          
          # 3. æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰é‡å¤é¡¹
          if [ "$(echo "$ISSUE_QUEUE" | jq -r 'type')" = "array" ]; then
            DUPLICATE_ISSUES=$(echo "$ISSUE_QUEUE" | \
              jq -r 'group_by(.issue_number) | .[] | select(length > 1) | .[0].issue_number' 2>/dev/null || echo "")
            
            if [ -n "$DUPLICATE_ISSUES" ]; then
              NEED_CLEANUP=true
              CLEANUP_REASON="${CLEANUP_REASON}â€¢ é˜Ÿåˆ—é‡å¤ï¼šIssue $DUPLICATE_ISSUES é‡å¤
          "
              echo "âŒ Duplicate issues detected: $DUPLICATE_ISSUES"
            fi
          fi
          
          if [ "$(echo "$WORKFLOW_QUEUE" | jq -r 'type')" = "array" ]; then
            DUPLICATE_WORKFLOWS=$(echo "$WORKFLOW_QUEUE" | \
              jq -r 'group_by(.issue_number) | .[] | select(length > 1) | .[0].issue_number' 2>/dev/null || echo "")
            
            if [ -n "$DUPLICATE_WORKFLOWS" ]; then
              NEED_CLEANUP=true
              CLEANUP_REASON="${CLEANUP_REASON}â€¢ é˜Ÿåˆ—é‡å¤ï¼šWorkflow $DUPLICATE_WORKFLOWS é‡å¤
          "
              echo "âŒ Duplicate workflows detected: $DUPLICATE_WORKFLOWS"
            fi
          fi
          
          # 4. æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å·²å®Œæˆçš„æ„å»º
          if [ "$CURRENT_BUILD" != "null" ] && [ "$CURRENT_BUILD" != "null" ]; then
            # æ£€æŸ¥å½“å‰æ„å»ºæ˜¯å¦è¿˜åœ¨é˜Ÿåˆ—ä¸­
            ISSUE_IN_QUEUE=$(echo "$ISSUE_QUEUE" | \
              jq -r --arg issue_number "$CURRENT_BUILD" \
              'map(.issue_number) | contains([$issue_number])' 2>/dev/null || echo "false")
            
            WORKFLOW_IN_QUEUE=$(echo "$WORKFLOW_QUEUE" | \
              jq -r --arg issue_number "$CURRENT_BUILD" \
              'map(.issue_number) | contains([$issue_number])' 2>/dev/null || echo "false")
            
            if [ "$ISSUE_IN_QUEUE" != "true" ] && [ "$WORKFLOW_IN_QUEUE" != "true" ]; then
              NEED_CLEANUP=true
              CLEANUP_REASON="${CLEANUP_REASON}â€¢ æ„å»ºå®Œæˆï¼šIssue $CURRENT_BUILD å·²ä¸åœ¨é˜Ÿåˆ—ä¸­
          "
              echo "âŒ Build completed but lock not released: $CURRENT_BUILD"
            fi
          fi
          
          # æ‰§è¡Œæ¸…ç†
          if [ "$NEED_CLEANUP" = true ]; then
            echo "Performing queue cleanup..."
            echo "Cleanup reasons: $CLEANUP_REASON"
            
            # æ¸…ç†åçš„é˜Ÿåˆ—æ•°æ®
            CLEANED_QUEUE_DATA=$(echo "$QUEUE_DATA" | jq '
              # ç§»é™¤é‡å¤é¡¹
              .issue_queue = (.issue_queue | group_by(.issue_number) | map(.[0]))
              | .workflow_queue = (.workflow_queue | group_by(.issue_number) | map(.[0]))
              # é‡ç½®å¼‚å¸¸é”
              | .current_build = null
              | .lock_holder = null
              | .run_id = null
            ')
            
            # è®¡ç®—æ¸…ç†åçš„é˜Ÿåˆ—æ•°é‡ - ä½¿ç”¨å®‰å…¨çš„é»˜è®¤å€¼
            CLEANED_ISSUE_COUNT=$(echo "$CLEANED_QUEUE_DATA" | jq '.issue_queue | length // 0')
            CLEANED_WORKFLOW_COUNT=$(echo "$CLEANED_QUEUE_DATA" | jq '.workflow_queue | length // 0')
            CLEANED_TOTAL_COUNT=$((CLEANED_ISSUE_COUNT + CLEANED_WORKFLOW_COUNT))
            
            # ç¡®ä¿æ•°é‡ä¸ä¸ºç©º
            if [ -z "$CLEANED_ISSUE_COUNT" ]; then
              CLEANED_ISSUE_COUNT=0
            fi
            if [ -z "$CLEANED_WORKFLOW_COUNT" ]; then
              CLEANED_WORKFLOW_COUNT=0
            fi
            if [ -z "$CLEANED_TOTAL_COUNT" ]; then
              CLEANED_TOTAL_COUNT=0
            fi
            
            # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
            CLEANED_BODY="## æ„å»ºé˜Ÿåˆ—ç®¡ç†

          **æœ€åæ›´æ–°æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')

          ### å½“å‰çŠ¶æ€
          - **æ„å»ºé”çŠ¶æ€ï¼š** ç©ºé—² ğŸ”“ (å·²æ¸…ç†)
          - **å½“å‰æ„å»ºï¼š** æ— 
          - **é”æŒæœ‰è€…ï¼š** æ— 
          - **è¿è¡ŒIDï¼š** æ— 

          ### Issueé˜Ÿåˆ— (æœ€å¤š3ä¸ª)
          - å½“å‰æ•°é‡ï¼š$CLEANED_ISSUE_COUNT/3

          ### Workflowé˜Ÿåˆ— (æœ€å¤š5ä¸ª)
          - å½“å‰æ•°é‡ï¼š$CLEANED_WORKFLOW_COUNT/5

          ### æ€»é˜Ÿåˆ— (æœ€å¤š5ä¸ª)
          - å½“å‰æ•°é‡ï¼š$CLEANED_TOTAL_COUNT/5

          ---

          ### æ¸…ç†è®°å½•
          **æ¸…ç†æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
          **æ¸…ç†åŸå› ï¼š**
          $CLEANUP_REASON

          ### é˜Ÿåˆ—æ•°æ®
          \`\`\`json
          $CLEANED_QUEUE_DATA
          \`\`\`"
            
            # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
            curl -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE" \
              -d "$(jq -n --arg body "$CLEANED_BODY" '{"body": $body}')"
            
            echo "Queue cleanup completed successfully!"
            echo "Cleaned issue count: $CLEANED_ISSUE_COUNT"
            echo "Cleaned workflow count: $CLEANED_WORKFLOW_COUNT"
            echo "Cleaned total count: $CLEANED_TOTAL_COUNT"
            
            # ä¿å­˜æ¸…ç†åçš„æ•°æ®ä¾›åç»­ä½¿ç”¨
            echo "CLEANED_QUEUE_DATA=$CLEANED_QUEUE_DATA" >> $GITHUB_ENV
            echo "QUEUE_CLEANED=true" >> $GITHUB_ENV
          else
            echo "No cleanup needed, queue is healthy"
            echo "QUEUE_CLEANED=false" >> $GITHUB_ENV
          fi

      - name: Check queue status
        id: check_queue
        run: |
          # è·å–å½“å‰é˜Ÿåˆ—çŠ¶æ€
          echo "Checking current queue status..."
          
          # é˜Ÿåˆ—ç®¡ç†issueç¼–å·
          QUEUE_MANAGER_ISSUE="1"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æ¸…ç†è¿‡é˜Ÿåˆ—
          if [ "${{ env.QUEUE_CLEANED }}" = "true" ]; then
            echo "Using cleaned queue data from previous step"
            QUEUE_DATA='${{ env.CLEANED_QUEUE_DATA }}'
          else
            # è·å–é˜Ÿåˆ—ç®¡ç†issueçš„å†…å®¹
            QUEUE_MANAGER_CONTENT=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE")
            
            # æ£€æŸ¥issueæ˜¯å¦å­˜åœ¨
            if echo "$QUEUE_MANAGER_CONTENT" | jq -e '.message' | grep -q "Not Found"; then
              echo "Error: Queue manager issue #$QUEUE_MANAGER_ISSUE not found"
              exit 1
            fi
            
            # è§£æé˜Ÿåˆ—æ•°æ®ï¼ˆä»issue bodyä¸­æå–JSONï¼‰
            QUEUE_DATA=$(echo "$QUEUE_MANAGER_CONTENT" | jq -r '.body' | grep -oP '```json\K.*?(?=```)' | head -1)
            
            if [ -z "$QUEUE_DATA" ]; then
              # å¦‚æœé˜Ÿåˆ—æ•°æ®ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ç©ºé˜Ÿåˆ—
              echo "Initializing empty queue..."
              QUEUE_DATA='{"issue_queue":[],"workflow_queue":[],"current_build":null,"lock_holder":null,"run_id":null}'
              
              # åˆ›å»ºåˆå§‹é˜Ÿåˆ—ç®¡ç†å†…å®¹
              INITIAL_BODY="## æ„å»ºé˜Ÿåˆ—ç®¡ç†

            **æœ€åæ›´æ–°æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')

            ### å½“å‰çŠ¶æ€
            - **æ„å»ºé”çŠ¶æ€ï¼š** ç©ºé—² ğŸ”“
            - **å½“å‰æ„å»ºï¼š** æ— 
            - **é”æŒæœ‰è€…ï¼š** æ— 
            - **è¿è¡ŒIDï¼š** æ— 

            ### Issueé˜Ÿåˆ— (æœ€å¤š3ä¸ª)
            - å½“å‰æ•°é‡ï¼š0/3

            ### Workflowé˜Ÿåˆ— (æœ€å¤š5ä¸ª)
            - å½“å‰æ•°é‡ï¼š0/5

            ### æ€»é˜Ÿåˆ— (æœ€å¤š5ä¸ª)
            - å½“å‰æ•°é‡ï¼š0/5

            ---

            ### é˜Ÿåˆ—æ•°æ®
            \`\`\`json
            $QUEUE_DATA
            \`\`\`"
              
              # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
              curl -X PATCH \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Content-Type: application/json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE" \
                -d "$(jq -n --arg body "$INITIAL_BODY" '{"body": $body}')"
            fi
          fi
          
          # éªŒè¯JSONæ ¼å¼
          echo "Validating JSON format..."
          echo "$QUEUE_DATA" | jq . > /dev/null
          echo "JSON validation passed"
          
          # è°ƒè¯•è¾“å‡ºé˜Ÿåˆ—æ•°æ®
          echo "Queue data: $QUEUE_DATA"
          echo "Queue data type: $(echo "$QUEUE_DATA" | jq -r 'type')"
          echo "Issue queue: $(echo "$QUEUE_DATA" | jq -r '.issue_queue')"
          echo "Workflow queue: $(echo "$QUEUE_DATA" | jq -r '.workflow_queue')"
          echo "Current build: $(echo "$QUEUE_DATA" | jq -r '.current_build')"
          echo "Lock holder: $(echo "$QUEUE_DATA" | jq -r '.lock_holder')"
          
          # è·å–å½“å‰å„ç±»å‹é˜Ÿåˆ—æ•°é‡ - ä½¿ç”¨å®‰å…¨çš„é»˜è®¤å€¼
          ISSUE_QUEUE_COUNT=$(echo "$QUEUE_DATA" | jq '.issue_queue | length // 0')
          WORKFLOW_QUEUE_COUNT=$(echo "$QUEUE_DATA" | jq '.workflow_queue | length // 0')
          TOTAL_QUEUE_COUNT=$((ISSUE_QUEUE_COUNT + WORKFLOW_QUEUE_COUNT))
          CURRENT_BUILD=$(echo "$QUEUE_DATA" | jq -r '.current_build // null')
          LOCK_HOLDER=$(echo "$QUEUE_DATA" | jq -r '.lock_holder // null')
          
          # ç¡®ä¿æ•°é‡ä¸ä¸ºç©º
          if [ -z "$ISSUE_QUEUE_COUNT" ]; then
            ISSUE_QUEUE_COUNT=0
          fi
          if [ -z "$WORKFLOW_QUEUE_COUNT" ]; then
            WORKFLOW_QUEUE_COUNT=0
          fi
          if [ -z "$TOTAL_QUEUE_COUNT" ]; then
            TOTAL_QUEUE_COUNT=0
          fi
          
          echo "Current issue queue count: $ISSUE_QUEUE_COUNT/3"
          echo "Current workflow queue count: $WORKFLOW_QUEUE_COUNT/5"
          echo "Total queue count: $TOTAL_QUEUE_COUNT/5"
          echo "Current build: $CURRENT_BUILD"
          echo "Lock holder: $LOCK_HOLDER"
          
          # æ£€æŸ¥æ˜¯å¦å¯ä»¥åŠ å…¥é˜Ÿåˆ—
          QUEUE_FULL=false
          REJECT_REASON=""
          
          # æ£€æŸ¥æ€»é˜Ÿåˆ—é™åˆ¶
          if [ "$TOTAL_QUEUE_COUNT" -ge 5 ]; then
            QUEUE_FULL=true
            REJECT_REASON="æ€»é˜Ÿåˆ—å·²æ»¡ (å½“å‰: $TOTAL_QUEUE_COUNT/5)"
          elif [ "$TRIGGER_TYPE" = "issue" ] && [ "$ISSUE_QUEUE_COUNT" -ge 3 ]; then
            QUEUE_FULL=true
            REJECT_REASON="Issueé˜Ÿåˆ—å·²æ»¡ (å½“å‰: $ISSUE_QUEUE_COUNT/3)"
          elif [ "$TRIGGER_TYPE" = "workflow_dispatch" ] && [ "$WORKFLOW_QUEUE_COUNT" -ge 5 ]; then
            QUEUE_FULL=true
            REJECT_REASON="Workflowé˜Ÿåˆ—å·²æ»¡ (å½“å‰: $WORKFLOW_QUEUE_COUNT/5)"
          else
            QUEUE_FULL=false
          fi
          
          if [ "$QUEUE_FULL" = true ]; then
            echo "Queue is full: $REJECT_REASON"
            echo "QUEUE_FULL=true" >> $GITHUB_ENV
            echo "REJECT_REASON=$REJECT_REASON" >> $GITHUB_ENV
            
            # è®¡ç®—é¢„è®¡ç­‰å¾…æ—¶é—´ï¼ˆå‡è®¾æ¯ä¸ªæ„å»ºéœ€è¦30åˆ†é’Ÿï¼‰
            ESTIMATED_WAIT=$((TOTAL_QUEUE_COUNT * 30))
            echo "ESTIMATED_WAIT=$ESTIMATED_WAIT" >> $GITHUB_ENV
          else
            echo "Queue has space"
            echo "QUEUE_FULL=false" >> $GITHUB_ENV
          fi
          
          # ä¿å­˜é˜Ÿåˆ—æ•°æ®ä¾›åç»­ä½¿ç”¨
          echo "QUEUE_DATA=$QUEUE_DATA" >> $GITHUB_ENV
          echo "CURRENT_BUILD=$CURRENT_BUILD" >> $GITHUB_ENV
          echo "LOCK_HOLDER=$LOCK_HOLDER" >> $GITHUB_ENV

      - name: Handle queue full
        if: env.QUEUE_FULL == 'true'
        run: |
          # ä»ç¯å¢ƒå˜é‡è·å–é˜Ÿåˆ—æ•°æ®
          QUEUE_DATA='${{ env.QUEUE_DATA }}'
          ISSUE_QUEUE_COUNT=$(echo "$QUEUE_DATA" | jq '.issue_queue | length')
          WORKFLOW_QUEUE_COUNT=$(echo "$QUEUE_DATA" | jq '.workflow_queue | length')
          TOTAL_QUEUE_COUNT=$((ISSUE_QUEUE_COUNT + WORKFLOW_QUEUE_COUNT))
          REJECT_REASON='${{ env.REJECT_REASON }}'
          ESTIMATED_WAIT='${{ env.ESTIMATED_WAIT }}'
          
          # é˜Ÿåˆ—æ»¡å‘˜ï¼Œæ‹’ç»è¯·æ±‚
          REJECT_COMMENT="## âŒ é˜Ÿåˆ—å·²æ»¡

          **æ‹’ç»åŸå› ï¼š** $REJECT_REASON
          **å½“å‰é˜Ÿåˆ—çŠ¶æ€ï¼š**
          - Issueé˜Ÿåˆ—ï¼š$ISSUE_QUEUE_COUNT/3
          - Workflowé˜Ÿåˆ—ï¼š$WORKFLOW_QUEUE_COUNT/5
          - æ€»é˜Ÿåˆ—ï¼š$TOTAL_QUEUE_COUNT/5
          **é¢„è®¡ç­‰å¾…æ—¶é—´ï¼š** çº¦${ESTIMATED_WAIT}åˆ†é’Ÿ

          **å»ºè®®ï¼š**
          - è¯·ç¨åé‡è¯•
          - æˆ–ä½¿ç”¨å…¶ä»–è§¦å‘æ–¹å¼

          **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')"
          
          # æ·»åŠ æ‹’ç»è¯„è®º
          echo -e "$REJECT_COMMENT" | jq -Rs '{body: .}' | \
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d @-
          
          # é€€å‡ºå·¥ä½œæµ
          exit 1

      - name: Join queue
        if: env.QUEUE_FULL == 'false'
        run: |
          # åŠ å…¥é˜Ÿåˆ—
          echo "Joining queue..."
          
          # ä»ç¯å¢ƒå˜é‡è·å–é˜Ÿåˆ—æ•°æ®
          QUEUE_DATA='${{ env.QUEUE_DATA }}'
          CURRENT_BUILD='${{ env.CURRENT_BUILD }}'
          LOCK_HOLDER='${{ env.LOCK_HOLDER }}'
          
          echo "Retrieved queue data: $QUEUE_DATA"
          echo "Current build: $CURRENT_BUILD"
          echo "Lock holder: $LOCK_HOLDER"
          
          # ç®€å•éªŒè¯é˜Ÿåˆ—æ•°æ®
          echo "Validating queue data..."
          echo "Queue data type: $(echo "$QUEUE_DATA" | jq -r 'type')"
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯å¯¹è±¡
          if [ "$(echo "$QUEUE_DATA" | jq -r 'type')" != "object" ]; then
            echo "âŒ QUEUE_DATA is not an object"
            exit 1
          fi
          
          echo "âœ… QUEUE_DATA is an object"
          
          # è·å–å½“å‰issueä¿¡æ¯
          CURRENT_ISSUE_NUMBER="${{ github.event.issue.number }}"
          CURRENT_ISSUE_TITLE="${{ github.event.issue.title }}"
          CURRENT_USER="${{ github.actor }}"
          JOIN_TIME=$(date -Iseconds)
          
          # åˆ›å»ºé˜Ÿåˆ—é¡¹
          QUEUE_ITEM=$(jq -n \
            --arg issue_number "$CURRENT_ISSUE_NUMBER" \
            --arg issue_title "$CURRENT_ISSUE_TITLE" \
            --arg user "$CURRENT_USER" \
            --arg join_time "$JOIN_TIME" \
            '{
              issue_number: $issue_number,
              issue_title: $issue_title,
              user: $user,
              join_time: $join_time
            }')
          
          echo "Queue item: $QUEUE_ITEM"
          
          # æ›´æ–°é˜Ÿåˆ—æ•°æ®
          if [ "$TRIGGER_TYPE" = "issue" ]; then
            UPDATED_QUEUE_DATA=$(echo "$QUEUE_DATA" | jq --argjson item "$QUEUE_ITEM" '.issue_queue += [$item]')
            echo "Updated issue queue"
          else
            UPDATED_QUEUE_DATA=$(echo "$QUEUE_DATA" | jq --argjson item "$QUEUE_ITEM" '.workflow_queue += [$item]')
            echo "Updated workflow queue"
          fi
          
          echo "Updated queue data: $UPDATED_QUEUE_DATA"
          
          # è®¡ç®—é˜Ÿåˆ—æ•°é‡ - ä½¿ç”¨å®‰å…¨çš„é»˜è®¤å€¼
          UPDATED_ISSUE_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.issue_queue | length // 0')
          UPDATED_WORKFLOW_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.workflow_queue | length // 0')
          UPDATED_TOTAL_COUNT=$((UPDATED_ISSUE_COUNT + UPDATED_WORKFLOW_COUNT))
          
          # ç¡®ä¿æ•°é‡ä¸ä¸ºç©º
          if [ -z "$UPDATED_ISSUE_COUNT" ]; then UPDATED_ISSUE_COUNT=0; fi
          if [ -z "$UPDATED_WORKFLOW_COUNT" ]; then UPDATED_WORKFLOW_COUNT=0; fi
          if [ -z "$UPDATED_TOTAL_COUNT" ]; then UPDATED_TOTAL_COUNT=0; fi
          
          echo "Updated counts - Issue: $UPDATED_ISSUE_COUNT, Workflow: $UPDATED_WORKFLOW_COUNT, Total: $UPDATED_TOTAL_COUNT"
          
          # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
          QUEUE_MANAGER_ISSUE="1"
          
          echo "Preparing to update queue manager issue..."
          echo "UPDATED_QUEUE_DATA type: $(echo "$UPDATED_QUEUE_DATA" | jq -r 'type')"
          echo "UPDATED_QUEUE_DATA keys: $(echo "$UPDATED_QUEUE_DATA" | jq -r 'keys | join(",")')"
          
          # ç¡®å®šé”çŠ¶æ€æ˜¾ç¤º
          if [ "$CURRENT_BUILD" = "null" ] || [ "$CURRENT_BUILD" = "null" ]; then
            LOCK_STATUS="ç©ºé—² ğŸ”“"
            CURRENT_BUILD_DISPLAY="æ— "
            LOCK_HOLDER_DISPLAY="æ— "
          else
            LOCK_STATUS="å ç”¨ ğŸ”’"
            CURRENT_BUILD_DISPLAY="$CURRENT_BUILD"
            LOCK_HOLDER_DISPLAY="$LOCK_HOLDER"
          fi
          
          UPDATED_BODY="## æ„å»ºé˜Ÿåˆ—ç®¡ç†

          **æœ€åæ›´æ–°æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')

          ### å½“å‰çŠ¶æ€
          - **æ„å»ºé”çŠ¶æ€ï¼š** $LOCK_STATUS
          - **å½“å‰æ„å»ºï¼š** $CURRENT_BUILD_DISPLAY
          - **é”æŒæœ‰è€…ï¼š** $LOCK_HOLDER_DISPLAY

          ### Issueé˜Ÿåˆ— (æœ€å¤š3ä¸ª)
          - å½“å‰æ•°é‡ï¼š$UPDATED_ISSUE_COUNT/3

          ### Workflowé˜Ÿåˆ— (æœ€å¤š5ä¸ª)
          - å½“å‰æ•°é‡ï¼š$UPDATED_WORKFLOW_COUNT/5

          ### æ€»é˜Ÿåˆ— (æœ€å¤š5ä¸ª)
          - å½“å‰æ•°é‡ï¼š$UPDATED_TOTAL_COUNT/5

          ---

          ### é˜Ÿåˆ—æ•°æ®
          \`\`\`json
          $UPDATED_QUEUE_DATA
          \`\`\`"
          
          echo "Generated UPDATED_BODY, length: ${#UPDATED_BODY}"
          echo "About to update issue #$QUEUE_MANAGER_ISSUE..."
          
          # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE" \
            -d "$(jq -n --arg body "$UPDATED_BODY" '{"body": $body}')"
          
          echo "Issue update completed successfully"
          
          # è®¡ç®—é˜Ÿåˆ—ä½ç½® - ä¿®å¤ï¼šæ˜¾ç¤ºå½“å‰issueåœ¨é˜Ÿåˆ—ä¸­çš„ä½ç½®ï¼Œè€Œä¸æ˜¯æ€»æ•°é‡
          if [ "$TRIGGER_TYPE" = "issue" ]; then
            # è®¡ç®—å½“å‰issueåœ¨issueé˜Ÿåˆ—ä¸­çš„ä½ç½®
            QUEUE_POSITION=$(echo "$UPDATED_QUEUE_DATA" | \
              jq -r --arg issue_number "$CURRENT_ISSUE_NUMBER" \
              '.issue_queue | map(.issue_number) | index($issue_number) // 0 | . + 1')
            QUEUE_LIMIT=3
          else
            # è®¡ç®—å½“å‰issueåœ¨workflowé˜Ÿåˆ—ä¸­çš„ä½ç½®
            QUEUE_POSITION=$(echo "$UPDATED_QUEUE_DATA" | \
              jq -r --arg issue_number "$CURRENT_ISSUE_NUMBER" \
              '.workflow_queue | map(.issue_number) | index($issue_number) // 0 | . + 1')
            QUEUE_LIMIT=5
          fi
          echo "QUEUE_POSITION=$QUEUE_POSITION" >> $GITHUB_ENV
          
          echo "Preparing queue join comment..."
          echo "Using UPDATED_TOTAL_COUNT: $UPDATED_TOTAL_COUNT"
          echo "Calculated QUEUE_POSITION: $QUEUE_POSITION"
          
          # æ·»åŠ é˜Ÿåˆ—åŠ å…¥è¯„è®º
          QUEUE_JOIN_COMMENT="## å·²åŠ å…¥é˜Ÿåˆ—

          **é˜Ÿåˆ—ä½ç½®ï¼š** $QUEUE_POSITION/$QUEUE_LIMIT ($TRIGGER_TYPEé˜Ÿåˆ—)
          **é¢„è®¡ç­‰å¾…æ—¶é—´ï¼š** çº¦$((UPDATED_TOTAL_COUNT * 30))åˆ†é’Ÿ
          **çŠ¶æ€ï¼š** ç­‰å¾…ä¸­ â³

          **å½“å‰é˜Ÿåˆ—çŠ¶æ€ï¼š**
          - Issueé˜Ÿåˆ—ï¼š$UPDATED_ISSUE_COUNT/3
          - Workflowé˜Ÿåˆ—ï¼š$UPDATED_WORKFLOW_COUNT/5
          - æ€»é˜Ÿåˆ—ï¼š$UPDATED_TOTAL_COUNT/5

          **æ„å»ºé”çŠ¶æ€ï¼š** $LOCK_STATUS

          **é˜Ÿåˆ—ä¿¡æ¯ï¼š**
          - åŠ å…¥æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')
          - è§¦å‘æ–¹å¼ï¼š$TRIGGER_TYPE
          - é˜Ÿåˆ—ç®¡ç†ï¼šIssue #$QUEUE_MANAGER_ISSUE"
          
          echo "Generated QUEUE_JOIN_COMMENT, length: ${#QUEUE_JOIN_COMMENT}"
          echo "About to post comment..."
          
          echo -e "$QUEUE_JOIN_COMMENT" | jq -Rs '{body: .}' | \
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d @-
          
          echo "Comment posted successfully"
          
          # éªŒè¯é˜Ÿåˆ—æ›´æ–°æ˜¯å¦æˆåŠŸ
          echo "Verifying queue update..."
          sleep 5  # ç­‰å¾…APIæ›´æ–°
          
          VERIFY_CONTENT=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE")
          
          VERIFY_QUEUE_DATA=$(echo "$VERIFY_CONTENT" | jq -r '.body' | grep -oP '```json\K.*?(?=```)' | head -1)
          echo "Verified queue data: $VERIFY_QUEUE_DATA"
          
          VERIFY_ISSUE_COUNT=$(echo "$VERIFY_QUEUE_DATA" | jq '.issue_queue | length')
          VERIFY_WORKFLOW_COUNT=$(echo "$VERIFY_QUEUE_DATA" | jq '.workflow_queue | length')
          echo "Verified counts - Issue: $VERIFY_ISSUE_COUNT, Workflow: $VERIFY_WORKFLOW_COUNT"
          
          # æ£€æŸ¥å½“å‰issueæ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­
          ISSUE_IN_VERIFIED_QUEUE=$(echo "$VERIFY_QUEUE_DATA" | \
            jq -r --arg issue_number "$CURRENT_ISSUE_NUMBER" \
            '.issue_queue | map(.issue_number) | contains([$issue_number])')
          echo "Issue in verified queue: $ISSUE_IN_VERIFIED_QUEUE"

      - name: Wait in queue
        if: env.QUEUE_FULL == 'false'
        run: |
          # ç­‰å¾…è½®åˆ°è‡ªå·±çš„ä½ç½®å¹¶è·å–æ„å»ºé”
          echo "Waiting in queue and for build lock..."
          
          START_TIME=$(date +%s)
          TIMEOUT=21600  # 6å°æ—¶è¶…æ—¶
          
          while [ $(($(date +%s) - START_TIME)) -lt $TIMEOUT ]; do
            echo "Checking queue position and lock status... ($(($(date +%s) - START_TIME))s elapsed)"
            
            # é‡æ–°è·å–é˜Ÿåˆ—ç®¡ç†issueçš„å†…å®¹
            QUEUE_MANAGER_ISSUE="1"
            QUEUE_MANAGER_CONTENT=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE")
            
            # è§£æå½“å‰é˜Ÿåˆ—æ•°æ®
            CURRENT_QUEUE_DATA=$(echo "$QUEUE_MANAGER_CONTENT" | jq -r '.body' | grep -oP '```json\K.*?(?=```)' | head -1)
            
            # éªŒè¯JSONæ ¼å¼
            if ! echo "$CURRENT_QUEUE_DATA" | jq . > /dev/null 2>&1; then
              echo "Invalid JSON format in queue data, attempting to extract..."
              # å°è¯•å…¶ä»–æå–æ–¹æ³•
              CURRENT_QUEUE_DATA=$(echo "$QUEUE_MANAGER_CONTENT" | jq -r '.body' | sed -n '/```json/,/```/p' | grep -v '```' | head -1)
              if ! echo "$CURRENT_QUEUE_DATA" | jq . > /dev/null 2>&1; then
                echo "Failed to extract valid JSON, using fallback..."
                CURRENT_QUEUE_DATA='{"issue_queue":[],"workflow_queue":[],"current_build":null,"lock_holder":null,"run_id":null}'
              fi
            fi
            
            # éªŒè¯å¿…è¦å­—æ®µ
            REQUIRED_FIELDS=("issue_queue" "workflow_queue" "current_build" "lock_holder" "run_id")
            for field in "${REQUIRED_FIELDS[@]}"; do
              if ! echo "$CURRENT_QUEUE_DATA" | jq -e ".$field" > /dev/null 2>&1; then
                echo "âŒ Missing required field: $field, resetting queue data"
                CURRENT_QUEUE_DATA='{"issue_queue":[],"workflow_queue":[],"current_build":null,"lock_holder":null,"run_id":null}'
                break
              fi
            done
            
            # è°ƒè¯•è¾“å‡º
            echo "Current queue data: $CURRENT_QUEUE_DATA"
            echo "Current issue number: ${{ github.event.issue.number }}"
            echo "Trigger type: $TRIGGER_TYPE"
            
            # è·å–å½“å‰é˜Ÿåˆ—çŠ¶æ€ - ä½¿ç”¨å®‰å…¨çš„é»˜è®¤å€¼
            CURRENT_ISSUE_COUNT=$(echo "$CURRENT_QUEUE_DATA" | jq '.issue_queue | length // 0')
            CURRENT_WORKFLOW_COUNT=$(echo "$CURRENT_QUEUE_DATA" | jq '.workflow_queue | length // 0')
            CURRENT_TOTAL_COUNT=$((CURRENT_ISSUE_COUNT + CURRENT_WORKFLOW_COUNT))
            CURRENT_BUILD=$(echo "$CURRENT_QUEUE_DATA" | jq -r '.current_build // null')
            LOCK_HOLDER=$(echo "$CURRENT_QUEUE_DATA" | jq -r '.lock_holder // null')
            
            # è‡ªåŠ¨ä¿®å¤å¼‚å¸¸çŠ¶æ€
            if [ "$CURRENT_ISSUE_COUNT" = "" ] || [ "$CURRENT_WORKFLOW_COUNT" = "" ]; then
              echo "âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸çŠ¶æ€ï¼Œè‡ªåŠ¨ä¿®å¤..."
              CURRENT_QUEUE_DATA='{"issue_queue":[],"workflow_queue":[],"current_build":null,"lock_holder":null,"run_id":null}'
              CURRENT_ISSUE_COUNT=0
              CURRENT_WORKFLOW_COUNT=0
              CURRENT_TOTAL_COUNT=0
              CURRENT_BUILD=null
              LOCK_HOLDER=null
              
              # æ›´æ–°Issue #1
              REPAIR_BODY="## æ„å»ºé˜Ÿåˆ—ç®¡ç†

              **æœ€åæ›´æ–°æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')

              ### å½“å‰çŠ¶æ€
              - **æ„å»ºé”çŠ¶æ€ï¼š** ç©ºé—² ğŸ”“ (è‡ªåŠ¨ä¿®å¤)
              - **å½“å‰æ„å»ºï¼š** æ— 
              - **é”æŒæœ‰è€…ï¼š** æ— 
              - **è¿è¡ŒIDï¼š** æ— 

              ### Issueé˜Ÿåˆ— (æœ€å¤š3ä¸ª)
              - å½“å‰æ•°é‡ï¼š0/3

              ### Workflowé˜Ÿåˆ— (æœ€å¤š5ä¸ª)
              - å½“å‰æ•°é‡ï¼š0/5

              ### æ€»é˜Ÿåˆ— (æœ€å¤š5ä¸ª)
              - å½“å‰æ•°é‡ï¼š0/5

              ---

              ### è‡ªåŠ¨ä¿®å¤è®°å½•
              **ä¿®å¤æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
              **ä¿®å¤åŸå› ï¼š** æ£€æµ‹åˆ°é˜Ÿåˆ—æ•°æ®å¼‚å¸¸ï¼Œè‡ªåŠ¨é‡ç½®
              **ä¿®å¤æ“ä½œï¼š** æ¸…ç©ºé˜Ÿåˆ—ï¼Œé‡Šæ”¾é”ï¼Œé‡ç½®çŠ¶æ€

              ### é˜Ÿåˆ—æ•°æ®
              \`\`\`json
              $CURRENT_QUEUE_DATA
              \`\`\`"
              
              curl -X PATCH \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Content-Type: application/json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/1" \
                -d "$(jq -n --arg body "$REPAIR_BODY" '{"body": $body}')"
              
              echo "âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆ"
            fi
            
            # éªŒè¯é˜Ÿåˆ—æ•°æ®å®Œæ•´æ€§
            echo "Validating queue data integrity..."
            VALID_ISSUE_COUNT=$(echo "$CURRENT_QUEUE_DATA" | jq '.issue_queue | length // 0')
            VALID_WORKFLOW_COUNT=$(echo "$CURRENT_QUEUE_DATA" | jq '.workflow_queue | length // 0')
            
            if [ "$VALID_ISSUE_COUNT" != "$CURRENT_ISSUE_COUNT" ] || [ "$VALID_WORKFLOW_COUNT" != "$CURRENT_WORKFLOW_COUNT" ]; then
              echo "âš ï¸ é˜Ÿåˆ—æ•°æ®ä¸ä¸€è‡´ï¼Œä½¿ç”¨éªŒè¯åçš„æ•°æ®"
              CURRENT_ISSUE_COUNT=$VALID_ISSUE_COUNT
              CURRENT_WORKFLOW_COUNT=$VALID_WORKFLOW_COUNT
              CURRENT_TOTAL_COUNT=$((CURRENT_ISSUE_COUNT + CURRENT_WORKFLOW_COUNT))
            fi
            
            echo "Current counts - Issue: $CURRENT_ISSUE_COUNT, Workflow: $CURRENT_WORKFLOW_COUNT, Total: $CURRENT_TOTAL_COUNT"
            echo "Current build: $CURRENT_BUILD"
            echo "Lock holder: $LOCK_HOLDER"
            
            # æ£€æŸ¥å½“å‰issueæ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­
            if [ "$TRIGGER_TYPE" = "issue" ]; then
              ISSUE_IN_QUEUE=$(echo "$CURRENT_QUEUE_DATA" | \
                jq -r --arg issue_number "${{ github.event.issue.number }}" \
                '.issue_queue | map(.issue_number) | contains([$issue_number])')
              CURRENT_POSITION=$(echo "$CURRENT_QUEUE_DATA" | \
                jq -r --arg issue_number "${{ github.event.issue.number }}" \
                '.issue_queue | map(.issue_number) | index($issue_number) // empty | . + 1')
              QUEUE_LIMIT=3
            else
              ISSUE_IN_QUEUE=$(echo "$CURRENT_QUEUE_DATA" | \
                jq -r --arg issue_number "${{ github.event.issue.number }}" \
                '.workflow_queue | map(.issue_number) | contains([$issue_number])')
              CURRENT_POSITION=$(echo "$CURRENT_QUEUE_DATA" | \
                jq -r --arg issue_number "${{ github.event.issue.number }}" \
                '.workflow_queue | map(.issue_number) | index($issue_number) // empty | . + 1')
              QUEUE_LIMIT=5
            fi
            
            echo "Issue in queue: $ISSUE_IN_QUEUE"
            echo "Calculated position: '$CURRENT_POSITION'"
            
            # å¦‚æœissueä¸åœ¨é˜Ÿåˆ—ä¸­ï¼Œç›´æ¥è¿›å…¥æ„å»º
            if [ "$ISSUE_IN_QUEUE" != "true" ]; then
              echo "Issue not found in queue, proceeding to build..."
              break
            fi
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯é¦–ä½
            if [ "$CURRENT_POSITION" != "1" ]; then
              echo "Not at front of queue (position: $CURRENT_POSITION), waiting..."
              sleep 30
              continue
            fi
            
            # æ£€æŸ¥æ„å»ºé”æ˜¯å¦å¯ç”¨
            if [ "$CURRENT_BUILD" != "null" ] && [ "$CURRENT_BUILD" != "null" ]; then
              # æ£€æŸ¥run_idæ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…è¯´æ˜æ˜¯æœ¬æµç¨‹æŒæœ‰é”ï¼Œå¯ä»¥ç›´æ¥ç»§ç»­
              LOCK_RUN_ID=$(echo "$CURRENT_QUEUE_DATA" | jq -r '.run_id // empty')
              if [ "$LOCK_RUN_ID" = "${{ github.run_id }}" ]; then
                echo "Lock is held by current run ($LOCK_RUN_ID), proceeding to build..."
                break
              else
                echo "Build lock is held by: $LOCK_HOLDER (build: $CURRENT_BUILD, run_id: $LOCK_RUN_ID), waiting for lock..."
                sleep 30
                continue
              fi
            fi
            
            # å¦‚æœåˆ°è¾¾é¦–ä½ä¸”é”å¯ç”¨ï¼Œå°è¯•è·å–é”
            echo "At front of queue and lock is available, attempting to acquire lock..."
            
            # å°è¯•è·å–æ„å»ºé” - ä½¿ç”¨åŸå­æ“ä½œé˜²æ­¢ç«æ€æ¡ä»¶
            LOCK_ACQUIRED=false
            MAX_RETRIES=10
            RETRY_COUNT=0
            
            while [ "$RETRY_COUNT" -lt "$MAX_RETRIES" ] && [ "$LOCK_ACQUIRED" = false ]; do
              echo "Attempting to acquire lock (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
              
              # é‡æ–°è·å–æœ€æ–°é˜Ÿåˆ—æ•°æ®
              LATEST_CONTENT=$(curl -s \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE")
              
              LATEST_QUEUE_DATA=$(echo "$LATEST_CONTENT" | jq -r '.body' | grep -oP '```json\K.*?(?=```)' | head -1)
              LATEST_BUILD=$(echo "$LATEST_QUEUE_DATA" | jq -r '.current_build // null')
              LATEST_LOCK_HOLDER=$(echo "$LATEST_QUEUE_DATA" | jq -r '.lock_holder // null')
              
              echo "Latest build: $LATEST_BUILD, Latest lock holder: $LATEST_LOCK_HOLDER"
              
              # å†æ¬¡æ£€æŸ¥é”æ˜¯å¦ä»ç„¶å¯ç”¨
              if [ "$LATEST_BUILD" = "null" ] || [ "$LATEST_BUILD" = "null" ]; then
                # éªŒè¯åŸå§‹é˜Ÿåˆ—æ•°æ®å®Œæ•´æ€§
                echo "Validating original queue data before lock acquisition..."
                ORIGINAL_ISSUE_COUNT=$(echo "$LATEST_QUEUE_DATA" | jq '.issue_queue | length // 0')
                ORIGINAL_WORKFLOW_COUNT=$(echo "$LATEST_QUEUE_DATA" | jq '.workflow_queue | length // 0')
                echo "Original counts - Issue: $ORIGINAL_ISSUE_COUNT, Workflow: $ORIGINAL_WORKFLOW_COUNT"
                
                # è·å–é” - ä½¿ç”¨åŸå­æ“ä½œï¼Œä¿æŒåŸæœ‰é˜Ÿåˆ—æ•°æ®ï¼ŒåŠ å…¥run_idé˜²æ­¢å¹¶å‘
                UPDATED_QUEUE_DATA=$(echo "$LATEST_QUEUE_DATA" | \
                  jq --arg issue_number "${{ github.event.issue.number }}" \
                  --arg user "${{ github.actor }}" \
                  --arg run_id "${{ github.run_id }}" \
                  '.current_build = $issue_number | .lock_holder = $user | .run_id = $run_id')
                
                # éªŒè¯é˜Ÿåˆ—æ•°æ®å®Œæ•´æ€§
                echo "Updated queue data: $UPDATED_QUEUE_DATA"
                UPDATED_ISSUE_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.issue_queue | length // 0')
                UPDATED_WORKFLOW_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.workflow_queue | length // 0')
                UPDATED_TOTAL_COUNT=$((UPDATED_ISSUE_COUNT + UPDATED_WORKFLOW_COUNT))
                
                # ç¡®ä¿æ•°é‡ä¸ä¸ºç©º
                if [ -z "$UPDATED_ISSUE_COUNT" ]; then UPDATED_ISSUE_COUNT=0; fi
                if [ -z "$UPDATED_WORKFLOW_COUNT" ]; then UPDATED_WORKFLOW_COUNT=0; fi
                if [ -z "$UPDATED_TOTAL_COUNT" ]; then UPDATED_TOTAL_COUNT=0; fi
                
                echo "Updated counts - Issue: $UPDATED_ISSUE_COUNT, Workflow: $UPDATED_WORKFLOW_COUNT, Total: $UPDATED_TOTAL_COUNT"
                
                # éªŒè¯é˜Ÿåˆ—æ•°æ®æ²¡æœ‰è¢«æ¸…ç©º
                if [ "$UPDATED_ISSUE_COUNT" != "$ORIGINAL_ISSUE_COUNT" ] || [ "$UPDATED_WORKFLOW_COUNT" != "$ORIGINAL_WORKFLOW_COUNT" ]; then
                  echo "âŒ é˜Ÿåˆ—æ•°æ®åœ¨é”è·å–è¿‡ç¨‹ä¸­è¢«æ¸…ç©ºï¼Œå›æ»šæ“ä½œ"
                  echo "Original: Issue=$ORIGINAL_ISSUE_COUNT, Workflow=$ORIGINAL_WORKFLOW_COUNT"
                  echo "Updated: Issue=$UPDATED_ISSUE_COUNT, Workflow=$UPDATED_WORKFLOW_COUNT"
                  LOCK_ACQUIRED=false
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  sleep 10
                  continue
                fi
                
                # ç¡®ä¿é˜Ÿåˆ—æ•°é‡æ˜¾ç¤ºæ­£ç¡®
                if [ "$UPDATED_ISSUE_COUNT" = "" ] || [ "$UPDATED_WORKFLOW_COUNT" = "" ]; then
                  echo "âŒ é˜Ÿåˆ—æ•°é‡è®¡ç®—å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼"
                  UPDATED_ISSUE_COUNT=0
                  UPDATED_WORKFLOW_COUNT=0
                  UPDATED_TOTAL_COUNT=0
                fi
                
                # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
                UPDATED_BODY="## æ„å»ºé˜Ÿåˆ—ç®¡ç†

                **æœ€åæ›´æ–°æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')

                ### å½“å‰çŠ¶æ€
                - **æ„å»ºé”çŠ¶æ€ï¼š** å ç”¨ ğŸ”’
                - **å½“å‰æ„å»ºï¼š** ${{ github.event.issue.number }}
                - **é”æŒæœ‰è€…ï¼š** ${{ github.actor }}
                - **è¿è¡ŒIDï¼š** ${{ github.run_id }}

                ### Issueé˜Ÿåˆ— (æœ€å¤š3ä¸ª)
                - å½“å‰æ•°é‡ï¼š$UPDATED_ISSUE_COUNT/3

                ### Workflowé˜Ÿåˆ— (æœ€å¤š5ä¸ª)
                - å½“å‰æ•°é‡ï¼š$UPDATED_WORKFLOW_COUNT/5

                ### æ€»é˜Ÿåˆ— (æœ€å¤š5ä¸ª)
                - å½“å‰æ•°é‡ï¼š$UPDATED_TOTAL_COUNT/5

                ---

                ### é˜Ÿåˆ—æ•°æ®
                \`\`\`json
                $UPDATED_QUEUE_DATA
                \`\`\`"
                
                # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
                UPDATE_RESPONSE=$(curl -s -X PATCH \
                  -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "Content-Type: application/json" \
                  "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE" \
                  -d "$(jq -n --arg body "$UPDATED_BODY" '{"body": $body}')")
                
                # éªŒè¯æ›´æ–°æ˜¯å¦æˆåŠŸ
                if echo "$UPDATE_RESPONSE" | jq -e '.id' > /dev/null 2>&1; then
                  echo "Build lock acquired successfully!"
                  LOCK_ACQUIRED=true
                  
                  # éªŒè¯é”æ˜¯å¦çœŸçš„è¢«æˆ‘ä»¬è·å–
                  sleep 2  # ç­‰å¾…APIæ›´æ–°
                  VERIFY_CONTENT=$(curl -s \
                    -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE")
                  
                  VERIFY_QUEUE_DATA=$(echo "$VERIFY_CONTENT" | jq -r '.body' | grep -oP '```json\K.*?(?=```)' | head -1)
                  VERIFY_BUILD=$(echo "$VERIFY_QUEUE_DATA" | jq -r '.current_build // null')
                  VERIFY_HOLDER=$(echo "$VERIFY_QUEUE_DATA" | jq -r '.lock_holder // null')
                  VERIFY_RUN_ID=$(echo "$VERIFY_QUEUE_DATA" | jq -r '.run_id // empty')
                  VERIFY_ISSUE_COUNT=$(echo "$VERIFY_QUEUE_DATA" | jq '.issue_queue | length // 0')
                  VERIFY_WORKFLOW_COUNT=$(echo "$VERIFY_QUEUE_DATA" | jq '.workflow_queue | length // 0')
                  
                  echo "Verification - Build: $VERIFY_BUILD, Holder: $VERIFY_HOLDER, Run ID: $VERIFY_RUN_ID"
                  echo "Verification - Issue count: $VERIFY_ISSUE_COUNT, Workflow count: $VERIFY_WORKFLOW_COUNT"
                  
                  # éªŒè¯é”å’Œæ•°æ®å®Œæ•´æ€§
                  if [ "$VERIFY_BUILD" = "${{ github.event.issue.number }}" ] && [ "$VERIFY_HOLDER" = "${{ github.actor }}" ] && [ "$VERIFY_RUN_ID" = "${{ github.run_id }}" ]; then
                    if [ "$VERIFY_ISSUE_COUNT" = "$UPDATED_ISSUE_COUNT" ] && [ "$VERIFY_WORKFLOW_COUNT" = "$UPDATED_WORKFLOW_COUNT" ]; then
                      echo "Lock acquisition and data integrity verified successfully!"
                      break
                    else
                      echo "âŒ æ•°æ®å®Œæ•´æ€§éªŒè¯å¤±è´¥ï¼Œé˜Ÿåˆ—æ•°æ®ä¸¢å¤±"
                      echo "Expected: Issue=$UPDATED_ISSUE_COUNT, Workflow=$UPDATED_WORKFLOW_COUNT"
                      echo "Actual: Issue=$VERIFY_ISSUE_COUNT, Workflow=$VERIFY_WORKFLOW_COUNT"
                      LOCK_ACQUIRED=false
                    fi
                  else
                    echo "Lock acquisition verification failed, retrying..."
                    LOCK_ACQUIRED=false
                  fi
                else
                  echo "Failed to update issue, retrying..."
                  LOCK_ACQUIRED=false
                fi
              else
                echo "Lock was taken by another process (build: $LATEST_BUILD, holder: $LATEST_LOCK_HOLDER), retrying..."
                LOCK_ACQUIRED=false
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ "$LOCK_ACQUIRED" = false ] && [ "$RETRY_COUNT" -lt "$MAX_RETRIES" ]; then
                echo "Waiting before retry..."
                sleep 10
              fi
            done
            
            if [ "$LOCK_ACQUIRED" = true ]; then
              echo "Lock acquired, proceeding to build!"
              break
            else
              echo "Failed to acquire lock after $MAX_RETRIES attempts, continuing to wait..."
              sleep 30
              continue
            fi
          done
          
          if [ $(($(date +%s) - START_TIME)) -ge $TIMEOUT ]; then
            echo "Queue timeout after 6 hours"
            # æ·»åŠ è¶…æ—¶è¯„è®º
            TIMEOUT_COMMENT="## â° é˜Ÿåˆ—ç­‰å¾…è¶…æ—¶

            **çŠ¶æ€ï¼š** é˜Ÿåˆ—ç­‰å¾…è¶…æ—¶ï¼ˆ6å°æ—¶ï¼‰
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            æ„å»ºå°†è‡ªåŠ¨ç»ˆæ­¢ã€‚å¦‚éœ€é‡æ–°æ„å»ºï¼Œè¯·é‡æ–°æäº¤issueã€‚"
            
            echo -e "$TIMEOUT_COMMENT" | jq -Rs '{body: .}' | \
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
                -d @-
            
            exit 1
          fi

      - name: Leave queue
        if: env.QUEUE_FULL == 'false'
        run: |
          # ç¦»å¼€é˜Ÿåˆ—ï¼Œå¼€å§‹æ„å»º
          echo "Leaving queue to start build..."
          
          # ä»é˜Ÿåˆ—ç®¡ç†issueä¸­ç§»é™¤å½“å‰issue
          QUEUE_MANAGER_ISSUE="1"
          QUEUE_MANAGER_CONTENT=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE")
          
          # è§£æå½“å‰é˜Ÿåˆ—æ•°æ®
          CURRENT_QUEUE_DATA=$(echo "$QUEUE_MANAGER_CONTENT" | jq -r '.body' | grep -oP '```json\K.*?(?=```)' | head -1)
          
          # ä»å¯¹åº”é˜Ÿåˆ—ä¸­ç§»é™¤å½“å‰issue
          if [ "$TRIGGER_TYPE" = "issue" ]; then
            UPDATED_QUEUE_DATA=$(echo "$CURRENT_QUEUE_DATA" | \
              jq --arg issue_number "${{ github.event.issue.number }}" \
              '.issue_queue = (.issue_queue | map(select(.issue_number != $issue_number)))')
          else
            UPDATED_QUEUE_DATA=$(echo "$CURRENT_QUEUE_DATA" | \
              jq --arg issue_number "${{ github.event.issue.number }}" \
              '.workflow_queue = (.workflow_queue | map(select(.issue_number != $issue_number)))')
          fi
          
          # è®¡ç®—æ›´æ–°åçš„é˜Ÿåˆ—æ•°é‡
          UPDATED_ISSUE_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.issue_queue | length')
          UPDATED_WORKFLOW_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.workflow_queue | length')
          UPDATED_TOTAL_COUNT=$((UPDATED_ISSUE_COUNT + UPDATED_WORKFLOW_COUNT))
          
          echo "Updated counts after leaving - Issue: $UPDATED_ISSUE_COUNT, Workflow: $UPDATED_WORKFLOW_COUNT, Total: $UPDATED_TOTAL_COUNT"
          
          # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
          UPDATED_BODY="## æ„å»ºé˜Ÿåˆ—ç®¡ç†

          **æœ€åæ›´æ–°æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')

          ### å½“å‰çŠ¶æ€
          - **æ„å»ºé”çŠ¶æ€ï¼š** å ç”¨ ğŸ”’
          - **å½“å‰æ„å»ºï¼š** ${{ github.event.issue.number }}
          - **é”æŒæœ‰è€…ï¼š** ${{ github.actor }}

          ### Issueé˜Ÿåˆ— (æœ€å¤š3ä¸ª)
          - å½“å‰æ•°é‡ï¼š$UPDATED_ISSUE_COUNT/3

          ### Workflowé˜Ÿåˆ— (æœ€å¤š5ä¸ª)
          - å½“å‰æ•°é‡ï¼š$UPDATED_WORKFLOW_COUNT/5

          ### æ€»é˜Ÿåˆ— (æœ€å¤š5ä¸ª)
          - å½“å‰æ•°é‡ï¼š$UPDATED_TOTAL_COUNT/5

          ---

          ### é˜Ÿåˆ—æ•°æ®
          \`\`\`json
          $UPDATED_QUEUE_DATA
          \`\`\`"
          
          # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE" \
            -d "$(jq -n --arg body "$UPDATED_BODY" '{"body": $body}')"
          
          # æ·»åŠ å¼€å§‹æ„å»ºè¯„è®º
          BUILD_START_COMMENT="## ğŸš€ å¼€å§‹æ„å»º

          **çŠ¶æ€ï¼š** æ„å»ºå·²å¼€å§‹
          **æ„å»ºé”ï¼š** å·²è·å– ğŸ”’
          **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
          æ„å»ºè¿‡ç¨‹æ­£åœ¨è¿›è¡Œä¸­..."

          echo -e "$BUILD_START_COMMENT" | jq -Rs '{body: .}' | \
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d @-

      - name: Process data
        if: env.QUEUE_FULL == 'false'
        id: process
        run: |
          # å¤„ç†æ•°æ®ï¼ˆæ·»åŠ é˜Ÿåˆ—ä¿¡æ¯ï¼‰
          CURRENT_DATA='${{ env.CURRENT_DATA }}'
          
          # éªŒè¯JSONæ ¼å¼
          echo "Validating input JSON..."
          echo "$CURRENT_DATA" | jq . > /dev/null
          echo "Input JSON validation passed"
          
          # ä½¿ç”¨jqå¤„ç†JSONï¼Œæ·»åŠ é˜Ÿåˆ—ä¿¡æ¯
          PROCESSED=$(echo "$CURRENT_DATA" | jq -c \
            --arg queue_time "$(date -Iseconds)" \
            --arg queue_position "$QUEUE_POSITION" \
            --arg trigger_type "$TRIGGER_TYPE" \
            '. + {queued: true, queue_time: $queue_time, queue_position: $queue_position, trigger_type: $trigger_type}')
          
          # éªŒè¯å¤„ç†åçš„JSONæ ¼å¼
          echo "Validating processed JSON..."
          echo "$PROCESSED" | jq . > /dev/null
          echo "Processed JSON validation passed"
          
          echo "CURRENT_DATA=$PROCESSED" >> $GITHUB_ENV

      - name: Output data
        if: env.QUEUE_FULL == 'false'
        id: output
        run: |
          # è¾“å‡ºå¤„ç†åçš„æ•°æ®
          OUTPUT_DATA='${{ env.CURRENT_DATA }}'
          
          # éªŒè¯è¾“å‡ºJSONæ ¼å¼
          echo "Validating output JSON format..."
          echo "$OUTPUT_DATA" | jq . > /dev/null
          echo "Output JSON validation passed"
          
          echo "data=$OUTPUT_DATA" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºè¾“å‡ºä¿¡æ¯
          echo "Queue output: $OUTPUT_DATA"

  build: # æ„å»ºé˜¶æ®µ
    needs: queue
    runs-on: ubuntu-latest
    if: needs.queue.outputs.queue_output != null
    outputs:
      build_output: ${{ toJson(steps.output.outputs.data) }}
    steps:
      - name: Extract data
        id: extract
        run: |
          # ä»…æå–æ•°æ®ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†
          INPUT='${{ fromJson(needs.queue.outputs.queue_output) }}'
          
          # éªŒè¯è¾“å…¥JSONæ ¼å¼
          echo "Validating input JSON format..."
          echo "$INPUT" | jq . > /dev/null
          echo "Input JSON validation passed"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CURRENT_DATA=$INPUT" >> $GITHUB_ENV

      - name: Pause for 5 minutes (for queue test)
        run: |
          echo "Pausing for 5 minutes to test queue..."
          sleep 300

      - name: Process data
        id: process
        run: |
          # å¤„ç†æ•°æ®ï¼ˆæ·»åŠ æ„å»ºçŠ¶æ€ï¼‰
          # ä»ç¯å¢ƒå˜é‡ä¸­å®‰å…¨åœ°æå–JSONæ•°æ®
          CURRENT_DATA='${{ env.CURRENT_DATA }}'
          
          # éªŒè¯JSONæ ¼å¼
          echo "Validating input JSON..."
          echo "$CURRENT_DATA" | jq . > /dev/null
          echo "Input JSON validation passed"
          
          # ä½¿ç”¨jqå¤„ç†JSONï¼Œæ·»åŠ æ„å»ºçŠ¶æ€
          PROCESSED=$(echo "$CURRENT_DATA" | jq -c --arg build_time "$(date -Iseconds)" '. + {built: true, build_time: $build_time}')
          
          # éªŒè¯å¤„ç†åçš„JSONæ ¼å¼
          echo "Validating processed JSON..."
          echo "$PROCESSED" | jq . > /dev/null
          echo "Processed JSON validation passed"
          
          echo "CURRENT_DATA=$PROCESSED" >> $GITHUB_ENV

      - name: Output data
        id: output
        run: |
          # ç›´æ¥ä½¿ç”¨Processæ­¥éª¤å¤„ç†åçš„æ•°æ®
          OUTPUT_DATA='${{ env.CURRENT_DATA }}'
          
          # éªŒè¯è¾“å‡ºJSONæ ¼å¼
          echo "Validating output JSON format..."
          echo "$OUTPUT_DATA" | jq . > /dev/null
          echo "Output JSON validation passed"
          
          echo "data=$OUTPUT_DATA" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºè¾“å‡ºä¿¡æ¯
          echo "Build output: $OUTPUT_DATA"

  finish: # æ”¶å°¾é˜¶æ®µ
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.build_output != null
    steps:
      - name: Parse input
        run: |
          # æ­£ç¡®è·å–è¾“å…¥æ•°æ®
          INPUT='${{ fromJson(needs.build.outputs.build_output) }}'
          echo "FINAL_INPUT=$INPUT" >> $GITHUB_ENV

      - name: Release build lock
        run: |
          # é‡Šæ”¾æ„å»ºé”
          echo "Releasing build lock..."
          
          QUEUE_MANAGER_ISSUE="1"
          QUEUE_MANAGER_CONTENT=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE")
          
          # è§£æå½“å‰é˜Ÿåˆ—æ•°æ®
          CURRENT_QUEUE_DATA=$(echo "$QUEUE_MANAGER_CONTENT" | jq -r '.body' | grep -oP '```json\K.*?(?=```)' | head -1)
          
          # æ£€æŸ¥run_idæ˜¯å¦åŒ¹é…ï¼Œåªæœ‰é”æŒæœ‰è€…æ‰èƒ½é‡Šæ”¾é”
          LOCK_RUN_ID=$(echo "$CURRENT_QUEUE_DATA" | jq -r '.run_id // empty')
          if [ "$LOCK_RUN_ID" = "${{ github.run_id }}" ]; then
            echo "Lock run_id matches current run, proceeding to release lock"
            # é‡Šæ”¾é”
            UPDATED_QUEUE_DATA=$(echo "$CURRENT_QUEUE_DATA" | \
              jq '.current_build = null | .lock_holder = null | .run_id = null')
          else
            echo "Not lock owner, cannot release or continue. Lock run_id: $LOCK_RUN_ID, current: ${{ github.run_id }}"
            exit 0
          fi
          
          # è®¡ç®—é˜Ÿåˆ—æ•°é‡ - ä½¿ç”¨å®‰å…¨çš„é»˜è®¤å€¼
          UPDATED_ISSUE_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.issue_queue | length // 0')
          UPDATED_WORKFLOW_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.workflow_queue | length // 0')
          UPDATED_TOTAL_COUNT=$((UPDATED_ISSUE_COUNT + UPDATED_WORKFLOW_COUNT))
          
          # ç¡®ä¿æ•°é‡ä¸ä¸ºç©º
          if [ -z "$UPDATED_ISSUE_COUNT" ]; then UPDATED_ISSUE_COUNT=0; fi
          if [ -z "$UPDATED_WORKFLOW_COUNT" ]; then UPDATED_WORKFLOW_COUNT=0; fi
          if [ -z "$UPDATED_TOTAL_COUNT" ]; then UPDATED_TOTAL_COUNT=0; fi
          
          # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
          UPDATED_BODY="## æ„å»ºé˜Ÿåˆ—ç®¡ç†

          **æœ€åæ›´æ–°æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')

          ### å½“å‰çŠ¶æ€
          - **æ„å»ºé”çŠ¶æ€ï¼š** ç©ºé—² ğŸ”“
          - **å½“å‰æ„å»ºï¼š** æ— 
          - **é”æŒæœ‰è€…ï¼š** æ— 
          - **è¿è¡ŒIDï¼š** æ— 

          ### Issueé˜Ÿåˆ— (æœ€å¤š3ä¸ª)
          - å½“å‰æ•°é‡ï¼š$UPDATED_ISSUE_COUNT/3

          ### Workflowé˜Ÿåˆ— (æœ€å¤š5ä¸ª)
          - å½“å‰æ•°é‡ï¼š$UPDATED_WORKFLOW_COUNT/5

          ### æ€»é˜Ÿåˆ— (æœ€å¤š5ä¸ª)
          - å½“å‰æ•°é‡ï¼š$UPDATED_TOTAL_COUNT/5

          ---

          ### é˜Ÿåˆ—æ•°æ®
          \`\`\`json
          $UPDATED_QUEUE_DATA
          \`\`\`"
          
          # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$QUEUE_MANAGER_ISSUE" \
            -d "$(jq -n --arg body "$UPDATED_BODY" '{"body": $body}')"
          
          echo "Build lock released successfully!"

      - name: Final processing
        run: |
          # ä½¿ç”¨jqè§£æå•è¡ŒJSON
          echo "Final data: $FINAL_INPUT"
          echo "Ready status: $(jq -r '.ready' <<< "$FINAL_INPUT")"
          echo "Version: $(jq -r '.version' <<< "$FINAL_INPUT")"

      - name: Generate report
        run: |
          echo "Build completed successfully"
          
          # æ·»åŠ æ„å»ºå®Œæˆè¯„è®º
          COMPLETION_COMMENT="## âœ… æ„å»ºå®Œæˆ

          **çŠ¶æ€ï¼š** æ„å»ºå·²å®Œæˆ
          **æ„å»ºé”ï¼š** å·²é‡Šæ”¾ ğŸ”“
          **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
          ä¸‹ä¸€ä¸ªé˜Ÿåˆ—é¡¹ç›®å¯ä»¥å¼€å§‹æ„å»ºã€‚"

          echo -e "$COMPLETION_COMMENT" | jq -Rs '{body: .}' | \
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d @-
