name: Custom Rustdesk Build Workflow

on:
  # Issue è§¦å‘
  issues:
    types: [opened]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag:
        description: 'æ„å»ºæ ‡ç­¾'
        required: true
        default: 'custom'
      customer:
        description: 'å®¢æˆ·åç§°'
        required: true
        default: 'test'
      customer_link:
        description: 'å®¢æˆ·é“¾æ¥'
        required: false
        default: ''
      slogan:
        description: 'æ ‡è¯­'
        required: false
        default: 'Custom Rustdesk'
      email:
        description: 'é‚®ç®±åœ°å€'
        required: true
        default: 'admin@example.com'
      super_password:
        description: 'è¶…çº§å¯†ç '
        required: true
        default: 'password123'
      rendezvous_server:
        description: 'RendezvousæœåŠ¡åœ°å€'
        required: true
        default: '192.168.1.100'
      rs_pub_key:
        description: 'RSå…¬é’¥'
        required: false
        default: ''
      api_server:
        description: 'APIæœåŠ¡åœ°å€'
        required: true
        default: 'http://192.168.1.100:21114'
      enable_debug:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆä»…æ‰‹åŠ¨è§¦å‘æ—¶æœ‰æ•ˆï¼‰'
        required: false
        default: true
        type: boolean

permissions:
  issues: write
  contents: read
  actions: read

env:
  GITHUB_TOKEN: ${{ secrets.ISSUE_TOKEN }}
  ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
  # è°ƒè¯•é…ç½® - é»˜è®¤ä¸å¼€å¯è°ƒè¯•ï¼Œåªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶å¯é€šè¿‡inputæ§åˆ¶
  DEBUG_ENABLED: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.enable_debug == 'true' || 'false' }}

jobs:
  # 00-è§¦å‘å¤„ç†
  trigger:
    runs-on: ubuntu-latest
    outputs:
      trigger_type: ${{ steps.trigger.outputs.trigger_type }}
      build_id: ${{ steps.trigger.outputs.build_id }}
      trigger_data: ${{ steps.trigger.outputs.data }}
      should_proceed: ${{ steps.trigger.outputs.should_proceed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup trigger parameters
        id: trigger
        run: |
          source .github/workflows/scripts/trigger.sh
          # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¼ é€’äº‹ä»¶æ•°æ®ï¼Œé¿å…å‘½ä»¤è¡Œå‚æ•°è¿‡é•¿
          export EVENT_NAME="${{ github.event_name }}"
          export EVENT_DATA='${{ toJSON(github.event) }}'
          export BUILD_ID="${{ github.run_id }}"
          # ä¼ é€’å®Œæ•´äº‹ä»¶æ•°æ®ï¼Œè„šæœ¬å†…éƒ¨æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†
          process_trigger "$EVENT_NAME" "$EVENT_DATA" "$BUILD_ID"
          

          
  # 01-å®¡æŸ¥éªŒè¯
  review:
    needs: trigger
    if: needs.trigger.outputs.should_proceed == 'true'
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.review.outputs.validation_passed }}
      reject_reason: ${{ steps.review.outputs.reject_reason }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        

        
      - name: Review and validate
        id: review
        env:
          TRIGGER_DATA: ${{ needs.trigger.outputs.trigger_data }}
        run: |
          source .github/workflows/scripts/review.sh
          process_review "$TRIGGER_DATA" "${{ github.actor }}" "${{ github.repository_owner }}"
          

          
  # 02-åŠ å…¥é˜Ÿåˆ—
  join-queue:
    needs: [trigger, review]
    if: needs.trigger.outputs.should_proceed == 'true' && needs.review.outputs.validation_passed == 'true'
    env:
      TRIGGER_DATA: ${{ needs.trigger.outputs.trigger_data }}
    runs-on: ubuntu-latest
    outputs:
      join_success: ${{ steps.join-queue.outputs.join_success }}
      queue_position: ${{ steps.join-queue.outputs.queue_position }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        

        
      - name: Join build queue with optimistic lock
        id: join-queue
        env:
          TRIGGER_DATA: ${{ needs.trigger.outputs.trigger_data }}
        run: |
          source .github/workflows/scripts/hybrid-lock.sh
          source .github/workflows/scripts/issue-manager.sh
          
          # ä½¿ç”¨ä¹è§‚é”åŠ å…¥é˜Ÿåˆ—
          echo "Starting optimistic lock queue join process..."
          join_result=$(main_hybrid_lock "join_queue" \
                          "${{ needs.trigger.outputs.build_id }}" \
                          "${{ needs.trigger.outputs.trigger_type }}" \
                          "$TRIGGER_DATA" \
                          "5")
          
          # æ£€æŸ¥åŠ å…¥ç»“æœ
          if [ $? -eq 0 ]; then
            echo "âœ… Successfully joined queue using optimistic lock"
            echo "join_success=true" >> $GITHUB_OUTPUT
            echo "queue_position=1" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to join queue"
            echo "join_success=false" >> $GITHUB_OUTPUT
            echo "queue_position=-1" >> $GITHUB_OUTPUT
          fi
          

          
  # 03-ç­‰å¾…é˜Ÿåˆ—
  wait-queue:
    needs: [trigger, review, join-queue]
    if: needs.trigger.outputs.should_proceed == 'true' && needs.review.outputs.validation_passed == 'true' && needs.join-queue.outputs.join_success == 'true'
    runs-on: ubuntu-latest
    outputs:
      lock_acquired: ${{ steps.wait-queue.outputs.lock_acquired }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        

        
      - name: Wait for queue turn
        id: wait-queue
        run: |
          source .github/workflows/scripts/hybrid-lock.sh

          # ä½¿ç”¨æ‚²è§‚é”ç­‰å¾…å¹¶è·å–æ„å»ºé”
          lock_result=$(main_hybrid_lock "acquire_lock" "${{ needs.trigger.outputs.build_id }}" "1")

          # æ£€æŸ¥è·å–é”çš„ç»“æœ
          if [ $? -eq 0 ]; then
            echo "âœ… Successfully acquired build lock"
            echo "lock_acquired=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to acquire build lock"
            echo "lock_acquired=false" >> $GITHUB_OUTPUT
          fi
          

          
  # 04-æ‰§è¡Œæ„å»º
  build:
    needs: [trigger, review, join-queue, wait-queue]
    if: needs.trigger.outputs.should_proceed == 'true' && needs.review.outputs.validation_passed == 'true' && needs.join-queue.outputs.join_success == 'true' && needs.wait-queue.outputs.lock_acquired == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Simulate build process
        id: build
        run: |
          echo "ğŸš€ å¼€å§‹æ¨¡æ‹Ÿç¼–è¯‘è¿‡ç¨‹..."
          echo "â³ ç¼–è¯‘æš‚åœ5åˆ†é’Ÿ..."
          sleep 300
          echo "âœ… ç¼–è¯‘å®Œæˆ"
          echo "ğŸ“¦ ç”Ÿæˆä¸‹è½½é“¾æ¥: https://example.com/download/rustdesk-custom.zip"
          
          
  # 05-å®Œæˆå¤„ç†
  finish:
    needs: [trigger, review, join-queue, wait-queue, build]
    if: always() && needs.trigger.outputs.should_proceed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Complete cleanup phase
        run: |
          echo "ğŸ§¹ å¼€å§‹å®Œæˆæ¸…ç†é˜¶æ®µ..."
          echo "ğŸ“‹ æ„å»ºç»“æœæ±‡æ€»:"
          echo "ğŸ”“ é‡Šæ”¾æ„å»ºé”..."
          echo "âœ… å®Œæˆæ¸…ç†é˜¶æ®µ" 
          
 
