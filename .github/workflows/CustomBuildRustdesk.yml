name: Custom Build Rustdesk

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      tag:
        description: "æ ‡ç­¾åç§°"
        required: false
        default: "vCustom"
        type: string
      email:
        description: "é‚®ä»¶åœ°å€"
        required: false
        default: "rustdesk@example.com"
        type: string
      customer:
        description: "å®¢æˆ·åç§°"
        required: false
        default: "è‡ªç”±å·¥ä½œå®¤"
        type: string
      customer_link:
        description: "å®¢æˆ·é“¾æ¥"
        required: false
        default: "https://rustdesk.com"
        type: string
      super_password:
        description: "è¶…çº§å¯†ç "
        required: false
        default: "123456"
        type: string
      slogan:
        description: "æ ‡è¯­"
        required: false
        default: "å®‰å…¨å¯é çš„è¿œç¨‹æ¡Œé¢è§£å†³æ–¹æ¡ˆ"
        type: string
      rendezvous_server:
        description: "æœåŠ¡å™¨åœ°å€"
        required: false
        default: "1.2.3.4:21117"
        type: string
      rs_pub_key:
        description: "å…¬é’¥"
        required: false
        default: "xxxxx"
        type: string
      api_server:
        description: "APIæœåŠ¡å™¨åœ°å€"
        required: false
        default: "https://api.example.com"
        type: string

# æ·»åŠ æƒé™é…ç½®
permissions:
  issues: write
  contents: read

jobs:
  trigger: # è§¦å‘é˜¶æ®µ
    runs-on: ubuntu-latest
    outputs:
      trigger_output: ${{ toJson(steps.setup.outputs.data) }}
    steps:
      - name: Setup framework
        id: setup
        run: |
          echo "Preparing environment..."
          
          # åˆ¤æ–­è§¦å‘æ–¹å¼å¹¶æå–å‚æ•°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨workflow_dispatchè¾“å…¥å‚æ•°
            echo "Manual trigger detected"
            TAG="${{ github.event.inputs.tag }}"
            EMAIL="${{ github.event.inputs.email }}"
            CUSTOMER="${{ github.event.inputs.customer }}"
            CUSTOMER_LINK="${{ github.event.inputs.customer_link }}"
            SUPER_PASSWORD="${{ github.event.inputs.super_password }}"
            SLOGAN="${{ github.event.inputs.slogan }}"
            RENDEZVOUS_SERVER="${{ github.event.inputs.rendezvous_server }}"
            RS_PUB_KEY="${{ github.event.inputs.rs_pub_key }}"
            API_SERVER="${{ github.event.inputs.api_server }}"
          else
            # Issueè§¦å‘ï¼šä»issueå†…å®¹ä¸­æå–å‚æ•°
            echo "Issue trigger detected"
            ISSUE_BODY="${{ github.event.issue.body }}"
            
            # ä½¿ç”¨grepå’Œsedæå–å‚æ•°å€¼
            TAG=$(echo "$ISSUE_BODY" | grep -oP 'tag:\s*\K[^\r\n]+' | head -1 || echo "")
            EMAIL=$(echo "$ISSUE_BODY" | grep -oP 'email:\s*\K[^\r\n]+' | head -1 || echo "")
            CUSTOMER=$(echo "$ISSUE_BODY" | grep -oP 'customer:\s*\K[^\r\n]+' | head -1 || echo "")
            CUSTOMER_LINK=$(echo "$ISSUE_BODY" | grep -oP 'customer_link:\s*\K[^\r\n]+' | head -1 || echo "")
            SUPER_PASSWORD=$(echo "$ISSUE_BODY" | grep -oP 'super_password:\s*\K[^\r\n]+' | head -1 || echo "")
            SLOGAN=$(echo "$ISSUE_BODY" | grep -oP 'slogan:\s*\K[^\r\n]+' | head -1 || echo "")
            RENDEZVOUS_SERVER=$(echo "$ISSUE_BODY" | grep -oP 'rendezvous_server:\s*\K[^\r\n]+' | head -1 || echo "")
            RS_PUB_KEY=$(echo "$ISSUE_BODY" | grep -oP 'rs_pub_key:\s*\K[^\r\n]+' | head -1 || echo "")
            API_SERVER=$(echo "$ISSUE_BODY" | grep -oP 'api_server:\s*\K[^\r\n]+' | head -1 || echo "")
          fi
          
          # æ£€æŸ¥å…³é”®å‚æ•°æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨secretså…œåº•
          if [ -z "$RENDEZVOUS_SERVER" ] || [ -z "$RS_PUB_KEY" ]; then
            echo "Using secrets fallback for missing critical parameters"
            TAG="${TAG:-${{ secrets.DEFAULT_TAG }}}"
            EMAIL="${EMAIL:-${{ secrets.DEFAULT_EMAIL }}}"
            CUSTOMER="${CUSTOMER:-${{ secrets.DEFAULT_CUSTOMER }}}"
            CUSTOMER_LINK="${CUSTOMER_LINK:-${{ secrets.DEFAULT_CUSTOMER_LINK }}}"
            SUPER_PASSWORD="${SUPER_PASSWORD:-${{ secrets.DEFAULT_SUPER_PASSWORD }}}"
            SLOGAN="${SLOGAN:-${{ secrets.DEFAULT_SLOGAN }}}"
            RENDEZVOUS_SERVER="${RENDEZVOUS_SERVER:-${{ secrets.DEFAULT_RENDEZVOUS_SERVER }}}"
            RS_PUB_KEY="${RS_PUB_KEY:-${{ secrets.DEFAULT_RS_PUB_KEY }}}"
            API_SERVER="${API_SERVER:-${{ secrets.DEFAULT_API_SERVER }}}"
          fi
          
          # ç”Ÿæˆåˆå§‹JSONæ•°æ®
          DATA=$(jq -c -n \
            --arg tag "$TAG" \
            --arg email "$EMAIL" \
            --arg customer "$CUSTOMER" \
            --arg customer_link "$CUSTOMER_LINK" \
            --arg super_password "$SUPER_PASSWORD" \
            --arg slogan "$SLOGAN" \
            --arg rendezvous_server "$RENDEZVOUS_SERVER" \
            --arg rs_pub_key "$RS_PUB_KEY" \
            --arg api_server "$API_SERVER" \
            '{tag: $tag, email: $email, customer: $customer, customer_link: $customer_link, super_password: $super_password, slogan: $slogan, rendezvous_server: $rendezvous_server, rs_pub_key: $rs_pub_key, api_server: $api_server}')
          
          # å­˜å‚¨è¾“å‡º
          echo "data=$DATA" >> $GITHUB_OUTPUT
      
      - name: Overwrite issue content
        if: github.event_name == 'issues'
        run: |
          # åˆ›å»ºæ¸…ç†åçš„issueå†…å®¹
          CLEANED_BODY="## æ„å»ºè¯·æ±‚å·²å¤„ç†

          **æ„å»ºå‚æ•°ï¼š**
          - æ ‡ç­¾: ${{ fromJson(steps.setup.outputs.data).tag }}
          - å®¢æˆ·: ${{ fromJson(steps.setup.outputs.data).customer }}
          - æ ‡è¯­: ${{ fromJson(steps.setup.outputs.data).slogan }}

          **çŠ¶æ€ï¼š** æ„å»ºå·²å¯åŠ¨
          **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')

          ---
          *æ•æ„Ÿä¿¡æ¯å·²è‡ªåŠ¨æ¸…ç†*"
          
          # ä½¿ç”¨jqæ­£ç¡®è½¬ä¹‰JSON
          JSON_PAYLOAD=$(jq -n --arg body "$CLEANED_BODY" '{"body": $body}')
          
          # ä½¿ç”¨GitHub APIæ›´æ–°issue
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -d "$JSON_PAYLOAD"
      
      - name: Verify dependencies
        run: echo "Checking system dependencies"
      
      - name: Generate config
        run: |
          # åœ¨åŒä¸€ä¸ªjobä¸­è®¿é—®æ•°æ®
          echo "Trigger type: ${{ github.event_name }}"
          echo "Tag: ${{ fromJson(steps.setup.outputs.data).tag }}"
          echo "Customer: ${{ fromJson(steps.setup.outputs.data).customer }}"
          echo "Rendezvous Server: ${{ fromJson(steps.setup.outputs.data).rendezvous_server }}"

  review: # å®¡æ ¸é˜¶æ®µ
    needs: trigger
    runs-on: ubuntu-latest
    outputs:
      review_output: ${{ toJson(steps.output.outputs.data) }}
      build_approved: ${{ steps.output.outputs.build_approved }}
    steps:
      - name: Extract data
        id: extract
        run: |
          # ä»…æå–æ•°æ®ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†
          INPUT='${{ fromJson(needs.trigger.outputs.trigger_output) }}'
          
          # æå–æœåŠ¡å™¨åœ°å€
          RENDEZVOUS_SERVER=$(echo "$INPUT" | jq -r '.rendezvous_server')
          API_SERVER=$(echo "$INPUT" | jq -r '.api_server')
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "RENDEZVOUS_SERVER=$RENDEZVOUS_SERVER" >> $GITHUB_ENV
          echo "API_SERVER=$API_SERVER" >> $GITHUB_ENV
          echo "CURRENT_DATA=$INPUT" >> $GITHUB_ENV
          
          # éªŒè¯JSONæ ¼å¼
          echo "Validating JSON format..."
          echo "$INPUT" | jq . > /dev/null
          echo "JSON validation passed"
      
      - name: Auto reject invalid server parameters
        run: |
          # æ£€æŸ¥IPæˆ–åŸŸåçš„æ­£åˆ™
          is_valid_ip() {
            [[ "$1" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}(:[0-9]+)?$ ]]
          }

          is_valid_domain() {
            [[ "$1" =~ ^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(:[0-9]+)?$ ]]
          }

          is_valid_url() {
            # å…è®¸ http(s):// å¼€å¤´
            local url="$1"
            url="${url#http://}"
            url="${url#https://}"
            is_valid_ip "$url" || is_valid_domain "$url"
          }

          AUTO_REJECT_REASON=""

          if ! is_valid_ip "${{ env.RENDEZVOUS_SERVER }}" && ! is_valid_domain "${{ env.RENDEZVOUS_SERVER }}"; then
            AUTO_REJECT_REASON="rendezvous_server éæ³•: ${{ env.RENDEZVOUS_SERVER }}"
          fi

          if ! is_valid_url "${{ env.API_SERVER }}"; then
            if [ -n "$AUTO_REJECT_REASON" ]; then
              AUTO_REJECT_REASON="$AUTO_REJECT_REASON; api_server éæ³•: ${{ env.API_SERVER }}"
            else
              AUTO_REJECT_REASON="api_server éæ³•: ${{ env.API_SERVER }}"
            fi
          fi

          if [ -n "$AUTO_REJECT_REASON" ]; then
            echo "è‡ªåŠ¨æ‹’ç»ï¼š$AUTO_REJECT_REASON"
            REJECT_COMMENT="## âŒ æ„å»ºè¢«è‡ªåŠ¨æ‹’ç»
            **åŸå› ï¼š** $AUTO_REJECT_REASON
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            è¯·æ£€æŸ¥å‚æ•°åé‡æ–°æäº¤issueã€‚"
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d "$(jq -n --arg body "$REJECT_COMMENT" "{\"body\": \$body}")"
            echo "BUILD_REJECTED=true" >> $GITHUB_ENV
            exit 0
          fi

      - name: Determine review requirement
        if: env.BUILD_REJECTED != 'true'
        run: |
          # é»˜è®¤éœ€è¦å®¡æ ¸
          NEED_REVIEW=true

          # ä»“åº“æ‰€æœ‰è€…å…å®¡æ ¸
          if [ "${{ github.actor }}" = "${{ github.repository_owner }}" ]; then
            echo "Repo owner detected, skipping review."
            NEED_REVIEW=false
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸ºç§æœ‰IPåœ°å€
          check_private_ip() {
            local ip=$1
            # ç§»é™¤ç«¯å£å·ï¼ˆå¦‚æœæœ‰ï¼‰
            ip=$(echo "$ip" | cut -d: -f1)
            
            # æ£€æŸ¥10.0.0.0/8
            if [[ "$ip" =~ ^10\. ]]; then
              return 0
            fi
            
            # æ£€æŸ¥172.16.0.0/12
            if [[ "$ip" =~ ^172\.(1[6-9]|2[0-9]|3[0-1])\. ]]; then
              return 0
            fi
            
            # æ£€æŸ¥192.168.0.0/16
            if [[ "$ip" =~ ^192\.168\. ]]; then
              return 0
            fi
            
            return 1
          }
          
          # æ£€æŸ¥ä¸¤ä¸ªæœåŠ¡å™¨åœ°å€
          RENDEZVOUS_PRIVATE=false
          API_PRIVATE=false
          
          if check_private_ip "${{ env.RENDEZVOUS_SERVER }}"; then
            RENDEZVOUS_PRIVATE=true
            echo "Rendezvous server is private IP: ${{ env.RENDEZVOUS_SERVER }}"
          else
            echo "Rendezvous server is public IP: ${{ env.RENDEZVOUS_SERVER }}"
          fi
          
          if check_private_ip "${{ env.API_SERVER }}"; then
            API_PRIVATE=true
            echo "API server is private IP: ${{ env.API_SERVER }}"
          else
            echo "API server is public IP: ${{ env.API_SERVER }}"
          fi
          
          # åˆ¤æ–­æ˜¯å¦éœ€è¦å®¡æ ¸
          if [ "$NEED_REVIEW" = "false" ]; then
            echo "Skipping review due to repo owner or private IP check."
          else
            if [ "$RENDEZVOUS_PRIVATE" = "true" ] && [ "$API_PRIVATE" = "true" ]; then
              NEED_REVIEW=false
              echo "Both servers are private IPs - no review needed"
            else
              NEED_REVIEW=true
              echo "At least one server is public IP - review required"
            fi
          fi
          
          # è®¾ç½®å®¡æ ¸æ ‡è®°åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "NEED_REVIEW=$NEED_REVIEW" >> $GITHUB_ENV
      
      - name: Handle review process
        if: env.NEED_REVIEW == 'true' && env.BUILD_REJECTED != 'true'
        run: |
          echo "Review required. Starting review process..."
          
          # åœ¨issueä¸­æ·»åŠ å®¡æ ¸çŠ¶æ€
          REVIEW_COMMENT="## ğŸ” å®¡æ ¸çŠ¶æ€

          **éœ€è¦å®¡æ ¸åŸå› ï¼š** æ£€æµ‹åˆ°å…¬ç½‘æœåŠ¡å™¨åœ°å€
          - Rendezvous Server: ${{ env.RENDEZVOUS_SERVER }}
          - API Server: ${{ env.API_SERVER }}

          **å®¡æ ¸è¦æ±‚ï¼š** è¯·ç®¡ç†å‘˜å›å¤ 'åŒæ„æ„å»º' æˆ– 'æ‹’ç»æ„å»º'

          **çŠ¶æ€ï¼š** ç­‰å¾…å®¡æ ¸ä¸­ â³
          **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ä½¿ç”¨jqæ­£ç¡®è½¬ä¹‰JSON
          JSON_PAYLOAD=$(jq -n --arg body "$REVIEW_COMMENT" '{"body": $body}')

          # æ·»åŠ å®¡æ ¸è¯„è®º
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d "$(jq -n --arg body "$REVIEW_COMMENT" '{"body": $body}')"
          
          # å¾ªç¯æ£€æŸ¥å®¡æ ¸å›å¤
          START_TIME=$(date +%s)
          TIMEOUT=7200  # 2å°æ—¶è¶…æ—¶
          APPROVED=false
          REJECTED=false # æ–°å¢å˜é‡ï¼Œç”¨äºæ ‡è®°æ‹’ç»
          
          while [ $(($(date +%s) - START_TIME)) -lt $TIMEOUT ]; do
            echo "Checking for admin approval... ($(($(date +%s) - START_TIME))s elapsed)"
            
            # è·å–issueçš„æœ€æ–°è¯„è®º
            COMMENTS=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments)
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜å›å¤
            # è·å–ä»“åº“æ‰€æœ‰è€…å’Œç®¡ç†å‘˜åˆ—è¡¨
            REPO_OWNER="${{ github.repository_owner }}"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜å›å¤ï¼ˆåŒ…æ‹¬ä»“åº“æ‰€æœ‰è€…ï¼‰
            if echo "$COMMENTS" | jq -e --arg owner "$REPO_OWNER" '.[] | select(.user.login == $owner or .user.login == "admin" or .user.login == "ç®¡ç†å‘˜ç”¨æˆ·å") | select(.body | contains("åŒæ„æ„å»º"))' > /dev/null; then
              APPROVED=true
              break
            fi
            
            if echo "$COMMENTS" | jq -e --arg owner "$REPO_OWNER" '.[] | select(.user.login == $owner or .user.login == "admin" or .user.login == "ç®¡ç†å‘˜ç”¨æˆ·å") | select(.body | contains("æ‹’ç»æ„å»º"))' > /dev/null; then
              REJECTED=true
              break
            fi
            
            # è°ƒè¯•ï¼šè¾“å‡ºæœ€æ–°çš„è¯„è®ºä¿¡æ¯
            echo "Latest comments:"
            echo "$COMMENTS" | jq -r '.[-3:] | .[] | "User: \(.user.login), Body: \(.body[0:100])..."'
            
            # ç­‰å¾…30ç§’åå†æ¬¡æ£€æŸ¥
            sleep 30
          done
          
          if [ "$APPROVED" = true ]; then
            echo "Admin approval received"
            # æ·»åŠ å®¡æ ¸é€šè¿‡è¯„è®º
            APPROVAL_COMMENT="## âœ… å®¡æ ¸é€šè¿‡
            **çŠ¶æ€ï¼š** å®¡æ ¸å·²é€šè¿‡
            **å®¡æ ¸äººï¼š** ç®¡ç†å‘˜
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            æ„å»ºå°†ç»§ç»­è¿›è¡Œ..."
            
          # ä½¿ç”¨jqæ­£ç¡®è½¬ä¹‰JSON
          JSON_PAYLOAD=$(jq -n --arg body "$APPROVAL_COMMENT" '{"body": $body}')

            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d "$(jq -n --arg body "$APPROVAL_COMMENT" '{"body": $body}')"
          elif [ "$REJECTED" = true ]; then
            echo "Build rejected by admin"
            
            # æ·»åŠ æ‹’ç»è¯„è®º
            REJECT_COMMENT="## âŒ æ„å»ºè¢«æ‹’ç»
            **çŠ¶æ€ï¼š** æ„å»ºå·²è¢«ç®¡ç†å‘˜æ‹’ç»
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            æ„å»ºæµç¨‹å·²ç»ˆæ­¢ã€‚å¦‚éœ€é‡æ–°æ„å»ºï¼Œè¯·é‡æ–°æäº¤issueã€‚"
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d "$(jq -n --arg body "$REJECT_COMMENT" "{\"body\": \$body}")"
            
            echo "Build rejected by admin - setting build_approved to false"
            # è®¾ç½®æ„å»ºè¢«æ‹’ç»æ ‡å¿—
            echo "BUILD_REJECTED=true" >> $GITHUB_ENV
          else
            echo "Review timeout after 2 hours"
            # æ·»åŠ è¶…æ—¶è¯„è®º
            TIMEOUT_COMMENT="## â° å®¡æ ¸è¶…æ—¶
            **çŠ¶æ€ï¼š** å®¡æ ¸è¶…æ—¶ï¼ˆ2å°æ—¶ï¼‰
            **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')
            æ„å»ºå°†è‡ªåŠ¨ç»ˆæ­¢ã€‚å¦‚éœ€é‡æ–°æ„å»ºï¼Œè¯·é‡æ–°æäº¤issueã€‚"
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              -d "$(jq -n --arg body "$TIMEOUT_COMMENT" "{\"body\": \$body}")"
            
            echo "Review timeout - setting build_approved to false"
            # è®¾ç½®å®¡æ ¸è¶…æ—¶æ ‡å¿—
            echo "BUILD_TIMEOUT=true" >> $GITHUB_ENV
          fi

      - name: Output data
        if: env.BUILD_REJECTED != 'true'
        id: output
        run: |
          # é‡æ–°è·å–åŸå§‹æ•°æ®å¹¶ç¡®ä¿JSONæ ¼å¼æ­£ç¡®
          INPUT='${{ fromJson(needs.trigger.outputs.trigger_output) }}'
          
          # ç¡®ä¿è¾“å‡ºçš„æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼
          echo "data=$INPUT" >> $GITHUB_OUTPUT
          
          # æ ¹æ®æ ‡å¿—è®¾ç½®æ„å»ºæ‰¹å‡†çŠ¶æ€
          if [ "${{ env.BUILD_REJECTED }}" = "true" ]; then
            echo "build_approved=false" >> $GITHUB_OUTPUT
            echo "Build was rejected by admin"
          elif [ "${{ env.BUILD_TIMEOUT }}" = "true" ]; then
            echo "build_approved=false" >> $GITHUB_OUTPUT
            echo "Build timed out during review"
          else
            echo "build_approved=true" >> $GITHUB_OUTPUT
            echo "Build was approved or no review needed"
          fi
          
          # æ˜¾ç¤ºè¾“å‡ºä¿¡æ¯
          echo "Review output: $INPUT"
          
          # éªŒè¯è¾“å‡ºçš„JSONæ ¼å¼
          echo "Validating output JSON format..."
          echo "$INPUT" | jq . > /dev/null
          echo "Output JSON validation passed"

  queue: # æ’é˜Ÿé˜¶æ®µ
    needs: review
    runs-on: ubuntu-latest
    if: needs.review.outputs.build_approved == 'true'
    outputs:
      queue_output: ${{ toJson(steps.output.outputs.data) }}
    steps:
      - name: Extract data
        id: extract
        run: |
          # ä»…æå–æ•°æ®ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†
          INPUT='${{ fromJson(needs.review.outputs.review_output) }}'
          
          # éªŒè¯è¾“å…¥JSONæ ¼å¼
          echo "Validating input JSON format..."
          echo "$INPUT" | jq . > /dev/null
          echo "Input JSON validation passed"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CURRENT_DATA=$INPUT" >> $GITHUB_ENV

      - name: Process data
        id: process
        run: |
          # å¤„ç†æ•°æ®ï¼ˆæ·»åŠ æ’é˜ŸçŠ¶æ€ï¼‰
          # ä»ç¯å¢ƒå˜é‡ä¸­å®‰å…¨åœ°æå–JSONæ•°æ®
          CURRENT_DATA='${{ env.CURRENT_DATA }}'
          
          # éªŒè¯JSONæ ¼å¼
          echo "Validating input JSON..."
          echo "$CURRENT_DATA" | jq . > /dev/null
          echo "Input JSON validation passed"
          
          # ä½¿ç”¨jqå¤„ç†JSONï¼Œæ·»åŠ æ’é˜ŸçŠ¶æ€
          PROCESSED=$(echo "$CURRENT_DATA" | jq -c --arg queue_time "$(date -Iseconds)" '. + {queued: true, queue_time: $queue_time}')
          
          # éªŒè¯å¤„ç†åçš„JSONæ ¼å¼
          echo "Validating processed JSON..."
          echo "$PROCESSED" | jq . > /dev/null
          echo "Processed JSON validation passed"
          
          echo "CURRENT_DATA=$PROCESSED" >> $GITHUB_ENV

      - name: Output data
        id: output
        run: |
          # ç›´æ¥ä½¿ç”¨Processæ­¥éª¤å¤„ç†åçš„æ•°æ®
          OUTPUT_DATA='${{ env.CURRENT_DATA }}'
          
          # éªŒè¯è¾“å‡ºJSONæ ¼å¼
          echo "Validating output JSON format..."
          echo "$OUTPUT_DATA" | jq . > /dev/null
          echo "Output JSON validation passed"
          
          echo "data=$OUTPUT_DATA" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºè¾“å‡ºä¿¡æ¯
          echo "Queue output: $OUTPUT_DATA"

  build: # æ„å»ºé˜¶æ®µ
    needs: queue
    runs-on: ubuntu-latest
    if: needs.queue.outputs.queue_output != null
    outputs:
      build_output: ${{ toJson(steps.output.outputs.data) }}
    steps:
      - name: Extract data
        id: extract
        run: |
          # ä»…æå–æ•°æ®ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†
          INPUT='${{ fromJson(needs.queue.outputs.queue_output) }}'
          
          # éªŒè¯è¾“å…¥JSONæ ¼å¼
          echo "Validating input JSON format..."
          echo "$INPUT" | jq . > /dev/null
          echo "Input JSON validation passed"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CURRENT_DATA=$INPUT" >> $GITHUB_ENV

      - name: Process data
        id: process
        run: |
          # å¤„ç†æ•°æ®ï¼ˆæ·»åŠ æ„å»ºçŠ¶æ€ï¼‰
          # ä»ç¯å¢ƒå˜é‡ä¸­å®‰å…¨åœ°æå–JSONæ•°æ®
          CURRENT_DATA='${{ env.CURRENT_DATA }}'
          
          # éªŒè¯JSONæ ¼å¼
          echo "Validating input JSON..."
          echo "$CURRENT_DATA" | jq . > /dev/null
          echo "Input JSON validation passed"
          
          # ä½¿ç”¨jqå¤„ç†JSONï¼Œæ·»åŠ æ„å»ºçŠ¶æ€
          PROCESSED=$(echo "$CURRENT_DATA" | jq -c --arg build_time "$(date -Iseconds)" '. + {built: true, build_time: $build_time}')
          
          # éªŒè¯å¤„ç†åçš„JSONæ ¼å¼
          echo "Validating processed JSON..."
          echo "$PROCESSED" | jq . > /dev/null
          echo "Processed JSON validation passed"
          
          echo "CURRENT_DATA=$PROCESSED" >> $GITHUB_ENV

      - name: Output data
        id: output
        run: |
          # ç›´æ¥ä½¿ç”¨Processæ­¥éª¤å¤„ç†åçš„æ•°æ®
          OUTPUT_DATA='${{ env.CURRENT_DATA }}'
          
          # éªŒè¯è¾“å‡ºJSONæ ¼å¼
          echo "Validating output JSON format..."
          echo "$OUTPUT_DATA" | jq . > /dev/null
          echo "Output JSON validation passed"
          
          echo "data=$OUTPUT_DATA" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºè¾“å‡ºä¿¡æ¯
          echo "Build output: $OUTPUT_DATA"

  finish: # æ”¶å°¾é˜¶æ®µ
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.build_output != null
    steps:
      - name: Parse input
        run: |
          # æ­£ç¡®è·å–è¾“å…¥æ•°æ®
          INPUT='${{ fromJson(needs.build.outputs.build_output) }}'
          echo "FINAL_INPUT=$INPUT" >> $GITHUB_ENV

      - name: Final processing
        run: |
          # ä½¿ç”¨jqè§£æå•è¡ŒJSON
          echo "Final data: $FINAL_INPUT"
          echo "Ready status: $(jq -r '.ready' <<< "$FINAL_INPUT")"
          echo "Version: $(jq -r '.version' <<< "$FINAL_INPUT")"

      - name: Generate report
        run: |
          echo "Build completed successfully"
