name: Delete Issues

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'é€‰æ‹©æ“ä½œæ¨¡å¼'
        required: true
        default: 'æ¨¡æ‹Ÿæ¨¡å¼'
        type: choice
        options:
          - æ¨¡æ‹Ÿæ¨¡å¼
          - åˆ é™¤æ¨¡å¼

jobs:
  delete_issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Authenticate and Check Permissions
        run: |
          if [ -n "${{ secrets.ISSUE_TOKEN }}" ]; then
            echo "${{ secrets.ISSUE_TOKEN }}" | gh auth login --with-token
            echo "âœ… ä½¿ç”¨Personal Access Tokenè®¤è¯"
          else
            echo "âŒ æœªè®¾ç½®ISSUE_TOKENï¼Œè¯·å‚è€ƒquick_setup_guide.md"
            exit 1
          fi
          
          # æ£€æŸ¥æƒé™
          ADMIN_PERMISSION=$(gh api repos/${{ github.repository }} --jq '.permissions.admin // false')
          if [ "$ADMIN_PERMISSION" != "true" ]; then
            echo "âŒ æƒé™ä¸è¶³ï¼Œéœ€è¦adminæƒé™"
            exit 1
          fi

      - name: List Issues
        id: list_issues
        run: |
          OPEN_ISSUES=$(gh issue list --repo ${{ github.repository }} --state open --limit 100 --json number | jq -r '.[] | select(.number != 1) | .number')
          CLOSED_ISSUES=$(gh issue list --repo ${{ github.repository }} --state closed --limit 100 --json number | jq -r '.[] | select(.number != 1) | .number')
          ISSUES=$(echo -e "$OPEN_ISSUES\n$CLOSED_ISSUES" | grep -v '^$' | sort -n | uniq)
          
          if [ -z "$ISSUES" ]; then
            echo "âœ… æ²¡æœ‰éœ€è¦åˆ é™¤çš„issues"
            echo "ISSUE_COUNT=0" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "æ‰¾åˆ° $ISSUES ä¸ªissueséœ€è¦åˆ é™¤"
          echo "ISSUES_TO_DELETE<<EOF" >> $GITHUB_ENV
          echo "$ISSUES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "ISSUE_COUNT=$(echo "$ISSUES" | wc -l)" >> $GITHUB_ENV

      - name: Preview
        run: |
          if [ "${{ github.event.inputs.mode }}" = "æ¨¡æ‹Ÿæ¨¡å¼" ]; then
            echo "ğŸ” æ¨¡æ‹Ÿæ¨¡å¼ï¼šå°†é¢„è§ˆåˆ é™¤ ${{ env.ISSUE_COUNT }} ä¸ªissues"
            echo "è¦å®é™…åˆ é™¤ï¼Œè¯·é€‰æ‹© 'åˆ é™¤æ¨¡å¼'"
          else
            echo "âš ï¸ åˆ é™¤æ¨¡å¼ï¼šå°†åˆ é™¤ ${{ env.ISSUE_COUNT }} ä¸ªissues"
          fi

      - name: Delete Issues
        if: github.event.inputs.mode == 'åˆ é™¤æ¨¡å¼'
        run: |
          if [ -z "$ISSUES_TO_DELETE" ]; then
            echo "âœ… æ²¡æœ‰éœ€è¦åˆ é™¤çš„issues"
            exit 0
          fi
          
          DELETED=0
          FAILED=0
          
          for issue in $ISSUES_TO_DELETE; do
            if gh issue delete $issue --repo ${{ github.repository }} --yes; then
              echo "âœ… åˆ é™¤ Issue #$issue"
              DELETED=$((DELETED + 1))
            else
              echo "âŒ åˆ é™¤ Issue #$issue å¤±è´¥"
              FAILED=$((FAILED + 1))
            fi
            sleep 1
          done
          
          echo "åˆ é™¤å®Œæˆï¼šæˆåŠŸ $DELETED ä¸ªï¼Œå¤±è´¥ $FAILED ä¸ª"

      - name: Summary
        run: |
          if [ "${{ github.event.inputs.mode }}" = "æ¨¡æ‹Ÿæ¨¡å¼" ]; then
            echo "ğŸ” æ¨¡æ‹Ÿå®Œæˆï¼šå‘ç° ${{ env.ISSUE_COUNT }} ä¸ªissues"
          else
            echo "ğŸ—‘ï¸ åˆ é™¤å®Œæˆï¼šå¤„ç†äº† ${{ env.ISSUE_COUNT }} ä¸ªissues"
          fi
          
          REMAINING=$(gh issue list --repo ${{ github.repository }} --limit 100 --json number | jq -r '.[] | .number')
          echo "å‰©ä½™issuesï¼š$REMAINING" 