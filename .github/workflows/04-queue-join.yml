name: 04 - Queue Join

on:
  workflow_run:
    workflows: ["03 - Queue Cleanup"]
    types: [completed]

# æ·»åŠ æƒé™é…ç½®
permissions:
  issues: write
  contents: read

jobs:
  queue_join:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Get review workflow data
        id: get_data
        run: |
          # è·å–å®¡æ ¸å·¥ä½œæµçš„æ•°æ®
          REVIEW_RUN_ID="${{ github.event.workflow_run.id }}"
          
          # è·å–å®¡æ ¸å·¥ä½œæµçš„è¾“å‡º
          REVIEW_OUTPUT=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$REVIEW_RUN_ID/jobs" | \
            jq -r '.jobs[0].steps[] | select(.name == "Output data") | .outputs.review_output // empty')
          
          if [ -z "$REVIEW_OUTPUT" ]; then
            echo "âŒ Failed to get review workflow data"
            exit 1
          fi
          
          echo "REVIEW_OUTPUT=$REVIEW_OUTPUT" >> $GITHUB_ENV
          
          # è·å–è§¦å‘ç±»å‹å’Œæ„å»ºID
          TRIGGER_RUN_ID=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$REVIEW_RUN_ID/jobs" | \
            jq -r '.jobs[0].steps[] | select(.name == "Get trigger workflow data") | .outputs.trigger_type // empty')
          
          echo "TRIGGER_TYPE=$TRIGGER_RUN_ID" >> $GITHUB_ENV
      
      - name: Extract data
        id: extract
        run: |
          # ä»reviewé˜¶æ®µè·å–æ•°æ®
          INPUT='${{ env.REVIEW_OUTPUT }}'
          
          # éªŒè¯è¾“å…¥JSONæ ¼å¼
          echo "Validating input JSON format..."
          echo "$INPUT" | jq . > /dev/null
          echo "Input JSON validation passed"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CURRENT_DATA=$INPUT" >> $GITHUB_ENV
          
          # è·å–è§¦å‘æ–¹å¼
          if [ "${{ env.TRIGGER_TYPE }}" = "workflow_dispatch" ]; then
            echo "TRIGGER_TYPE=workflow_dispatch" >> $GITHUB_ENV
            echo "QUEUE_LIMIT=5" >> $GITHUB_ENV
          else
            echo "TRIGGER_TYPE=issue" >> $GITHUB_ENV
            echo "QUEUE_LIMIT=3" >> $GITHUB_ENV
          fi

      - name: Auto cleanup queue
        run: |
          # è‡ªåŠ¨æ¸…ç†é˜Ÿåˆ—ï¼Œå¤„ç†å¼‚å¸¸é”å’Œå¡ä½çš„çŠ¶æ€
          echo "Starting automatic queue cleanup..."
          
          # åŠ è½½å…±äº«å·¥å…·å‡½æ•°
          source .github/workflows/shared/github-utils.yml
          
          # é‡è¯•æœºåˆ¶å‚æ•°
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          # é‡è¯•æ¸…ç†é˜Ÿåˆ—
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt of $MAX_RETRIES to cleanup queue..."
            
            QUEUE_MANAGER_ISSUE="1"
            QUEUE_MANAGER_CONTENT=$(get_queue_manager_content "$QUEUE_MANAGER_ISSUE")
            QUEUE_DATA=$(extract_queue_json "$QUEUE_MANAGER_CONTENT")
            
            # å¦‚æœè§£æJSONå¤±è´¥ï¼Œç›´æ¥é‡ç½®
            if [ -z "$QUEUE_DATA" ] || ! echo "$QUEUE_DATA" | jq . > /dev/null 2>&1; then
              echo "âŒ JSON parsing failed, resetting queue template"
              reset_queue_to_default "$QUEUE_MANAGER_ISSUE" "JSONè§£æå¤±è´¥ï¼Œé‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿"
              echo "âœ… Queue reset triggered"
              break
            fi
            
            # è·å–å½“å‰çŠ¶æ€
            CURRENT_VERSION=$(echo "$QUEUE_DATA" | jq -r '.version // 1')
            LOCK_RUN_ID=$(echo "$QUEUE_DATA" | jq -r '.run_id // null')
            QUEUE=$(echo "$QUEUE_DATA" | jq -r '.queue // []')
            
            echo "Current version: $CURRENT_VERSION"
            echo "Lock run_id: $LOCK_RUN_ID"
            echo "Queue: $QUEUE"
            
            # æ£€æŸ¥éœ€è¦æ¸…ç†çš„é¡¹ç›®
            NEED_CLEANUP=false
            CLEANUP_REASONS=()
            
            # 1. æ£€æŸ¥é”è¶…æ—¶ï¼ˆè¶…è¿‡2å°æ—¶ï¼‰
            if [ "$LOCK_RUN_ID" != "null" ]; then
              LOCK_ISSUE_JOIN_TIME=$(echo "$QUEUE" | \
                jq -r --arg run_id "$LOCK_RUN_ID" \
                '.[] | select(.issue_number == $run_id) | .join_time // empty' 2>/dev/null || echo "")
              
              if [ -n "$LOCK_ISSUE_JOIN_TIME" ]; then
                JOIN_TIMESTAMP=$(date -d "$LOCK_ISSUE_JOIN_TIME" +%s 2>/dev/null || echo "0")
                CURRENT_TIMESTAMP=$(date +%s)
                LOCK_DURATION_HOURS=$(( (CURRENT_TIMESTAMP - JOIN_TIMESTAMP) / 3600 ))
                
                if [ "$LOCK_DURATION_HOURS" -ge 2 ]; then
                  NEED_CLEANUP=true
                  CLEANUP_REASONS+=("é”è¶…æ—¶ï¼šå·²å ç”¨${LOCK_DURATION_HOURS}å°æ—¶")
                  echo "âŒ Lock timeout: ${LOCK_DURATION_HOURS} hours"
                fi
              else
                NEED_CLEANUP=true
                CLEANUP_REASONS+=("é”å¼‚å¸¸ï¼šæ‰¾ä¸åˆ°é”æŒæœ‰æ—¶é—´")
                echo "âŒ Lock anomaly: no join time found"
              fi
            fi
            
            # 2. æ£€æŸ¥é‡å¤é¡¹
            if [ "$(echo "$QUEUE" | jq -r 'type')" = "array" ]; then
              DUPLICATE_ITEMS=$(echo "$QUEUE" | \
                jq -r 'group_by(.issue_number) | .[] | select(length > 1) | .[0].issue_number' 2>/dev/null || echo "")
              
              if [ -n "$DUPLICATE_ITEMS" ]; then
                NEED_CLEANUP=true
                CLEANUP_REASONS+=("é˜Ÿåˆ—é‡å¤ï¼šæ„å»ºé¡¹ç›® $DUPLICATE_ITEMS é‡å¤")
                echo "âŒ Duplicate items: $DUPLICATE_ITEMS"
              fi
            fi
            
            # 3. æ£€æŸ¥æ— æ•ˆissue
            if [ "$(echo "$QUEUE" | jq -r 'type')" = "array" ]; then
              INVALID_ISSUES=()
              for issue_number in $(echo "$QUEUE" | jq -r '.[].issue_number'); do
                ISSUE_RESPONSE=$(curl -s \
                  -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/${{ github.repository }}/issues/$issue_number")
                
                if echo "$ISSUE_RESPONSE" | jq -e '.message' | grep -q "Not Found"; then
                  INVALID_ISSUES+=("$issue_number")
                  echo "âŒ Issue #$issue_number not found"
                fi
              done
              
              if [ ${#INVALID_ISSUES[@]} -gt 0 ]; then
                NEED_CLEANUP=true
                CLEANUP_REASONS+=("æ— æ•ˆissueï¼š${INVALID_ISSUES[*]} ä¸å­˜åœ¨")
                echo "âŒ Invalid issues: ${INVALID_ISSUES[*]}"
              fi
            fi
            
            # 4. æ£€æŸ¥å·²ç»“æŸçš„runs
            if [ "$(echo "$QUEUE" | jq -r 'type')" = "array" ]; then
              EXPIRED_RUNS=()
              for run_id in $(echo "$QUEUE" | jq -r '.[] | select(.trigger_type == "workflow_dispatch") | .issue_number'); do
                # æ£€æŸ¥workflow runæ˜¯å¦å­˜åœ¨ä¸”æœªå®Œæˆ
                RUN_RESPONSE=$(curl -s \
                  -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id")
                
                if echo "$RUN_RESPONSE" | jq -e '.message' | grep -q "Not Found"; then
                  EXPIRED_RUNS+=("$run_id")
                  echo "âŒ Run #$run_id not found"
                else
                  # æ£€æŸ¥runçŠ¶æ€ï¼šcompleted, cancelled, failure, skipped éƒ½æ˜¯å·²ç»“æŸçŠ¶æ€
                  RUN_STATUS=$(echo "$RUN_RESPONSE" | jq -r '.status // "unknown"')
                  RUN_CONCLUSION=$(echo "$RUN_RESPONSE" | jq -r '.conclusion // "unknown"')
                  
                  if [ "$RUN_STATUS" = "completed" ] || [ "$RUN_STATUS" = "cancelled" ] || [ "$RUN_STATUS" = "failure" ] || [ "$RUN_STATUS" = "skipped" ]; then
                    EXPIRED_RUNS+=("$run_id")
                    echo "âŒ Run #$run_id ended with status: $RUN_STATUS, conclusion: $RUN_CONCLUSION"
                  fi
                fi
              done
              
              if [ ${#EXPIRED_RUNS[@]} -gt 0 ]; then
                NEED_CLEANUP=true
                CLEANUP_REASONS+=("å·²ç»“æŸrunsï¼š${EXPIRED_RUNS[*]} å·²å®Œæˆ/å–æ¶ˆ/å¤±è´¥/è·³è¿‡æˆ–ä¸å­˜åœ¨")
                echo "âŒ Expired runs: ${EXPIRED_RUNS[*]}"
              fi
            fi
            
            # æ‰§è¡Œæ¸…ç†
            if [ "$NEED_CLEANUP" = true ]; then
              echo "Performing queue cleanup..."
              echo "Cleanup reasons: ${CLEANUP_REASONS[*]}"
              
              # å¼€å§‹æ¸…ç†æ•°æ®
              CLEANED_QUEUE_DATA=$(echo "$QUEUE_DATA" | \
                jq --arg new_version "$((CURRENT_VERSION + 1))" '
                # ç§»é™¤é‡å¤é¡¹
                .queue = (.queue | group_by(.issue_number) | map(.[0]))
                # é‡ç½®å¼‚å¸¸é”
                | .run_id = null
                | .version = ($new_version | tonumber)
              ')
              
              # ç§»é™¤æ— æ•ˆissue
              if [ ${#INVALID_ISSUES[@]} -gt 0 ]; then
                for invalid_issue in "${INVALID_ISSUES[@]}"; do
                  CLEANED_QUEUE_DATA=$(echo "$CLEANED_QUEUE_DATA" | \
                    jq --arg issue_number "$invalid_issue" \
                    '.queue = (.queue | map(select(.issue_number != $issue_number)))')
                done
              fi
              
              # ç§»é™¤å·²ç»“æŸçš„runs
              if [ ${#EXPIRED_RUNS[@]} -gt 0 ]; then
                for expired_run in "${EXPIRED_RUNS[@]}"; do
                  CLEANED_QUEUE_DATA=$(echo "$CLEANED_QUEUE_DATA" | \
                    jq --arg run_id "$expired_run" \
                    '.queue = (.queue | map(select(.issue_number != $run_id)))')
                done
              fi
              
              # è®¡ç®—æ¸…ç†åçš„é˜Ÿåˆ—æ•°é‡
              CLEANED_TOTAL_COUNT=$(echo "$CLEANED_QUEUE_DATA" | jq '.queue | length // 0')
              CLEANED_ISSUE_COUNT=$(echo "$CLEANED_QUEUE_DATA" | jq '.queue | map(select(.trigger_type == "issue")) | length // 0')
              CLEANED_WORKFLOW_COUNT=$(echo "$CLEANED_QUEUE_DATA" | jq '.queue | map(select(.trigger_type == "workflow_dispatch")) | length // 0')
              
              echo "Cleaned queue data: $CLEANED_QUEUE_DATA"
              echo "Cleaned counts - Total: $CLEANED_TOTAL_COUNT, Issue: $CLEANED_ISSUE_COUNT, Workflow: $CLEANED_WORKFLOW_COUNT"
              
              # æ„å»ºæ¸…ç†åŸå› æ–‡æœ¬
              CLEANUP_REASON_TEXT=""
              for reason in "${CLEANUP_REASONS[@]}"; do
                CLEANUP_REASON_TEXT="${CLEANUP_REASON_TEXT}â€¢ $reason\n"
              done
              
              # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
              UPDATED_BODY="## æ„å»ºé˜Ÿåˆ—ç®¡ç†\n\n**æœ€åæ›´æ–°æ—¶é—´ï¼š** \$(date '+%Y-%m-%d %H:%M:%S')\n\n### å½“å‰çŠ¶æ€\n- **æ„å»ºé”çŠ¶æ€ï¼š** ç©ºé—² ğŸ”“ (å·²æ¸…ç†)\n- **å½“å‰æ„å»ºï¼š** æ— \n- **é”æŒæœ‰è€…ï¼š** æ— \n- **ç‰ˆæœ¬ï¼š** \$(echo \"$CLEANED_QUEUE_DATA\" | jq -r '.version')\n\n### æ„å»ºé˜Ÿåˆ—\n- **å½“å‰æ•°é‡ï¼š** $CLEANED_TOTAL_COUNT/5\n- **Issueè§¦å‘ï¼š** $CLEANED_ISSUE_COUNT/3\n- **æ‰‹åŠ¨è§¦å‘ï¼š** $CLEANED_WORKFLOW_COUNT/5\n\n---\n\n### æ¸…ç†è®°å½•\n**æ¸…ç†æ—¶é—´ï¼š** \$(date '+%Y-%m-%d %H:%M:%S')\n**æ¸…ç†åŸå› ï¼š**\n$CLEANUP_REASON_TEXT\n### é˜Ÿåˆ—æ•°æ®\n\`\`\`json\n$CLEANED_QUEUE_DATA\n\`\`\`"
              
              # å°è¯•æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
              if update_queue_issue "$QUEUE_MANAGER_ISSUE" "$UPDATED_BODY"; then
                echo "âœ… Queue cleanup successful on attempt $attempt"
                echo "Queue cleanup completed successfully!"
                echo "Cleaned total count: $CLEANED_TOTAL_COUNT"
                echo "Cleaned issue count: $CLEANED_ISSUE_COUNT"
                echo "Cleaned workflow count: $CLEANED_WORKFLOW_COUNT"
                
                # ä¿å­˜æ¸…ç†åçš„æ•°æ®ä¾›åç»­ä½¿ç”¨ï¼ˆä½¿ç”¨jq -cç”Ÿæˆå•è¡ŒJSONï¼‰
                echo "CLEANED_QUEUE_DATA=$(echo "$CLEANED_QUEUE_DATA" | jq -c .)" >> $GITHUB_ENV
                echo "QUEUE_CLEANED=true" >> $GITHUB_ENV
                break
              else
                echo "âŒ Queue cleanup failed on attempt $attempt"
                if [ "$attempt" -lt "$MAX_RETRIES" ]; then
                  echo "Retrying in $RETRY_DELAY seconds..."
                  sleep $RETRY_DELAY
                else
                  echo "Max retries reached, continuing without cleanup..."
                  echo "QUEUE_CLEANED=false" >> $GITHUB_ENV
                  break
                fi
              fi
            else
              echo "No cleanup needed, queue is healthy"
              echo "QUEUE_CLEANED=false" >> $GITHUB_ENV
              break
            fi
          done

      - name: Check queue status
        id: check_queue
        run: |
          # è·å–å½“å‰é˜Ÿåˆ—çŠ¶æ€
          echo "Checking current queue status..."
          
          # åŠ è½½å…±äº«å·¥å…·å‡½æ•°
          source .github/workflows/shared/github-utils.yml
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æ¸…ç†è¿‡é˜Ÿåˆ—
          if [ "${{ env.QUEUE_CLEANED }}" = "true" ]; then
            echo "Using cleaned queue data from previous step"
            QUEUE_DATA='${{ env.CLEANED_QUEUE_DATA }}'
          else
            # è·å–é˜Ÿåˆ—ç®¡ç†issueçš„å†…å®¹
            QUEUE_MANAGER_ISSUE="1"
            QUEUE_MANAGER_CONTENT=$(get_queue_manager_content "$QUEUE_MANAGER_ISSUE")
            QUEUE_DATA=$(extract_queue_json "$QUEUE_MANAGER_CONTENT")
            
            # å¦‚æœæå–å¤±è´¥ï¼Œç›´æ¥é€€å‡º
            if [ -z "$QUEUE_DATA" ]; then
              echo "âŒ Failed to extract queue JSON, aborting."
              exit 1
            fi
            
            # éªŒè¯JSONæ ¼å¼
            if ! echo "$QUEUE_DATA" | jq . > /dev/null 2>&1; then
              echo "âŒ Invalid JSON format in queue data, aborting."
              exit 1
            fi
            
            # å¼ºåˆ¶å•è¡ŒJSON
            QUEUE_DATA=$(echo "$QUEUE_DATA" | jq -c .)
          fi
          
          # éªŒè¯JSONæ ¼å¼
          echo "Validating JSON format..."
          echo "$QUEUE_DATA" | jq . > /dev/null
          echo "JSON validation passed"
          
          # è°ƒè¯•è¾“å‡ºé˜Ÿåˆ—æ•°æ®
          echo "Queue data: $QUEUE_DATA"
          echo "Queue data type: $(echo "$QUEUE_DATA" | jq -r 'type')"
          echo "Queue: $(echo "$QUEUE_DATA" | jq -r '.queue')"
          echo "Current build: $(echo "$QUEUE_DATA" | jq -r '.current_build')"
          echo "Lock holder: $(echo "$QUEUE_DATA" | jq -r '.lock_holder')"
          
          # è·å–å½“å‰é˜Ÿåˆ—æ•°é‡å’Œç±»å‹ç»Ÿè®¡
          TOTAL_QUEUE_COUNT=$(echo "$QUEUE_DATA" | jq '.queue | length // 0')
          ISSUE_QUEUE_COUNT=$(echo "$QUEUE_DATA" | jq '.queue | map(select(.trigger_type == "issue")) | length // 0')
          WORKFLOW_QUEUE_COUNT=$(echo "$QUEUE_DATA" | jq '.queue | map(select(.trigger_type == "workflow_dispatch")) | length // 0')
          CURRENT_BUILD=$(echo "$QUEUE_DATA" | jq -r '.current_build // null')
          LOCK_HOLDER=$(echo "$QUEUE_DATA" | jq -r '.lock_holder // null')
          
          echo "Total queue count: $TOTAL_QUEUE_COUNT/5"
          echo "Issue queue count: $ISSUE_QUEUE_COUNT/3"
          echo "Workflow queue count: $WORKFLOW_QUEUE_COUNT/5"
          echo "Current build: $CURRENT_BUILD"
          echo "Lock holder: $LOCK_HOLDER"
          
          # æ£€æŸ¥æ˜¯å¦å¯ä»¥åŠ å…¥é˜Ÿåˆ—
          QUEUE_FULL=false
          REJECT_REASON=""
          
          # æ ¹æ®è§¦å‘ç±»å‹æ£€æŸ¥é˜Ÿåˆ—é™åˆ¶
          if [ "$TRIGGER_TYPE" = "issue" ]; then
            if [ "$ISSUE_QUEUE_COUNT" -ge 3 ]; then
              QUEUE_FULL=true
              REJECT_REASON="Issueè§¦å‘é˜Ÿåˆ—å·²æ»¡ (å½“å‰: $ISSUE_QUEUE_COUNT/3)"
            fi
          else
            if [ "$TOTAL_QUEUE_COUNT" -ge 5 ]; then
              QUEUE_FULL=true
              REJECT_REASON="æ‰‹åŠ¨è§¦å‘é˜Ÿåˆ—å·²æ»¡ (å½“å‰: $TOTAL_QUEUE_COUNT/5)"
            fi
          fi
          
          if [ "$QUEUE_FULL" = true ]; then
            echo "Queue is full: $REJECT_REASON"
            echo "QUEUE_FULL=true" >> $GITHUB_ENV
            echo "REJECT_REASON=$REJECT_REASON" >> $GITHUB_ENV
            
            # è®¡ç®—é¢„è®¡ç­‰å¾…æ—¶é—´ï¼ˆå‡è®¾æ¯ä¸ªæ„å»ºéœ€è¦30åˆ†é’Ÿï¼‰
            ESTIMATED_WAIT=$((TOTAL_QUEUE_COUNT * 30))
            echo "ESTIMATED_WAIT=$ESTIMATED_WAIT" >> $GITHUB_ENV
          else
            echo "Queue has space"
            echo "QUEUE_FULL=false" >> $GITHUB_ENV
          fi
          
          # ä¿å­˜é˜Ÿåˆ—æ•°æ®ä¾›åç»­ä½¿ç”¨
          echo "QUEUE_DATA=$QUEUE_DATA" >> $GITHUB_ENV
          echo "CURRENT_BUILD=$CURRENT_BUILD" >> $GITHUB_ENV
          echo "LOCK_HOLDER=$LOCK_HOLDER" >> $GITHUB_ENV

      - name: Handle queue full
        if: env.QUEUE_FULL == 'true'
        run: |
          # åŠ è½½å…±äº«å·¥å…·å‡½æ•°
          source .github/workflows/shared/github-utils.yml
          
          # ä»Issue #1å®æ—¶è·å–æœ€æ–°é˜Ÿåˆ—æ•°æ®
          QUEUE_MANAGER_ISSUE="1"
          QUEUE_MANAGER_CONTENT=$(get_queue_manager_content "$QUEUE_MANAGER_ISSUE")
          QUEUE_DATA=$(extract_queue_json "$QUEUE_MANAGER_CONTENT")
          
          # å¦‚æœæå–å¤±è´¥ï¼Œç›´æ¥é€€å‡º
          if [ -z "$QUEUE_DATA" ]; then
            echo "âŒ Failed to extract queue JSON, aborting."
            exit 1
          fi
          
          # éªŒè¯JSONæ ¼å¼
          if ! echo "$QUEUE_DATA" | jq . > /dev/null 2>&1; then
            echo "âŒ Invalid JSON format in queue data, aborting."
            exit 1
          fi
          
          # å¼ºåˆ¶å•è¡ŒJSON
          QUEUE_DATA=$(echo "$QUEUE_DATA" | jq -c .)

          TOTAL_QUEUE_COUNT=$(echo "$QUEUE_DATA" | jq '.queue | length // 0')
          ISSUE_QUEUE_COUNT=$(echo "$QUEUE_DATA" | jq '.queue | map(select(.trigger_type == "issue")) | length // 0')
          WORKFLOW_QUEUE_COUNT=$(echo "$QUEUE_DATA" | jq '.queue | map(select(.trigger_type == "workflow_dispatch")) | length // 0')
          REJECT_REASON='${{ env.REJECT_REASON }}'
          ESTIMATED_WAIT='${{ env.ESTIMATED_WAIT }}'
          
          # é˜Ÿåˆ—æ»¡å‘˜ï¼Œæ‹’ç»è¯·æ±‚
          REJECT_COMMENT="## âŒ é˜Ÿåˆ—å·²æ»¡

          **æ‹’ç»åŸå› ï¼š** $REJECT_REASON
          **å½“å‰é˜Ÿåˆ—çŠ¶æ€ï¼š**
          - æ€»é˜Ÿåˆ—ï¼š$TOTAL_QUEUE_COUNT/5
          - Issueè§¦å‘ï¼š$ISSUE_QUEUE_COUNT/3
          - æ‰‹åŠ¨è§¦å‘ï¼š$WORKFLOW_QUEUE_COUNT/5
          **é¢„è®¡ç­‰å¾…æ—¶é—´ï¼š** çº¦${ESTIMATED_WAIT}åˆ†é’Ÿ

          **å»ºè®®ï¼š**
          - è¯·ç¨åé‡è¯•
          - æˆ–ä½¿ç”¨å…¶ä»–è§¦å‘æ–¹å¼

          **æ—¶é—´ï¼š** $(date '+%Y-%m-%d %H:%M:%S')"
          
          # åªåœ¨issueæ¨¡å¼ä¸‹æ·»åŠ æ‹’ç»è¯„è®º
          if [ "$TRIGGER_TYPE" = "issue" ]; then
            # è·å–åŸå§‹issueç¼–å·
            ORIGINAL_ISSUE_NUMBER=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs" | \
              jq -r '.jobs[0].steps[] | select(.name == "Get review workflow data") | .outputs.trigger_type // empty')
            
            if [ -n "$ORIGINAL_ISSUE_NUMBER" ]; then
              add_issue_comment "$ORIGINAL_ISSUE_NUMBER" "$REJECT_COMMENT"
            fi
          fi
          
          # é€€å‡ºå·¥ä½œæµ
          exit 1

      - name: Join queue
        if: env.QUEUE_FULL == 'false'
        run: |
          # åŠ å…¥é˜Ÿåˆ—
          echo "Joining queue..."
          
          # åŠ è½½å…±äº«å·¥å…·å‡½æ•°
          source .github/workflows/shared/github-utils.yml
          
          # é‡è¯•æœºåˆ¶å‚æ•°
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          # è·å–å½“å‰æ„å»ºä¿¡æ¯
          if [ "$TRIGGER_TYPE" = "issue" ]; then
            CURRENT_BUILD_ID=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs" | \
              jq -r '.jobs[0].steps[] | select(.name == "Get review workflow data") | .outputs.trigger_type // empty')
            CURRENT_BUILD_TITLE="Issue Build"
          else
            CURRENT_BUILD_ID="${{ github.run_id }}"
            CURRENT_BUILD_TITLE="Workflow Dispatch Build"
          fi
          CURRENT_USER="${{ github.actor }}"
          JOIN_TIME=$(date -Iseconds)
          
          # åˆ›å»ºé˜Ÿåˆ—é¡¹
          QUEUE_ITEM=$(jq -n \
            --arg issue_number "$CURRENT_BUILD_ID" \
            --arg issue_title "$CURRENT_BUILD_TITLE" \
            --arg user "$CURRENT_USER" \
            --arg join_time "$JOIN_TIME" \
            --arg trigger_type "$TRIGGER_TYPE" \
            '{
              issue_number: $issue_number,
              issue_title: $issue_title,
              user: $user,
              join_time: $join_time,
              trigger_type: $trigger_type
            }')
          
          echo "Queue item: $QUEUE_ITEM"
          
          # é‡è¯•åŠ å…¥é˜Ÿåˆ—
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt of $MAX_RETRIES to join queue..."
            
            # è·å–å½“å‰é˜Ÿåˆ—æ•°æ®
            QUEUE_MANAGER_ISSUE="1"
            QUEUE_MANAGER_CONTENT=$(get_queue_manager_content "$QUEUE_MANAGER_ISSUE")
            QUEUE_DATA=$(extract_queue_json "$QUEUE_MANAGER_CONTENT")
            
            # è°ƒè¯•è¾“å‡º
            echo "Debug: QUEUE_MANAGER_CONTENT length: $(echo "$QUEUE_MANAGER_CONTENT" | wc -c)"
            echo "Debug: Issue body preview: $(echo "$QUEUE_MANAGER_CONTENT" | jq -r '.body' | head -5)"
            echo "Debug: Extracted QUEUE_DATA: '$QUEUE_DATA'"
            
            # å¦‚æœæå–å¤±è´¥ï¼Œç›´æ¥é€€å‡º
            if [ -z "$QUEUE_DATA" ]; then
              echo "âŒ Failed to extract queue JSON, aborting."
              echo "Debug: Issue body contains:"
              echo "$QUEUE_MANAGER_CONTENT" | jq -r '.body' | head -20
              exit 1
            fi
            
            # éªŒè¯JSONæ ¼å¼
            if ! echo "$QUEUE_DATA" | jq . > /dev/null 2>&1; then
              echo "âŒ Invalid JSON format in queue data, aborting."
              exit 1
            fi
            
            # å¼ºåˆ¶å•è¡ŒJSON
            QUEUE_DATA=$(echo "$QUEUE_DATA" | jq -c .)
            
            # è·å–å½“å‰ç‰ˆæœ¬å·
            CURRENT_VERSION=$(echo "$QUEUE_DATA" | jq -r '.version // 1')
            echo "Current version: $CURRENT_VERSION"
            
            # æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨é˜Ÿåˆ—ä¸­
            EXISTING_ITEM=$(echo "$QUEUE_DATA" | \
              jq -r --arg issue_number "$CURRENT_BUILD_ID" \
              '.queue[] | select(.issue_number == $issue_number) | .issue_number // empty')
            
            if [ -n "$EXISTING_ITEM" ]; then
              echo "âœ… Already in queue, skipping join"
              break
            fi
            
            # æ›´æ–°é˜Ÿåˆ—æ•°æ®
            UPDATED_QUEUE_DATA=$(echo "$QUEUE_DATA" | \
              jq --argjson item "$QUEUE_ITEM" \
              --arg new_version "$((CURRENT_VERSION + 1))" \
              '.queue += [$item] | .version = ($new_version | tonumber)')
            
            echo "Updated queue data: $UPDATED_QUEUE_DATA"
            
            # è®¡ç®—é˜Ÿåˆ—æ•°é‡
            UPDATED_TOTAL_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.queue | length // 0')
            UPDATED_ISSUE_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.queue | map(select(.trigger_type == "issue")) | length // 0')
            UPDATED_WORKFLOW_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.queue | map(select(.trigger_type == "workflow_dispatch")) | length // 0')
            
            echo "Updated counts - Total: $UPDATED_TOTAL_COUNT, Issue: $UPDATED_ISSUE_COUNT, Workflow: $UPDATED_WORKFLOW_COUNT"
            
            # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
            UPDATED_BODY="## æ„å»ºé˜Ÿåˆ—ç®¡ç†\n\n**æœ€åæ›´æ–°æ—¶é—´ï¼š** \$(date '+%Y-%m-%d %H:%M:%S')\n\n### å½“å‰çŠ¶æ€\n- **æ„å»ºé”çŠ¶æ€ï¼š** ç©ºé—² ğŸ”“\n- **å½“å‰æ„å»ºï¼š** æ— \n- **é”æŒæœ‰è€…ï¼š** æ— \n- **ç‰ˆæœ¬ï¼š** $((CURRENT_VERSION + 1))\n\n### æ„å»ºé˜Ÿåˆ—\n- **å½“å‰æ•°é‡ï¼š** $UPDATED_TOTAL_COUNT/5\n- **Issueè§¦å‘ï¼š** $UPDATED_ISSUE_COUNT/3\n- **æ‰‹åŠ¨è§¦å‘ï¼š** $UPDATED_WORKFLOW_COUNT/5\n\n---\n\n### é˜Ÿåˆ—æ•°æ®\n\`\`\`json\n$UPDATED_QUEUE_DATA\n\`\`\`"
            
            # åœ¨å†™å…¥issueå‰ï¼Œå¼ºåˆ¶å•è¡ŒJSON
            UPDATED_QUEUE_DATA=$(echo "$UPDATED_QUEUE_DATA" | jq -c .)
            
            # å°è¯•æ›´æ–°issue
            if update_queue_issue "$QUEUE_MANAGER_ISSUE" "$UPDATED_BODY"; then
              echo "âœ… Queue join successful on attempt $attempt"
              
              # è®¡ç®—é˜Ÿåˆ—ä½ç½®
              QUEUE_POSITION=$(echo "$UPDATED_QUEUE_DATA" | \
                jq -r --arg issue_number "$CURRENT_BUILD_ID" \
                '.queue | sort_by(.join_time) | map(.issue_number) | index($issue_number) // 0 | . + 1')
              
              # æ ¹æ®è§¦å‘ç±»å‹è®¾ç½®é˜Ÿåˆ—é™åˆ¶
              if [ "$TRIGGER_TYPE" = "issue" ]; then
                QUEUE_LIMIT=3
              else
                QUEUE_LIMIT=5
              fi
              echo "QUEUE_POSITION=$QUEUE_POSITION" >> $GITHUB_ENV
              
              # æ·»åŠ é˜Ÿåˆ—åŠ å…¥è¯„è®º
              QUEUE_JOIN_COMMENT="## å·²åŠ å…¥é˜Ÿåˆ—

              **é˜Ÿåˆ—ä½ç½®ï¼š** $QUEUE_POSITION/$QUEUE_LIMIT (æ€»é˜Ÿåˆ—)
              **é¢„è®¡ç­‰å¾…æ—¶é—´ï¼š** çº¦$((UPDATED_TOTAL_COUNT * 30))åˆ†é’Ÿ
              **çŠ¶æ€ï¼š** ç­‰å¾…ä¸­ â³

              **å½“å‰é˜Ÿåˆ—çŠ¶æ€ï¼š**
              - æ€»é˜Ÿåˆ—ï¼š$UPDATED_TOTAL_COUNT/5
              - Issueè§¦å‘ï¼š$UPDATED_ISSUE_COUNT/3
              - æ‰‹åŠ¨è§¦å‘ï¼š$UPDATED_WORKFLOW_COUNT/5

              **é˜Ÿåˆ—ä¿¡æ¯ï¼š**
              - åŠ å…¥æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')
              - è§¦å‘æ–¹å¼ï¼š$TRIGGER_TYPE
              - é˜Ÿåˆ—ç®¡ç†ï¼šIssue #$QUEUE_MANAGER_ISSUE"
              
              # åªåœ¨issueæ¨¡å¼ä¸‹å‘å¸ƒè¯„è®º
              if [ "$TRIGGER_TYPE" = "issue" ]; then
                # è·å–åŸå§‹issueç¼–å·
                ORIGINAL_ISSUE_NUMBER=$(curl -s \
                  -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs" | \
                  jq -r '.jobs[0].steps[] | select(.name == "Get review workflow data") | .outputs.trigger_type // empty')
                
                if [ -n "$ORIGINAL_ISSUE_NUMBER" ]; then
                  add_issue_comment "$ORIGINAL_ISSUE_NUMBER" "$QUEUE_JOIN_COMMENT"
                fi
              fi
              
              break
            else
              echo "âŒ Queue join failed on attempt $attempt"
              if [ "$attempt" -lt "$MAX_RETRIES" ]; then
                echo "Retrying in $RETRY_DELAY seconds..."
                sleep $RETRY_DELAY
              else
                echo "Max retries reached, exiting..."
                exit 1
              fi
            fi
          done 