name: 05 - Queue Wait

on:
  workflow_call:
    inputs:
      build_id:
        description: "Build ID"
        required: true
        type: string
      queue_position:
        description: "Position in queue"
        required: true
        type: string
    outputs:
      lock_acquired:
        description: "Whether lock was acquired"
        value: ${{ jobs.queue_wait.outputs.lock_acquired }}

jobs:
  queue_wait:
    runs-on: ubuntu-latest
    outputs:
      lock_acquired: ${{ steps.wait.outputs.lock_acquired }}
    steps:
      - name: Setup data
        id: setup
        run: |
          # ä½¿ç”¨è¾“å…¥å‚æ•°
          BUILD_ID='${{ inputs.build_id }}'
          QUEUE_POSITION='${{ inputs.queue_position }}'
          
          if [ -z "$BUILD_ID" ]; then
            echo "âŒ No build ID provided"
            exit 1
          fi
          
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "QUEUE_POSITION=$QUEUE_POSITION" >> $GITHUB_ENV
      
      - name: Wait in queue
        id: wait
        env:
          ENCRYPTION_KEY: ${{ vars.ENCRYPTION_KEY }}
        run: |
          # ç­‰å¾…è½®åˆ°è‡ªå·±çš„ä½ç½®å¹¶èŽ·å–æž„å»ºé”
          echo "Waiting in queue and for build lock..."
          
          # åŠ è½½å…±äº«å·¥å…·å‡½æ•°
          source .github/workflows/shared/github-utils.yml
          
          START_TIME=$(date +%s)
          TIMEOUT=21600  # 6å°æ—¶è¶…æ—¶
          
          # èŽ·å–å½“å‰æž„å»ºæ ‡è¯†ç¬¦
          CURRENT_BUILD_ID="${{ env.BUILD_ID }}"
          echo "Current build ID: $CURRENT_BUILD_ID"
          
          # å¦‚æžœåˆšåˆšåŠ å…¥é˜Ÿåˆ—ä¸”ä½ç½®æ˜¯1ï¼Œç›´æŽ¥å¼€å§‹æž„å»º
          if [ "${{ env.QUEUE_POSITION }}" = "1" ]; then
            echo "âœ… Build is at front of queue, proceeding to build..."
            echo "lock_acquired=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # é‡è¯•æœºåˆ¶å‚æ•°
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          # å¦åˆ™ç­‰å¾…å¹¶æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
          while [ $(($(date +%s) - START_TIME)) -lt $TIMEOUT ]; do
            echo "Checking queue position and lock status... ($(($(date +%s) - START_TIME))s elapsed)"
            
            # èŽ·å–é˜Ÿåˆ—æ•°æ®
            QUEUE_MANAGER_ISSUE="1"
            QUEUE_MANAGER_CONTENT=$(get_queue_manager_content "$QUEUE_MANAGER_ISSUE")
            QUEUE_DATA=$(extract_queue_json "$QUEUE_MANAGER_CONTENT")
            
            # å¦‚æžœæå–å¤±è´¥ï¼Œç›´æŽ¥é€€å‡º
            if [ -z "$QUEUE_DATA" ]; then
              echo "âŒ Failed to extract queue JSON, aborting."
              echo "lock_acquired=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            # éªŒè¯JSONæ ¼å¼
            if ! echo "$QUEUE_DATA" | jq . > /dev/null 2>&1; then
              echo "âŒ Invalid JSON format in queue data, aborting."
              echo "lock_acquired=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            # å¼ºåˆ¶å•è¡ŒJSON
            QUEUE_DATA=$(echo "$QUEUE_DATA" | jq -c .)
            
            # æ£€æŸ¥å½“å‰æž„å»ºæ˜¯å¦åœ¨é˜Ÿåˆ—ä¸­
            BUILD_IN_QUEUE=$(echo "$QUEUE_DATA" | \
              jq -r --arg build_id "$CURRENT_BUILD_ID" \
              '.queue | map(.build_id) | contains([$build_id])')
            
            if [ "$BUILD_IN_QUEUE" != "true" ]; then
              echo "âŒ Build not found in queue, exiting..."
              echo "lock_acquired=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯é¦–ä½
            CURRENT_POSITION=$(echo "$QUEUE_DATA" | \
              jq -r --arg build_id "$CURRENT_BUILD_ID" \
              '.queue | sort_by(.join_time) | map(.build_id) | index($build_id) // empty | . + 1')
            
            if [ "$CURRENT_POSITION" = "1" ]; then
              # æ£€æŸ¥é”çŠ¶æ€
              LOCK_RUN_ID=$(echo "$QUEUE_DATA" | jq -r '.run_id // null')
              
              if [ "$LOCK_RUN_ID" = "null" ]; then
                echo "âœ… At front of queue and no lock, attempting to acquire lock..."
                
                # èŽ·å–å½“å‰é˜Ÿåˆ—é¡¹çš„æ•°æ®
                CURRENT_ITEM=$(echo "$QUEUE_DATA" | \
                  jq -r --arg build_id "$CURRENT_BUILD_ID" \
                  '.queue[] | select(.build_id == $build_id)')
                
                if [ -z "$CURRENT_ITEM" ]; then
                  echo "âŒ No item found for current build"
                  echo "lock_acquired=false" >> $GITHUB_OUTPUT
                  exit 1
                fi
                
                # æå–å½“å‰æž„å»ºçš„å…¬å¼€ä¿¡æ¯
                CURRENT_TAG=$(echo "$CURRENT_ITEM" | jq -r '.tag // empty')
                CURRENT_CUSTOMER=$(echo "$CURRENT_ITEM" | jq -r '.customer // empty')
                CURRENT_CUSTOMER_LINK=$(echo "$CURRENT_ITEM" | jq -r '.customer_link // empty')
                CURRENT_SLOGAN=$(echo "$CURRENT_ITEM" | jq -r '.slogan // empty')
                
                echo "ðŸ” Parameters for current build:"
                echo "TAG: $CURRENT_TAG"
                echo "CUSTOMER: $CURRENT_CUSTOMER"
                echo "SLOGAN: $CURRENT_SLOGAN"
                
                # é‡è¯•èŽ·å–é”
                for lock_attempt in $(seq 1 $MAX_RETRIES); do
                  echo "Lock attempt $lock_attempt of $MAX_RETRIES..."
                  
                  # èŽ·å–å½“å‰ç‰ˆæœ¬å·
                  CURRENT_VERSION=$(echo "$QUEUE_DATA" | jq -r '.version // 1')
                  
                  # å°è¯•èŽ·å–é”å¹¶æ›´æ–°é¡¶å±‚ä¿¡æ¯
                  UPDATED_QUEUE_DATA=$(echo "$QUEUE_DATA" | \
                    jq --arg run_id "$CURRENT_BUILD_ID" \
                    --arg new_version "$((CURRENT_VERSION + 1))" \
                    --arg tag "$CURRENT_TAG" \
                    --arg customer "$CURRENT_CUSTOMER" \
                    --arg customer_link "$CURRENT_CUSTOMER_LINK" \
                    --arg slogan "$CURRENT_SLOGAN" \
                    '.run_id = $run_id | .version = ($new_version | tonumber) | .tag = $tag | .customer = $customer | .customer_link = $customer_link | .slogan = $slogan')
                  
                  # è®¡ç®—é˜Ÿåˆ—æ•°é‡
                  UPDATED_TOTAL_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.queue | length // 0')
                  UPDATED_ISSUE_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.queue | map(select(.trigger_type == "issue")) | length // 0')
                  UPDATED_WORKFLOW_COUNT=$(echo "$UPDATED_QUEUE_DATA" | jq '.queue | map(select(.trigger_type == "workflow_dispatch")) | length // 0')
                  
                  # æ›´æ–°é˜Ÿåˆ—ç®¡ç†issue
                  UPDATED_BODY="## æž„å»ºé˜Ÿåˆ—ç®¡ç†\n\n**æœ€åŽæ›´æ–°æ—¶é—´ï¼š** \$(date '+%Y-%m-%d %H:%M:%S')\n\n### å½“å‰çŠ¶æ€\n- **æž„å»ºé”çŠ¶æ€ï¼š** å ç”¨ ðŸ”’ (build_id: $CURRENT_BUILD_ID)\n- **å½“å‰æž„å»ºï¼š** é˜Ÿåˆ—é¦–ä½\n- **é”æŒæœ‰è€…ï¼š** æž„å»ºID: $CURRENT_BUILD_ID\n- **ç‰ˆæœ¬ï¼š** $((CURRENT_VERSION + 1))\n\n### æž„å»ºé˜Ÿåˆ—\n- **å½“å‰æ•°é‡ï¼š** $UPDATED_TOTAL_COUNT/5\n- **Issueè§¦å‘ï¼š** $UPDATED_ISSUE_COUNT/3\n- **æ‰‹åŠ¨è§¦å‘ï¼š** $UPDATED_WORKFLOW_COUNT/5\n\n---\n\n### é˜Ÿåˆ—æ•°æ®\n\`\`\`json\n$UPDATED_QUEUE_DATA\n\`\`\`"
                  
                  if update_queue_issue "$QUEUE_MANAGER_ISSUE" "$UPDATED_BODY"; then
                    echo "âœ… Lock acquired successfully on attempt $lock_attempt"
                    echo "lock_acquired=true" >> $GITHUB_OUTPUT
                    exit 0
                  else
                    echo "âŒ Lock acquisition failed on attempt $lock_attempt"
                    if [ "$lock_attempt" -lt "$MAX_RETRIES" ]; then
                      echo "Retrying lock acquisition in $RETRY_DELAY seconds..."
                      sleep $RETRY_DELAY
                      
                      # é‡æ–°èŽ·å–é˜Ÿåˆ—æ•°æ®
                      QUEUE_MANAGER_CONTENT=$(get_queue_manager_content "$QUEUE_MANAGER_ISSUE")
                      QUEUE_DATA=$(extract_queue_json "$QUEUE_MANAGER_CONTENT")
                      if [ -z "$QUEUE_DATA" ]; then
                        echo "âŒ Failed to extract queue JSON during retry, aborting."
                        echo "lock_acquired=false" >> $GITHUB_OUTPUT
                        exit 1
                      fi
                      
                      # éªŒè¯JSONæ ¼å¼
                      if ! echo "$QUEUE_DATA" | jq . > /dev/null 2>&1; then
                        echo "âŒ Invalid JSON format in queue data during retry, aborting."
                        echo "lock_acquired=false" >> $GITHUB_OUTPUT
                        exit 1
                      fi
                      
                      # å¼ºåˆ¶å•è¡ŒJSON
                      QUEUE_DATA=$(echo "$QUEUE_DATA" | jq -c .)
                    else
                      echo "Max lock retries reached, continuing without lock..."
                      echo "lock_acquired=false" >> $GITHUB_OUTPUT
                      exit 1
                    fi
                  fi
                done
              elif [ "$LOCK_RUN_ID" = "$CURRENT_BUILD_ID" ]; then
                echo "âœ… Already holding lock, proceeding to build..."
                echo "lock_acquired=true" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "Lock held by build_id: $LOCK_RUN_ID, waiting..."
                sleep 30
              fi
            else
              echo "Not at front of queue (position: $CURRENT_POSITION), waiting..."
              sleep 30
            fi
          done
          
          echo "âŒ Timeout reached while waiting for lock"
          echo "lock_acquired=false" >> $GITHUB_OUTPUT
          exit 1 