name: 07 - Finish

on:
  workflow_call:
    inputs:
      project_name:
        description: "Project name that completed build"
        required: true
        type: string
      project_url:
        description: "Project URL"
        required: true
        type: string
      build_status:
        description: "Build status (success/failure)"
        required: true
        type: string
      build_artifacts:
        description: "Build artifacts info"
        required: false
        type: string
        default: ""
      error_message:
        description: "Error message if build failed"
        required: false
        type: string
        default: ""


jobs:
  finish:
    name: Finish Build Process
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup finish environment
        run: |
          echo "Setting up finish environment for ${{ inputs.project_name }}"
          echo "Build status: ${{ inputs.build_status }}"
          echo "Project URL: ${{ inputs.project_url }}"
          
      - name: Process build completion
        run: |
          echo "Processing build completion for ${{ inputs.project_name }}"
          
          if [ "${{ inputs.build_status }}" = "success" ]; then
            echo "âœ… Build completed successfully"
            echo "Build artifacts: ${{ inputs.build_artifacts }}"
          else
            echo "âŒ Build failed"
            echo "Error message: ${{ inputs.error_message }}"
          fi
          
      - name: Update queue status
        uses: ./.github/workflows/shared/github-utils
        with:
          action: update_queue_status
          project_name: ${{ inputs.project_name }}
          status: ${{ inputs.build_status }}

          
      - name: Send completion notification
        run: |
          echo "Sending completion notification for ${{ inputs.project_name }}"
          
          timestamp=$(date '+%Y-%m-%d %H:%M:%S')
          
          if [ "${{ inputs.build_status }}" = "success" ]; then
            echo "## ğŸ‰ æ„å»ºå®Œæˆé€šçŸ¥" > notification.md
            echo "" >> notification.md
            echo "**é¡¹ç›®ï¼š** ${{ inputs.project_name }}" >> notification.md
            echo "**çŠ¶æ€ï¼š** âœ… æˆåŠŸ" >> notification.md
            echo "**å®Œæˆæ—¶é—´ï¼š** $timestamp" >> notification.md
            echo "**é¡¹ç›®é“¾æ¥ï¼š** ${{ inputs.project_url }}" >> notification.md
            echo "" >> notification.md
            echo "### æ„å»ºäº§ç‰©" >> notification.md
            echo "${{ inputs.build_artifacts }}" >> notification.md
            echo "" >> notification.md
            echo "---" >> notification.md
            echo "*æ­¤é€šçŸ¥ç”±æ„å»ºé˜Ÿåˆ—ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*" >> notification.md
          else
            echo "## âŒ æ„å»ºå¤±è´¥é€šçŸ¥" > notification.md
            echo "" >> notification.md
            echo "**é¡¹ç›®ï¼š** ${{ inputs.project_name }}" >> notification.md
            echo "**çŠ¶æ€ï¼š** âŒ å¤±è´¥" >> notification.md
            echo "**å¤±è´¥æ—¶é—´ï¼š** $timestamp" >> notification.md
            echo "**é¡¹ç›®é“¾æ¥ï¼š** ${{ inputs.project_url }}" >> notification.md
            echo "" >> notification.md
            echo "### é”™è¯¯ä¿¡æ¯" >> notification.md
            echo "${{ inputs.error_message }}" >> notification.md
            echo "" >> notification.md
            echo "---" >> notification.md
            echo "*æ­¤é€šçŸ¥ç”±æ„å»ºé˜Ÿåˆ—ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*" >> notification.md
          fi
          
          cat notification.md
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ å‘é€é€šçŸ¥çš„é€»è¾‘
          # ä¾‹å¦‚ï¼šå‘é€åˆ°Slackã€é’‰é’‰ã€é‚®ä»¶ç­‰
          
      - name: Cleanup temporary files
        run: |
          echo "Cleaning up temporary files..."
          rm -rf /tmp/build_*
          rm -rf /tmp/cache_*
          echo "Cleanup completed"
          
      - name: Final status update
        run: |
          echo "Final status update for ${{ inputs.project_name }}"
          echo "Build process finished with status: ${{ inputs.build_status }}"
          echo "Queue has been updated and lock released"
          echo "All cleanup tasks completed" 