name: 99 - Delete Workflow Runs

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'é€‰æ‹©æ“ä½œæ¨¡å¼'
        required: true
        default: 'æ¨¡æ‹Ÿæ¨¡å¼'
        type: choice
        options:
          - æ¨¡æ‹Ÿæ¨¡å¼
          - åˆ é™¤æ¨¡å¼
      max_count:
        description: 'æœ€å¤šåˆ é™¤å¤šå°‘ä¸ªrunsï¼ˆ0è¡¨ç¤ºåˆ é™¤æ‰€æœ‰ï¼‰'
        required: false
        default: 100
        type: number

jobs:
  delete_runs:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Authenticate
        run: |
          if [ -n "${{ secrets.BUILD_TOKEN }}" ]; then
            echo "${{ secrets.BUILD_TOKEN }}" | gh auth login --with-token
          else
            echo "${{ secrets.BUILD_TOKEN }}" | gh auth login --with-token
          fi

      - name: List and Delete Runs
        run: |
          echo "=== è·å–Workflow Runs ==="
          
          # è·å–æ‰€æœ‰å·²å®Œæˆçš„runs
          RUNS_DATA=$(gh api repos/${{ github.repository }}/actions/runs --paginate --jq '.workflow_runs[] | select(.status == "completed") | {id: .id, name: .name, created_at: .created_at}')
          
          if [ -z "$RUNS_DATA" ]; then
            echo "âœ… æ²¡æœ‰æ‰¾åˆ°å·²å®Œæˆçš„workflow runs"
            exit 0
          fi
          
          # é™åˆ¶æ•°é‡
          if [ "${{ github.event.inputs.max_count }}" -gt 0 ]; then
            RUNS_DATA=$(echo "$RUNS_DATA" | head -n ${{ github.event.inputs.max_count }})
          fi
          
          # è®¡ç®—æ€»æ•°
          RUNS_COUNT=$(echo "$RUNS_DATA" | grep -c '^{' || echo "0")
          
          echo "æ‰¾åˆ° $RUNS_COUNT ä¸ªç¬¦åˆæ¡ä»¶çš„workflow runs"
          
          if [ "${{ github.event.inputs.mode }}" = "æ¨¡æ‹Ÿæ¨¡å¼" ]; then
            echo "ğŸ” æ¨¡æ‹Ÿæ¨¡å¼ï¼šå°†é¢„è§ˆåˆ é™¤ $RUNS_COUNT ä¸ªworkflow runs"
            echo "è¦å®é™…åˆ é™¤ï¼Œè¯·é€‰æ‹© 'åˆ é™¤æ¨¡å¼'"
          else
            echo "âš ï¸ åˆ é™¤æ¨¡å¼ï¼šå°†åˆ é™¤ $RUNS_COUNT ä¸ªworkflow runs"
            
            DELETED=0
            FAILED=0
            
            echo "$RUNS_DATA" | jq -c '.' | while read -r run; do
              RUN_ID=$(echo "$run" | jq -r '.id')
              RUN_NAME=$(echo "$run" | jq -r '.name')
              
              echo "æ­£åœ¨åˆ é™¤ Workflow Run #$RUN_ID ($RUN_NAME)..."
              
              if gh api repos/${{ github.repository }}/actions/runs/$RUN_ID -X DELETE; then
                echo "âœ… åˆ é™¤ Workflow Run #$RUN_ID æˆåŠŸ"
                DELETED=$((DELETED + 1))
              else
                echo "âŒ åˆ é™¤ Workflow Run #$RUN_ID å¤±è´¥"
                FAILED=$((FAILED + 1))
              fi
              
              sleep 1
            done
            
            echo "åˆ é™¤å®Œæˆï¼šæˆåŠŸ $DELETED ä¸ªï¼Œå¤±è´¥ $FAILED ä¸ª"
          fi
          
          # æ˜¾ç¤ºå‰©ä½™runsæ•°é‡
          REMAINING=$(gh api repos/${{ github.repository }}/actions/runs --jq '.total_count')
          echo "å‰©ä½™workflow runsæ€»æ•°ï¼š$REMAINING" 