# GitHub Actions è„šæœ¬é‡æ„æ€»ç»“

## é‡æ„ç›®æ ‡

å°† GitHub Actions YAML æ–‡ä»¶ä¸­çš„å¤æ‚ markdown æ‹¼æ¥é€»è¾‘é‡æ„ä¸ºç‹¬ç«‹çš„ shell è„šæœ¬å‡½æ•°ï¼Œè§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

1. **YAML ç¼©è¿›é—®é¢˜**ï¼šYAML ä¸­çš„å¤šè¡Œå­—ç¬¦ä¸²ä¼šè‡ªåŠ¨ç¼©è¿›ï¼Œå¯¼è‡´ markdown æ¸²æŸ“ä¸ºä»£ç å—
2. **ä»£ç ç»´æŠ¤æ€§**ï¼šå°†é‡å¤çš„ markdown æ‹¼æ¥é€»è¾‘é›†ä¸­ç®¡ç†
3. **å¯è¯»æ€§**ï¼šYAML æ–‡ä»¶æ›´ç®€æ´ï¼Œé€»è¾‘æ›´æ¸…æ™°

## é‡æ„å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆçš„å·¥ä½œ

#### 1. åˆå¹¶è„šæœ¬åˆ° `github-utils.sh`

- å°† `markdown-templates.sh` å’Œ `queue-operations.sh` çš„å†…å®¹åˆå¹¶åˆ°ç°æœ‰çš„ `.github/workflows/shared/github-utils.sh` ä¸­
- ä¿æŒäº†æ‰€æœ‰å·¥å…·å‡½æ•°åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­çš„ç»Ÿä¸€æ€§

#### 2. æ–°å¢ Markdown æ¨¡æ¿å‡½æ•°

åœ¨ `github-utils.sh` ä¸­æ–°å¢äº†ä»¥ä¸‹å‡½æ•°ï¼š

- `generate_queue_management_body()` - ç”Ÿæˆé˜Ÿåˆ—ç®¡ç† issue æ­£æ–‡
- `generate_reject_comment()` - ç”Ÿæˆæ„å»ºè¢«æ‹’ç»è¯„è®º
- `generate_success_comment()` - ç”Ÿæˆæ„å»ºå·²åŠ å…¥é˜Ÿåˆ—è¯„è®º
- `generate_cleanup_reasons()` - ç”Ÿæˆé˜Ÿåˆ—æ¸…ç†åŸå› æ–‡æœ¬
- `generate_build_complete_comment()` - ç”Ÿæˆæ„å»ºå®Œæˆè¯„è®º
- `generate_build_failed_comment()` - ç”Ÿæˆæ„å»ºå¤±è´¥è¯„è®º
- `generate_queue_reset_notification()` - ç”Ÿæˆé˜Ÿåˆ—é‡ç½®é€šçŸ¥
- `generate_lock_timeout_notification()` - ç”Ÿæˆé”è¶…æ—¶é€šçŸ¥
- `generate_queue_status_update()` - ç”Ÿæˆé˜Ÿåˆ—çŠ¶æ€æ›´æ–°é€šçŸ¥

#### 3. æ–°å¢é˜Ÿåˆ—æ“ä½œå‡½æ•°

- `join_queue()` - åŠ å…¥é˜Ÿåˆ—æ“ä½œï¼ˆåŒ…å«è‡ªåŠ¨æ¸…ç†ã€é˜Ÿåˆ—æ£€æŸ¥ã€åŠ å¯†ç­‰ï¼‰
- `update_queue_issue_body()` - æ›´æ–°é˜Ÿåˆ—ç®¡ç† issue æ­£æ–‡
- `perform_queue_cleanup()` - æ‰§è¡Œé˜Ÿåˆ—æ¸…ç†
- `wait_for_queue_turn()` - ç­‰å¾…é˜Ÿåˆ—è½®åˆ°æ„å»º

#### 4. é‡æ„ YAML æ–‡ä»¶

å·²é‡æ„ `.github/workflows/03-queue-join.yml`ï¼š

**é‡æ„å‰ï¼š**
```yaml
- name: Join queue with auto cleanup and wait
  run: |
    # 500+ è¡Œçš„å¤æ‚ shell è„šæœ¬
    # åŒ…å«å¤§é‡ markdown æ‹¼æ¥é€»è¾‘
    UPDATED_BODY="## æ„å»ºé˜Ÿåˆ—ç®¡ç†
    ...
    "
```

**é‡æ„åï¼š**
```yaml
- name: Join queue with auto cleanup and wait
  run: |
    # åŠ è½½å…±äº«å·¥å…·å‡½æ•°
    source .github/workflows/scripts/github-utils.sh
    
    # ä½¿ç”¨æ–°çš„é˜Ÿåˆ—æ“ä½œå‡½æ•°
    if join_queue "${{ env.BUILD_ID }}" "${{ env.TRIGGER_TYPE }}" "${{ env.CURRENT_DATA }}" "${{ env.QUEUE_LIMIT }}"; then
      # ç­‰å¾…é˜Ÿåˆ—è½®åˆ°æ„å»º
      if wait_for_queue_turn "${{ env.BUILD_ID }}" "1"; then
        echo "âœ… Queue wait completed successfully"
      fi
    fi
```

### ğŸ”§ æŠ€æœ¯æ”¹è¿›

#### 1. Markdown æ¸²æŸ“ä¼˜åŒ–

- **é¡¶æ ¼å†™**ï¼šæ‰€æœ‰ markdown è¯­æ³•ï¼ˆæ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ï¼‰éƒ½é¡¶æ ¼å†™ï¼Œé¿å… YAML ç¼©è¿›æ±¡æŸ“
- **çœŸå®æ¢è¡Œ**ï¼šä½¿ç”¨ `cat <<EOF ... EOF` ç¡®ä¿çœŸå®çš„å¤šè¡Œå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ `\n` è½¬ä¹‰
- **JSON å•è¡ŒåŒ–**ï¼šä½¿ç”¨ `jq -c .` ç¡®ä¿æ’å…¥ markdown ä»£ç å—çš„ JSON æ˜¯å•è¡Œæ ¼å¼

#### 2. å‡½æ•°æ¨¡å—åŒ–

- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªå‡½æ•°åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šçš„åŠŸèƒ½
- **å‚æ•°åŒ–**ï¼šæ‰€æœ‰å‡½æ•°éƒ½æ¥å—æ˜ç¡®çš„å‚æ•°ï¼Œé¿å…å…¨å±€å˜é‡ä¾èµ–
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œè¿”å›å€¼

#### 3. ä»£ç å¤ç”¨

- **æ¨¡æ¿åŒ–**ï¼šmarkdown å†…å®¹æ¨¡æ¿åŒ–ï¼Œæ˜“äºç»´æŠ¤å’Œä¿®æ”¹
- **å‡½æ•°è°ƒç”¨**ï¼šYAML ä¸­åªéœ€è°ƒç”¨å‡½æ•°ï¼Œé€»è¾‘é›†ä¸­åœ¨è„šæœ¬ä¸­

### ğŸ“‹ å¾…å®Œæˆçš„å·¥ä½œ

#### 1. å…¶ä»– YAML æ–‡ä»¶é‡æ„

éœ€è¦é‡æ„ä»¥ä¸‹æ–‡ä»¶ä¸­çš„ markdown æ‹¼æ¥é€»è¾‘ï¼š

- `.github/workflows/02-review.yml`
- `.github/workflows/04-build.yml`
- `.github/workflows/05-finish.yml`
- `CustomBuildRustdesk.yml`

#### 2. æµ‹è¯•éªŒè¯

- åœ¨ GitHub Actions ç¯å¢ƒä¸­æµ‹è¯•é‡æ„åçš„å‡½æ•°
- éªŒè¯ markdown æ¸²æŸ“æ˜¯å¦æ­£å¸¸
- ç¡®è®¤é˜Ÿåˆ—æ“ä½œåŠŸèƒ½æ­£å¸¸

### ğŸ¯ é‡æ„æ•ˆæœ

#### 1. ä»£ç è´¨é‡æå‡

- **å¯ç»´æŠ¤æ€§**ï¼šmarkdown æ¨¡æ¿é›†ä¸­ç®¡ç†ï¼Œä¿®æ”¹æ›´æ–¹ä¾¿
- **å¯è¯»æ€§**ï¼šYAML æ–‡ä»¶æ›´ç®€æ´ï¼Œé€»è¾‘æ›´æ¸…æ™°
- **å¯æµ‹è¯•æ€§**ï¼šå‡½æ•°å¯ä»¥ç‹¬ç«‹æµ‹è¯•

#### 2. é—®é¢˜è§£å†³

- **ç¼©è¿›é—®é¢˜**ï¼šmarkdown ä¸å†å— YAML ç¼©è¿›å½±å“
- **æ¸²æŸ“é—®é¢˜**ï¼šæ‰€æœ‰ markdown è¯­æ³•éƒ½èƒ½æ­£ç¡®æ¸²æŸ“
- **JSON æå–**ï¼šJSON æ•°æ®æ ¼å¼ç»Ÿä¸€ï¼Œæå–æ›´å¯é 

#### 3. æ‰©å±•æ€§

- **æ–°æ¨¡æ¿**ï¼šæ·»åŠ æ–°çš„ markdown æ¨¡æ¿åªéœ€åœ¨è„šæœ¬ä¸­æ·»åŠ å‡½æ•°
- **æ–°åŠŸèƒ½**ï¼šé˜Ÿåˆ—æ“ä½œé€»è¾‘å¯ä»¥è½»æ¾æ‰©å±•
- **å¤ç”¨æ€§**ï¼šå‡½æ•°å¯ä»¥åœ¨å¤šä¸ªå·¥ä½œæµä¸­å¤ç”¨

### ğŸ“ ä½¿ç”¨ç¤ºä¾‹

#### åœ¨ YAML ä¸­ä½¿ç”¨æ–°å‡½æ•°

```yaml
- name: Update queue issue
  run: |
    source .github/workflows/scripts/github-utils.sh
    
    # æ›´æ–°é˜Ÿåˆ—ç®¡ç† issue
    update_queue_issue_body "1" "$QUEUE_DATA" "$VERSION"
    
    # ç”Ÿæˆå¹¶æ·»åŠ è¯„è®º
    COMMENT=$(generate_success_comment "$POSITION" "$LIMIT" "$BUILD_ID" "$TAG" "$CUSTOMER" "$SLOGAN" "$TIME")
    add_issue_comment_if_issue_trigger "$TRIGGER_TYPE" "$BUILD_ID" "$COMMENT"
```

#### ç›´æ¥è°ƒç”¨å‡½æ•°

```bash
# ç”Ÿæˆé˜Ÿåˆ—ç®¡ç†æ­£æ–‡
BODY=$(generate_queue_management_body "$TIME" "$QUEUE_DATA" "$LOCK_STATUS" "$BUILD" "$HOLDER" "$VERSION")

# ç”Ÿæˆæ‹’ç»è¯„è®º
REJECT_COMMENT=$(generate_reject_comment "$REASON" "$LENGTH" "$LIMIT" "$INFO" "$TIME")
```

### ğŸ”„ è¿ç§»æŒ‡å—

å¦‚éœ€å°†å…¶ä»– YAML æ–‡ä»¶ä¸­çš„ markdown æ‹¼æ¥é€»è¾‘è¿ç§»åˆ°æ–°å‡½æ•°ï¼š

1. **è¯†åˆ«æ‹¼æ¥ç‚¹**ï¼šæ‰¾åˆ°æ‰€æœ‰ `UPDATED_BODY=`ã€`REJECT_COMMENT=` ç­‰å˜é‡èµ‹å€¼
2. **é€‰æ‹©å‡½æ•°**ï¼šæ ¹æ®å†…å®¹ç±»å‹é€‰æ‹©åˆé€‚çš„æ¨¡æ¿å‡½æ•°
3. **æ›¿æ¢é€»è¾‘**ï¼šå°†æ‹¼æ¥é€»è¾‘æ›¿æ¢ä¸ºå‡½æ•°è°ƒç”¨
4. **æµ‹è¯•éªŒè¯**ï¼šç¡®ä¿åŠŸèƒ½æ­£å¸¸ï¼Œmarkdown æ¸²æŸ“æ­£ç¡®

### ğŸ“Š æ€»ç»“

æœ¬æ¬¡é‡æ„æˆåŠŸè§£å†³äº† YAML ä¸­ markdown æ‹¼æ¥çš„ç¼©è¿›å’Œæ¸²æŸ“é—®é¢˜ï¼Œå°†å¤æ‚çš„é€»è¾‘æ¨¡å—åŒ–ä¸ºå¯å¤ç”¨çš„å‡½æ•°ï¼Œå¤§å¤§æå‡äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ã€‚é‡æ„åçš„ä»£ç ç»“æ„æ›´æ¸…æ™°ï¼ŒåŠŸèƒ½æ›´ç¨³å®šï¼Œä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å’Œç»´æŠ¤å¥ å®šäº†è‰¯å¥½çš„åŸºç¡€ã€‚ 